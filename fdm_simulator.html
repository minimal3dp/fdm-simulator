<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDM 3D Print Property Simulator (v5)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load three.js for 3D viewer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        .simulator-card {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #d1d5db;
            /* gray-300 */
        }

        .slider-value {
            font-weight: 600;
            color: #f9fafb;
            /* gray-50 */
        }

        /* Custom slider track */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #374151;
            /* gray-700 */
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #f9fafb;
            /* gray-50 */
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #f9fafb;
            /* gray-50 */
        }

        .output-card {
            background-color: #1f2937;
            /* gray-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output-label {
            font-size: 0.875rem;
            color: #9ca3af;
            /* gray-400 */
        }

        .output-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
            /* blue-500 */
        }

        /* Tab styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .tab-btn.active {
            background-color: #3b82f6;
            color: white;
        }

        .tab-btn:not(.active) {
            color: #9ca3af;
            background-color: #374151;
            /* gray-700 */
        }

        .tab-btn:not(.active):hover {
            background-color: #4b5563;
            /* gray-600 */
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #stlCanvas {
            width: 100%;
            height: 400px;
            border-radius: 0.5rem;
            background-color: #1f2937;
            /* gray-800 */
        }

        .fea-table-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1f2937;
            /* gray-800 */
            border-radius: 0.5rem;
        }

        .fea-table th {
            position: sticky;
            top: 0;
            background-color: #374151;
            /* gray-700 */
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.25;
            border: 1px solid #374151;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>

<body class="h-full text-gray-100 p-4 md:p-8 bg-gray-900">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-white">FDM 3D Print Property Simulator (v5)</h1>
            <p class="text-lg text-gray-400">Simulate and Optimize Mechanical Properties, Cost, Time, and Accuracy.</p>
        </header>

        <!-- v4: Main App Tabs -->
        <div class="mb-6">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-simulator" class="tab-btn active">Simulator</button>
                <button id="tab-optimizer" class="tab-btn">Optimizer</button>
            </nav>
        </div>

        <!-- v3: Global Print Settings Card -->
        <div class="simulator-card mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">Global Print Settings</h2>
            <p class="text-gray-400 text-sm mb-4">These values are used by all models for cost and time estimation.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="relative group">
                    <label for="global_part_mass_g" class="block text-sm font-medium text-gray-300 mb-2">Filament Used
                        (g)</label>
                    <span
                        class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                        Enter the total filament weight (in grams) as reported by your slicer.
                    </span>
                    <input type="number" id="global_part_mass_g" value="50"
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                </div>
                <div class="relative group">
                    <label for="global_filament_cost_kg" class="block text-sm font-medium text-gray-300 mb-2">Filament
                        Cost ($/kg)</label>
                    <span
                        class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                        Enter the price you paid for a 1kg (1000g) spool of this filament.
                    </span>
                    <input type="number" id="global_filament_cost_kg" value="25"
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- ===== v4: SIMULATOR TAB ======== -->
        <!-- ================================== -->
        <div id="content-simulator" class="tab-content active">
            <!-- Model Selector -->
            <div class="mb-6">
                <label for="modelSelector" class="block text-sm font-medium text-gray-300 mb-2">Select Simulation
                    Model</label>
                <select id="modelSelector"
                    class="w-full max-w-md bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="kaggle" selected>Kaggle Model (Strength, Roughness, Elongation)</option>
                    <option value="c3">C3 Model (Tensile Strength & Elongation)</option>
                    <option value="fea">FEA Material Card (Anisotropic Properties)</option>
                    <option value="fatigue">Fatigue Lifetime Model (Cycles to Failure)</option>
                    <option value="accuracy">Dimensional Accuracy (v5)</option>
                </select>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Column 1: G-Code Parser & Parameters -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- G-Code Parser (Kaggle & C3 Only) -->
                    <div id="gcode-parser-container" class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">G-Code Parser</h2>
                        <p class="text-gray-400 text-sm mb-4">Upload an OrcaSlicer `.gcode` file to automatically
                            populate parameters for the selected model.</p>
                        <input type="file" id="gcodeFile" accept=".gcode" class="block w-full text-sm text-gray-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-600 file:text-white
                            hover:file:bg-blue-700 file:cursor-pointer
                        " />
                        <button id="parseGcodeBtn"
                            class="mt-4 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                            Parse G-Code
                        </button>
                    </div>

                    <!-- Parameters Card -->
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Process Parameters</h2>

                        <!-- Kaggle Model Parameters -->
                        <div id="kaggle-params" class="model-params space-y-4">
                            <div class="relative group">
                                <label for="kaggle_material_database"
                                    class="block text-sm font-medium text-gray-300 mb-2">Material Datasheet</label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Select a material to auto-fill common print settings.
                                </span>
                                <select id="kaggle_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Options populated by JS -->
                                </select>
                                <input type="hidden" id="material" value="pla">
                            </div>
                            <hr class="border-gray-700" />

                            <div class="relative group">
                                <label for="layer_height" class="slider-label"><span>Layer Height (mm)</span><span
                                        id="layer_height_val" class="slider-value">0.1</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Thickness of each individual printed layer. Smaller is higher quality but slower.
                                </span>
                                <input type="range" id="layer_height" min="0.02" max="0.3" step="0.01" value="0.1"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="wall_thickness" class="slider-label"><span>Wall Thickness
                                        (layers)</span><span id="wall_thickness_val"
                                        class="slider-value">4</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Number of outer shells (perimeters). More walls = stronger part.
                                </span>
                                <input type="range" id="wall_thickness" min="1" max="10" step="1" value="4"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="infill_density" class="slider-label"><span>Infill Density (%)</span><span
                                        id="infill_density_val" class="slider-value">50</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Percentage of material used for the internal support structure. Higher = stronger
                                    and heavier.
                                </span>
                                <input type="range" id="infill_density" min="10" max="100" step="1" value="50"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="nozzle_temperature" class="slider-label"><span>Nozzle Temp (°C)</span><span
                                        id="nozzle_temperature_val" class="slider-value">220</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Temperature of the extruder. Critical for layer adhesion and strength.
                                </span>
                                <input type="range" id="nozzle_temperature" min="200" max="250" step="1" value="220"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="bed_temperature" class="slider-label"><span>Bed Temp (°C)</span><span
                                        id="bed_temperature_val" class="slider-value">60</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Temperature of the print surface. Prevents warping and helps with first-layer
                                    adhesion.
                                </span>
                                <input type="range" id="bed_temperature" min="50" max="100" step="1" value="60"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="print_speed" class="slider-label"><span>Print Speed (mm/s)</span><span
                                        id="print_speed_val" class="slider-value">60</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Speed of the print head (mm/s). Slower is generally stronger and more accurate.
                                </span>
                                <input type="range" id="print_speed" min="40" max="120" step="1" value="60"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fan_speed" class="slider-label"><span>Fan Speed (%)</span><span
                                        id="fan_speed_val" class="slider-value">50</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Cooling fan speed. Higher speed cools the plastic faster, improving overhangs but
                                    can reduce layer bonding.
                                </span>
                                <input type="range" id="fan_speed" min="0" max="100" step="1" value="50" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="infill_pattern" class="block text-sm font-medium text-gray-300 mb-2">Infill
                                    Pattern</label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Geometric shape of the internal infill (e.g., Grid, Honeycomb).
                                </span>
                                <select id="infill_pattern"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="grid">Grid</option>
                                    <option value="honeycomb">Honeycomb</option>
                                </select>
                            </div>
                        </div>

                        <!-- C3 Model Parameters -->
                        <div id="c3-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="c3_Temperature" class="slider-label"><span>Nozzle Temp (°C)</span><span
                                        id="c3_Temperature_val" class="slider-value">205</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Temperature of the extruder. Critical for layer adhesion and strength.
                                </span>
                                <input type="range" id="c3_Temperature" min="190" max="220" step="1" value="205"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="c3_Speed" class="slider-label"><span>Print Speed (mm/s)</span><span
                                        id="c3_Speed_val" class="slider-value">70</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Speed of the print head (mm/s). Slower is generally stronger.
                                </span>
                                <input type="range" id="c3_Speed" min="40" max="100" step="1" value="70" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="c3_Angle" class="slider-label"><span>Raster Angle (°)</span><span
                                        id="c3_Angle_val" class="slider-value">45</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Raster angle (e.g., 0°, 45°, 90°). The direction lines are printed relative to the
                                    part's X/Y axes.
                                </span>
                                <input type="range" id="c3_Angle" min="0" max="90" step="15" value="45" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="c3_Height" class="slider-label"><span>Layer Height (mm)</span><span
                                        id="c3_Height_val" class="slider-value">0.15</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Thickness of each individual printed layer. Smaller is higher quality but slower.
                                </span>
                                <input type="range" id="c3_Height" min="0.1" max="0.2" step="0.01" value="0.15"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="c3_Fill" class="slider-label"><span>Infill Density (%)</span><span
                                        id="c3_Fill_val" class="slider-value">85</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Percentage of material used for the internal support structure. Higher = stronger.
                                </span>
                                <input type="range" id="c3_Fill" min="70" max="100" step="1" value="85" class="w-full">
                            </div>
                        </div>

                        <!-- FEA Model Parameters -->
                        <div id="fea-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="fea_material_database"
                                    class="block text-sm font-medium text-gray-300 mb-2">Material Datasheet</label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Select a material to auto-fill its core FEA properties.
                                </span>
                                <select id="fea_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <hr class="border-gray-700" />
                            <h3 class="text-lg font-semibold text-blue-300">Filament Datasheet Properties</h3>
                            <div class="relative group">
                                <label for="fea_Material_Bonding_Perfection" class="slider-label"><span>Bonding
                                        Perfection</span><span id="fea_Material_Bonding_Perfection_val"
                                        class="slider-value">0.5</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    A factor (0.1-1.0) representing how well layers bond. 1.0 is a perfect bond (like
                                    injection molding).
                                </span>
                                <input type="range" id="fea_Material_Bonding_Perfection" min="0.1" max="1.0" step="0.01"
                                    value="0.5" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fea_Material_Youngs_Modulus_GPa" class="slider-label"><span>Young's Modulus
                                        (GPa)</span><span id="fea_Material_Youngs_Modulus_GPa_val"
                                        class="slider-value">2.5</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Material stiffness. Find this value on your filament's Technical Data Sheet (TDS).
                                </span>
                                <input type="range" id="fea_Material_Youngs_Modulus_GPa" min="1.0" max="5.0" step="0.1"
                                    value="2.5" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fea_Material_Tensile_Yield_Strenght_MPa" class="slider-label"><span>Tensile
                                        Strength (MPa)</span><span id="fea_Material_Tensile_Yield_Strenght_MPa_val"
                                        class="slider-value">50</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Maximum stress the *raw filament* can take. Find this on your filament's TDS.
                                </span>
                                <input type="range" id="fea_Material_Tensile_Yield_Strenght_MPa" min="20" max="80"
                                    step="1" value="50" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fea_Material_Poissons_Ratio" class="slider-label"><span>Poisson's
                                        Ratio</span><span id="fea_Material_Poissons_Ratio_val"
                                        class="slider-value">0.35</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Material's tendency to shrink/expand sideways when stretched/compressed. Find this
                                    on your filament's TDS.
                                </span>
                                <input type="range" id="fea_Material_Poissons_Ratio" min="0.1" max="0.5" step="0.01"
                                    value="0.35" class="w-full">
                            </div>

                            <h3 class="text-lg font-semibold text-blue-300 mt-4">Slicer Settings</h3>
                            <div class="relative group">
                                <label for="fea_User_Infill_Density" class="slider-label"><span>Infill
                                        Density</span><span id="fea_User_Infill_Density_val"
                                        class="slider-value">0.5</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Infill percentage (as a decimal, 0.1-1.0) for the part you are simulating.
                                </span>
                                <input type="range" id="fea_User_Infill_Density" min="0.1" max="1.0" step="0.01"
                                    value="0.5" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fea_User_Line_Thickenss_mm" class="slider-label"><span>Line Thickness
                                        (mm)</span><span id="fea_User_Line_Thickenss_mm_val"
                                        class="slider-value">0.4</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Width of a single extruded line (e.g., 0.4mm for a 0.4mm nozzle).
                                </span>
                                <input type="range" id="fea_User_Line_Thickenss_mm" min="0.2" max="0.8" step="0.01"
                                    value="0.4" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fea_User_Layer_Height_mm" class="slider-label"><span>Layer Height
                                        (mm)</span><span id="fea_User_Layer_Height_mm_val"
                                        class="slider-value">0.2</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Thickness of each individual printed layer for the part you are simulating.
                                </span>
                                <input type="range" id="fea_User_Layer_Height_mm" min="0.1" max="0.4" step="0.01"
                                    value="0.2" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fea_User_Infill_Pattern"
                                    class="block text-sm font-medium text-gray-300 mb-2">Infill Pattern</label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Geometric shape of the internal infill. This model supports Rectilinear and
                                    Concentric.
                                </span>
                                <select id="fea_User_Infill_Pattern"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="Rectilinear">Rectilinear</option>
                                    <option value="concentric">Concentric</option>
                                </select>
                            </div>
                        </div>

                        <!-- Fatigue Model Parameters -->
                        <div id="fatigue-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="fatigue_material_database"
                                    class="block text-sm font-medium text-gray-300 mb-2">Material Datasheet</label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Select a material to auto-fill its recommended print settings for fatigue.
                                </span>
                                <select id="fatigue_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <hr class="border-gray-700" />
                            <h3 class="text-lg font-semibold text-blue-300">Part Load</h3>
                            <div class="relative group">
                                <label for="fatigue_Stress_Level" class="slider-label"><span>Applied Stress Level
                                        (MPa)</span><span id="fatigue_Stress_Level_val"
                                        class="slider-value">10</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    The real-world cyclical load (in MegaPascals) you expect the part to endure. This is
                                    *not* a slicer setting. Estimate this based on your part's use case.
                                </span>
                                <input type="range" id="fatigue_Stress_Level" min="2.5" max="15" step="0.1" value="10"
                                    class="w-full">
                            </div>
                            <h3 class="text-lg font-semibold text-blue-300 mt-4">Slicer Settings</h3>
                            <div class="relative group">
                                <label for="fatigue_Nozzle_Diameter" class="slider-label"><span>Nozzle Diameter
                                        (mm)</span><span id="fatigue_Nozzle_Diameter_val"
                                        class="slider-value">0.4</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    The diameter of the nozzle used to print the part (e.g., 0.4mm, 0.6mm).
                                </span>
                                <input type="range" id="fatigue_Nozzle_Diameter" min="0.2" max="0.6" step="0.1"
                                    value="0.4" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fatigue_Print_Speed" class="slider-label"><span>Print Speed
                                        (mm/s)</span><span id="fatigue_Print_Speed_val"
                                        class="slider-value">10</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Speed of the print head (mm/s). Slower is generally stronger and more durable.
                                </span>
                                <input type="range" id="fatigue_Print_Speed" min="5" max="15" step="1" value="10"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="fatigue_Nozzle_Temperature" class="slider-label"><span>Nozzle Temp
                                        (°C)</span><span id="fatigue_Nozzle_Temperature_val"
                                        class="slider-value">210</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Temperature of the extruder. Critical for layer adhesion and fatigue life.
                                </span>
                                <input type="range" id="fatigue_Nozzle_Temperature" min="180" max="240" step="1"
                                    value="210" class="w-full">
                            </div>
                        </div>

                        <!-- v5: Accuracy Model Parameters -->
                        <div id="accuracy-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="acc_Layer_Thickness_mm" class="slider-label"><span>Layer Thickness
                                        (mm)</span><span id="acc_Layer_Thickness_mm_val"
                                        class="slider-value">0.2</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Thickness of each individual printed layer.
                                </span>
                                <input type="range" id="acc_Layer_Thickness_mm" min="0.1" max="0.4" step="0.01"
                                    value="0.2" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="acc_Build_Orientation_deg" class="slider-label"><span>Build Orientation
                                        (°)</span><span id="acc_Build_Orientation_deg_val"
                                        class="slider-value">45</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    The angle of the part on the build plate relative to the X-axis (0-90°).
                                </span>
                                <input type="range" id="acc_Build_Orientation_deg" min="0" max="90" step="15" value="45"
                                    class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="acc_Infill_Density_percent" class="slider-label"><span>Infill Density
                                        (%)</span><span id="acc_Infill_Density_percent_val"
                                        class="slider-value">90</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Percentage of material used for the internal support structure.
                                </span>
                                <input type="range" id="acc_Infill_Density_percent" min="80" max="100" step="1"
                                    value="90" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="acc_Number_of_Contours" class="slider-label"><span>Number of
                                        Contours</span><span id="acc_Number_of_Contours_val"
                                        class="slider-value">2</span></label>
                                <span
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Number of outer shells/walls (perimeters).
                                </span>
                                <input type="range" id="acc_Number_of_Contours" min="1" max="3" step="1" value="2"
                                    class="w-full">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column 2: Predicted Properties -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- Predicted Properties Card -->
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Predicted Properties</h2>
                        <div id="spinner" class="hidden text-center text-gray-400">
                            <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p>Simulating...</p>
                        </div>
                        <div id="error-message"
                            class="hidden text-center text-red-400 p-3 bg-red-900 bg-opacity-30 rounded-lg">
                            <p class="font-bold">Simulation Failed</p>
                            <p id="error-text" class="text-sm">Error details here.</p>
                        </div>

                        <!-- v3: Global Outputs (Cost & Time) -->
                        <div class="space-y-3 mb-4 p-4 bg-gray-800 rounded-lg">
                            <div class="output-card bg-gray-700">
                                <div>
                                    <div class="output-label">Estimated Cost</div>
                                    <div id="estimated_cost_usd" class="output-value text-green-400">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">USD</div>
                            </div>
                            <div class="output-card bg-gray-700">
                                <div>
                                    <div class="output-label">Estimated Print Time</div>
                                    <div id="estimated_print_time_min" class="output-value text-yellow-400">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">min</div>
                            </div>
                        </div>
                        <hr class="border-gray-700 mb-4" />

                        <!-- Kaggle Model Outputs -->
                        <div id="kaggle-outputs" class="model-outputs space-y-3">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Tensile Strength</div>
                                    <div id="tensile_strength" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">MPa</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Roughness</div>
                                    <div id="roughness" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">µm</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Elongation</div>
                                    <div id="elongation" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>

                        <!-- C3 Model Outputs -->
                        <div id="c3-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Tensile Strength</div>
                                    <div id="c3_tensile_strength" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">MPa</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Elongation at Break</div>
                                    <div id="c3_elongation" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>

                        <!-- FEA Model Outputs -->
                        <div id="fea-outputs" class="model-outputs space-y-4 hidden">
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Upload Part Geometry</h3>
                                    <p class="text-gray-400 text-sm mb-4">Upload an STL file to visualize your part.</p>
                                    <input type="file" id="stlFile" accept=".stl" class="block w-full text-sm text-gray-400
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-full file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-600 file:text-white
                                        hover:file:bg-blue-700 file:cursor-pointer
                                    " />
                                </div>
                                <div id="stlCanvas"></div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-2">Predicted Material Card</h3>
                                <p class="text-gray-400 text-sm mb-2">These anisotropic properties can be exported to
                                    professional FEA software.</p>
                                <div class="fea-table-container">
                                    <table class="w-full text-left text-sm text-gray-300">
                                        <thead class="text-xs text-gray-100 uppercase">
                                            <tr>
                                                <th scope="col" class="py-3 px-4">Property</th>
                                                <th scope="col" class="py-3 px-4">Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fea-results-table">
                                            <!-- Rows will be injected by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Fatigue Model Outputs -->
                        <div id="fatigue-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Predicted Fatigue Lifetime</div>
                                    <div id="fatigue_lifetime" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">Cycles</div>
                            </div>
                            <div class="text-gray-400 text-sm p-2">
                                This is an estimate of how many times the part can withstand the specified stress level
                                before failure.
                            </div>
                        </div>

                        <!-- v5: Accuracy Model Outputs -->
                        <div id="accuracy-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">% Variation in Length</div>
                                    <div id="acc_Var_Length_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">% Variation in Width</div>
                                    <div id="acc_Var_Width_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">% Variation in Thickness</div>
                                    <div id="acc_Var_Thickness_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column 3: Recommendations -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Optimization Recommendations</h2>

                        <!-- Kaggle Recommendations -->
                        <div id="kaggle-recs" class="model-recs space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Quality (Strength &
                                    Finish):</h3>
                                <ul id="kaggle-rec-quality"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-yellow-400">To Maximize Speed &
                                    Cost-Effectiveness:</h3>
                                <ul id="kaggle-rec-speed" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- C3 Recommendations -->
                        <div id="c3-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Tensile Strength:</h3>
                                <ul id="c3-rec-strength" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-blue-400">To Maximize Elongation (Ductility):</h3>
                                <ul id="c3-rec-elongation"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- FEA Recommendations -->
                        <div id="fea-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300">FEA Model Notes</h3>
                                <p class="text-gray-400 text-sm">
                                    This model predicts the anisotropic material properties based on your filament's
                                    datasheet values and slicer settings.
                                </p>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1 mt-2">
                                    <li>The predicted values are for the **part as printed**, not the raw filament.</li>
                                    <li>**Higher 'Bonding Perfection'** (better layer adhesion) dramatically increases
                                        vertical strength.</li>
                                    <li>The **Infill Pattern** (Rectilinear vs. Concentric) has a major impact on how
                                        the part behaves under load from different directions.</li>
                                    <li>Use these properties in FEA software to simulate real-world performance of your
                                        specific part geometry.</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Fatigue Recommendations -->
                        <div id="fatigue-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Fatigue Life (Durability):
                                </h3>
                                <ul id="fatigue-rec-life" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-red-400">To Reduce Fatigue Life (Warning):</h3>
                                <ul id="fatigue-rec-warning"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- v5: Accuracy Recommendations -->
                        <div id="accuracy-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Dimensional Accuracy
                                    (Minimize Error):</h3>
                                <ul id="accuracy-rec-life"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-red-400">Settings that Increase Error (Warning):
                                </h3>
                                <ul id="accuracy-rec-warning"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ================================== -->
        <!-- ===== v4: OPTIMIZER TAB ======== -->
        <!-- ================================== -->
        <div id="content-optimizer" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Column 1: Optimization Setup -->
                <div class="simulator-card space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-4">Optimization Setup</h2>
                        <p class="text-gray-400 text-sm mb-4">Define your goals, and the genetic algorithm will find the
                            best parameters to match them.</p>
                    </div>

                    <!-- Step 1: Select Model -->
                    <div>
                        <label for="optModelSelector" class="block text-sm font-medium text-gray-300 mb-2">1. Select
                            Model to Optimize</label>
                        <select id="optModelSelector"
                            class="w-full max-w-md bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="kaggle" selected>Kaggle Model (Strength, Roughness, Elongation)</option>
                            <option value="accuracy">Dimensional Accuracy (v5)</option>
                            <option value="c3" disabled>C3 Model (Optimizer not yet supported)</option>
                            <option value="fea" disabled>FEA Model (Optimizer not yet supported)</option>
                            <option value="fatigue" disabled>Fatigue Model (Optimizer not yet supported)</option>
                        </select>
                    </div>

                    <!-- Step 2: Define Objectives -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">2. Define Objectives (What to
                            Max/Min)</label>
                        <div id="optObjectivesContainer" class="space-y-3">
                            <!-- JS will populate this based on model selection -->
                        </div>
                        <button id="addObjectiveBtn" class="mt-3 text-sm text-blue-400 hover:text-blue-300">+ Add
                            Objective</button>
                    </div>

                    <!-- Step 3: Define Constraints -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">3. Define Constraints
                            (Optional)</label>
                        <div id="optConstraintsContainer" class="space-y-3">
                            <!-- JS will populate this -->
                        </div>
                        <button id="addConstraintBtn" class="mt-3 text-sm text-blue-400 hover:text-blue-300">+ Add
                            Constraint</button>
                    </div>

                    <button id="runOptimizationBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center">
                        <svg id="optSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <span id="optBtnText">Run Optimization</span>
                    </button>
                    <div id="optErrorMsg"
                        class="hidden text-center text-red-400 p-3 bg-red-900 bg-opacity-30 rounded-lg">
                        <p id="optErrorText" class="text-sm">Error details here.</p>
                    </div>
                </div>

                <!-- Column 2: Optimization Results -->
                <div class="simulator-card">
                    <h2 class="text-xl font-semibold text-white mb-4">Optimization Results</h2>
                    <p class="text-gray-400 text-sm mb-4">Showing the Top 5 "best trade-off" solutions (Pareto front)
                        found by the algorithm, sorted by your first objective.</p>

                    <div id="optResultsContainer" class="hidden">
                        <div class="fea-table-container">
                            <table class="w-full text-left text-sm text-gray-300">
                                <thead id="optResultsHeader" class="text-xs text-gray-100 uppercase">
                                    <!-- JS will populate this -->
                                    THead>
                                <tbody id="optResultsBody">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="optPlaceholder" class="text-center text-gray-500 py-10">
                        <p>Run the optimizer to see results here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- v3: Footer with References -->
        <footer class="mt-12 text-gray-500 text-sm">
            <div class="simulator-card bg-gray-900 bg-opacity-30 border-gray-800">
                <h3 class="text-lg font-semibold text-gray-400 mb-3">Data Sources & References</h3>
                <p class="mb-3">This application is a predictive tool based on machine learning models trained on
                    publicly available research data. The models predict properties based on the specific datasets and
                    experimental conditions from the following papers:</p>
                <ol class="list-decimal list-inside space-y-2">
                    <li>
                        <strong>Kaggle Model:</strong> Based on the "3D Printer" dataset by Afumento on Kaggle. Provides
                        a general-purpose model for PLA/ABS predicting strength, roughness, and elongation.
                    </li>
                    <li>
                        <strong>C3 Model:</strong> Based on the stress-strain data from Wang et al. (2024), "Machine
                        learning enabled 3D printing parameter settings for desired mechanical properties."
                    </li>
                    <li>
                        <strong>FEA Material Card:</strong> Based on the anisotropic property dataset from Lee & Tucker
                        (2025), "Data-Driven 3D-Printed Material Data Prediction From Benchmark Specimens."
                    </li>
                    <li>
                        <strong>Fatigue Lifetime Model:</strong> Based on the dataset from Azadi & Dadashi (2022),
                        "Experimental fatigue dataset for additive-manufactured 3D-printed Polylactic acid
                        biomaterials..."
                    </li>
                    <li>
                        <strong>Dimensional Accuracy Model:</strong> Based on the dataset from Deswal et al. (2019),
                        "Modeling and parametric optimization of FDM 3D printing process using hybrid techniques for
                        enhancing dimensional preciseness."
                    </li>
                    <li>
                        <strong>Optimization Methodology:</strong> The genetic algorithm (NSGA-II) is inspired by
                        optimization research, such as Panico et al. (2025), "Multi objective optimization of FDM 3D
                        printing parameters..."
                    </li>
                </ol>
            </div>
        </footer>

    </div>

    <script type="module">
        // === 3D Viewer (three.js) ===
        let scene, camera, renderer, controls, mesh;

        function init3DViewer() {
            const canvas = document.getElementById('stlCanvas');
            if (!canvas) return; // Don't init if canvas not on page

            // 1. Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1f2937); // gray-800

            // 2. Camera
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.z = 100;

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            canvas.innerHTML = ''; // Clear canvas
            canvas.appendChild(renderer.domElement);

            // 4. Lights
            const ambientLight = new THREE.AmbientLight(0x404040, 2); // soft white light
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-1, -1, -1).normalize();
            scene.add(directionalLight2);

            // 5. Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.enableZoom = true;

            // 6. Animation Loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // 7. Resize Handler
            window.addEventListener('resize', () => {
                if (canvas.offsetParent === null) return; // Only resize if visible
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                if (width === 0 || height === 0) return;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }, false);
        }

        function loadSTL(file) {
            const loader = new THREE.STLLoader();
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const geometry = loader.parse(event.target.result);

                    if (mesh) {
                        scene.remove(mesh); // Remove old mesh
                    }

                    // Create material
                    const material = new THREE.MeshStandardMaterial({
                        color: 0x3b82f6, // blue-500
                        metalness: 0.1,
                        roughness: 0.5,
                    });

                    // Create mesh
                    mesh = new THREE.Mesh(geometry, material);

                    // Center the geometry
                    geometry.computeBoundingBox();
                    const center = geometry.boundingBox.getCenter(new THREE.Vector3());
                    mesh.position.sub(center);

                    // Add to scene
                    scene.add(mesh);

                    // Zoom to fit
                    const size = geometry.boundingBox.getSize(new THREE.Vector3()).length();
                    camera.position.z = size;
                    controls.update();

                } catch (e) {
                    console.error("Error parsing STL:", e);
                    showError("Error: Could not parse the STL file. It may be corrupt or in the wrong format.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // === API & Simulation Logic ===
        const API_BASE_URL = "http://127.0.0.1:8000";
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // --- Global State ---
        let materialsDatabase = {}; // To store materials.json

        // --- Input Getters ---
        function getGlobalInputs() {
            const mass = parseFloat(document.getElementById('global_part_mass_g').value);
            const cost = parseFloat(document.getElementById('global_filament_cost_kg').value);

            if (isNaN(mass) || mass <= 0) {
                throw new Error("Filament Used (g) must be a positive number.");
            }
            if (isNaN(cost) || cost <= 0) {
                throw new Error("Filament Cost ($/kg) must be a positive number.");
            }

            // Get material name from the *active* model's dropdown
            const selectedModel = document.getElementById('modelSelector').value;
            let material_name = "PLA"; // Default

            if (selectedModel === 'kaggle') {
                material_name = document.getElementById('kaggle_material_database').value || document.getElementById('material').value;
            } else if (selectedModel === 'fea') {
                material_name = document.getElementById('fea_material_database').value || "PLA";
            } else if (selectedModel === 'fatigue') {
                material_name = document.getElementById('fatigue_material_database').value || "PLA";
            } else {
                material_name = "PLA"; // C3 and Accuracy models are PLA-based
            }

            return {
                part_mass_g: mass,
                filament_cost_kg: cost,
                material_name: material_name
            };
        }

        function getKaggleInputs() {
            return {
                ...getGlobalInputs(),
                layer_height: parseFloat(document.getElementById('layer_height').value),
                wall_thickness: parseInt(document.getElementById('wall_thickness').value),
                infill_density: parseInt(document.getElementById('infill_density').value),
                infill_pattern: document.getElementById('infill_pattern').value,
                nozzle_temperature: parseInt(document.getElementById('nozzle_temperature').value),
                bed_temperature: parseInt(document.getElementById('bed_temperature').value),
                print_speed: parseInt(document.getElementById('print_speed').value),
                material: document.getElementById('material').value,
                fan_speed: parseInt(document.getElementById('fan_speed').value),
            };
        }

        function getC3Inputs() {
            return {
                ...getGlobalInputs(),
                Temperature: parseFloat(document.getElementById('c3_Temperature').value),
                Speed: parseFloat(document.getElementById('c3_Speed').value),
                Angle: parseFloat(document.getElementById('c3_Angle').value),
                Height: parseFloat(document.getElementById('c3_Height').value),
                Fill: parseFloat(document.getElementById('c3_Fill').value),
            };
        }

        function getFEAInputs() {
            return {
                ...getGlobalInputs(),
                Material_Bonding_Perfection: parseFloat(document.getElementById('fea_Material_Bonding_Perfection').value),
                Material_Youngs_Modulus_GPa: parseFloat(document.getElementById('fea_Material_Youngs_Modulus_GPa').value),
                Material_Tensile_Yield_Strenght_MPa: parseFloat(document.getElementById('fea_Material_Tensile_Yield_Strenght_MPa').value),
                Material_Poissons_Ratio: parseFloat(document.getElementById('fea_Material_Poissons_Ratio').value),
                User_Infill_Pattern: document.getElementById('fea_User_Infill_Pattern').value,
                User_Infill_Density: parseFloat(document.getElementById('fea_User_Infill_Density').value),
                User_Line_Thickenss_mm: parseFloat(document.getElementById('fea_User_Line_Thickenss_mm').value),
                User_Layer_Height_mm: parseFloat(document.getElementById('fea_User_Layer_Height_mm').value),
            };
        }

        function getFatigueInputs() {
            return {
                ...getGlobalInputs(),
                Nozzle_Diameter: parseFloat(document.getElementById('fatigue_Nozzle_Diameter').value),
                Print_Speed: parseFloat(document.getElementById('fatigue_Print_Speed').value),
                Nozzle_Temperature: parseFloat(document.getElementById('fatigue_Nozzle_Temperature').value),
                Stress_Level: parseFloat(document.getElementById('fatigue_Stress_Level').value),
            };
        }

        function getAccuracyInputs() { // v5: New Function
            return {
                ...getGlobalInputs(),
                Layer_Thickness_mm: parseFloat(document.getElementById('acc_Layer_Thickness_mm').value),
                Build_Orientation_deg: parseInt(document.getElementById('acc_Build_Orientation_deg').value),
                Infill_Density_percent: parseInt(document.getElementById('acc_Infill_Density_percent').value),
                Number_of_Contours: parseInt(document.getElementById('acc_Number_of_Contours').value),
            };
        }

        // --- UI Updaters ---
        function updateGlobalOutputs(data) {
            document.getElementById('estimated_cost_usd').textContent = data.estimated_cost_usd.toFixed(2);
            document.getElementById('estimated_print_time_min').textContent = data.estimated_print_time_min.toFixed(1);
        }

        function updateKaggleUI(data) {
            updateGlobalOutputs(data);
            document.getElementById('tensile_strength').textContent = data.tensile_strength.toFixed(2);
            document.getElementById('roughness').textContent = data.roughness.toFixed(2);
            document.getElementById('elongation').textContent = data.elongation.toFixed(2);
        }

        function updateC3UI(data) {
            updateGlobalOutputs(data);
            document.getElementById('c3_tensile_strength').textContent = data.Tensile_Strength_MPa.toFixed(2);
            document.getElementById('c3_elongation').textContent = data.Elongation_at_Break_percent.toFixed(2);
        }

        function updateFEAUI(data) {
            updateGlobalOutputs(data);
            const tableBody = document.getElementById('fea-results-table');
            tableBody.innerHTML = ''; // Clear old results
            for (const [key, value] of Object.entries(data.properties)) {
                const row = `
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <td class="py-2 px-4 font-medium">${key.replace(/_/g, ' ')}</td>
                        <td class="py-2 px-4 text-blue-300 font-mono">${parseFloat(value).toFixed(4)}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
        }

        function updateFatigueUI(data) {
            updateGlobalOutputs(data);
            document.getElementById('fatigue_lifetime').textContent = Math.round(data.Fatigue_Lifetime).toLocaleString();
        }

        function updateAccuracyUI(data) { // v5: New Function
            updateGlobalOutputs(data);
            document.getElementById('acc_Var_Length_percent').textContent = data.Var_Length_percent.toFixed(3);
            document.getElementById('acc_Var_Width_percent').textContent = data.Var_Width_percent.toFixed(3);
            document.getElementById('acc_Var_Thickness_percent').textContent = data.Var_Thickness_percent.toFixed(3);
        }

        // --- Recommendation Engines ---
        function updateKaggleRecs(inputs) {
            const recQuality = [];
            const recSpeed = [];
            if (inputs.layer_height <= 0.1) recQuality.push("Low layer height is good for quality.");
            else recQuality.push("Consider lowering layer height (< 0.1mm) for better finish and strength.");
            if (inputs.infill_density > 80) recQuality.push("High infill density is great for strength.");
            else recQuality.push("Increase infill density (> 80%) for maximum strength.");
            if (inputs.print_speed < 60) recQuality.push("Low print speed improves layer adhesion.");
            else recQuality.push("Reduce print speed (< 60mm/s) to increase strength.");
            if (inputs.material === 'abs' && inputs.nozzle_temperature < 230) recQuality.push("Increase ABS temp (> 230°C) for better layer bonding.");
            if (inputs.material === 'pla' && inputs.nozzle_temperature < 210) recQuality.push("Increase PLA temp (> 210°C) for better layer bonding.");
            if (inputs.layer_height > 0.2) recSpeed.push("High layer height is great for speed.");
            else recSpeed.push("Increase layer height (> 0.2mm) to reduce print time.");
            if (inputs.infill_density < 30) recSpeed.push("Low infill density saves time and material.");
            else recSpeed.push("Lower infill density (< 30%) for faster, cheaper prints (if strength is not critical).");
            if (inputs.print_speed > 90) recSpeed.push("High print speed is fast.");
            else recSpeed.push("Increase print speed (> 90mm/s) to reduce print time.");
            document.getElementById('kaggle-rec-quality').innerHTML = recQuality.map(rec => `<li>${rec}</li>`).join('');
            document.getElementById('kaggle-rec-speed').innerHTML = recSpeed.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateC3Recs(inputs) {
            const recStrength = [];
            const recElongation = [];
            if (inputs.Temperature > 210) recStrength.push("High nozzle temp (> 210°C) is good for strength.");
            else recStrength.push("Increase nozzle temp (> 210°C) for better layer bonding.");
            if (inputs.Fill > 90) recStrength.push("High infill density (> 90%) maximizes strength.");
            else recStrength.push("Increase infill density for higher strength.");
            if (inputs.Height <= 0.1) recStrength.push("Low layer height (0.1mm) improves strength.");
            else recStrength.push("Decrease layer height to 0.1mm for better strength.");
            if (inputs.Temperature < 200) recElongation.push("Lower temps (< 200°C) can increase ductility.");
            else recElongation.push("Try a moderate temperature (~200-210°C).");
            if (inputs.Angle === 45) recElongation.push("A 45° raster angle provides a good balance of properties.");
            else recElongation.push("Consider a 45° raster angle for balanced ductility.");
            document.getElementById('c3-rec-strength').innerHTML = recStrength.map(rec => `<li>${rec}</li>`).join('');
            document.getElementById('c3-rec-elongation').innerHTML = recElongation.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateFatigueRecs(inputs) {
            const recLife = [];
            const recWarning = [];
            if (inputs.Nozzle_Temperature > 220) recLife.push("High nozzle temp (> 220°C) improves layer bonding, increasing fatigue life.");
            else recLife.push("Increase nozzle temp (> 220°C) for significantly better durability.");
            if (inputs.Print_Speed < 8) recLife.push("Low print speed (< 8 mm/s) allows better layer fusion.");
            else recLife.push("Reduce print speed (< 8 mm/s) to maximize fatigue life.");
            if (inputs.Nozzle_Diameter > 0.4) recLife.push("A larger nozzle diameter (0.6mm) can create stronger bonds.");
            else recLife.push("Consider a larger nozzle (0.6mm) if durability is critical.");
            if (inputs.Stress_Level > 10) recWarning.push("High stress levels drastically reduce part lifetime.");
            else recWarning.push("Lowering the applied stress is the most effective way to increase life.");
            if (inputs.Nozzle_Temperature < 200) recWarning.push("Low nozzle temp (< 200°C) creates weak bonds that fail quickly under fatigue.");
            if (inputs.Print_Speed > 12) recWarning.push("High print speed (> 12 mm/s) can lead to poor layer adhesion.");
            document.getElementById('fatigue-rec-life').innerHTML = recLife.map(rec => `<li>${rec}</li>`).join('');
            document.getElementById('fatigue-rec-warning').innerHTML = recWarning.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateAccuracyRecs(inputs) { // v5: New Function
            const recLife = [];
            const recWarning = [];
            if (inputs.Layer_Thickness_mm <= 0.1) recLife.push("Low layer thickness (0.1mm) minimizes error.");
            else recLife.push("Lower layer thickness for better accuracy.");
            if (inputs.Build_Orientation_deg === 45) recLife.push("A 45° orientation often provides the best balance of accuracy.");
            else recLife.push("Consider a 45° orientation. 0° and 90° can have higher error in some axes.");
            if (inputs.Number_of_Contours > 1) recLife.push("Multiple contours can help stabilize the part's outer dimensions.");
            else recLife.push("Use at least 2 contours for better accuracy.");
            if (inputs.Infill_Density_percent < 100) recWarning.push("Lower infill density (<100%) can lead to more shrinkage and error.");
            else recWarning.push("100% infill provides the most dimensionally stable (but costly) part.");
            document.getElementById('accuracy-rec-life').innerHTML = recLife.map(rec => `<li>${rec}</li>`).join('');
            document.getElementById('accuracy-rec-warning').innerHTML = recWarning.map(rec => `<li>${rec}</li>`).join('');
        }

        // --- State Management ---
        function showSpinner() {
            spinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideSpinner() {
            spinner.classList.add('hidden');
        }

        function showError(message) {
            hideSpinner();
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // --- Main Simulation Functions ---

        // Use a debounce function to prevent spamming the API on every slider move
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        const simulationRunner = async (modelName, getter, updater, recUpdater) => {
            showSpinner();
            let inputs;
            try {
                inputs = getter();
            } catch (error) {
                showError(error.message);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/predict/${modelName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                hideSpinner();
                hideError();
                updater(data);
                recUpdater(inputs);

            } catch (error) {
                console.error(`Simulation failed for ${modelName}:`, error);
                showError(`Error: ${error.message}. Is the server running?`);
            }
        };

        // Debounced simulation runners
        const debouncedKaggleSim = debounce(() => simulationRunner('kaggle', getKaggleInputs, updateKaggleUI, updateKaggleRecs), 300);
        const debouncedC3Sim = debounce(() => simulationRunner('c3', getC3Inputs, updateC3UI, updateC3Recs), 300);
        const debouncedFEASim = debounce(() => simulationRunner('fea', getFEAInputs, updateFEAUI, () => { }), 300);
        const debouncedFatigueSim = debounce(() => simulationRunner('fatigue', getFatigueInputs, updateFatigueUI, updateFatigueRecs), 300);
        const debouncedAccuracySim = debounce(() => simulationRunner('accuracy', getAccuracyInputs, updateAccuracyUI, updateAccuracyRecs), 300); // v5: New runner

        // --- Model Switching Logic ---
        const modelSelector = document.getElementById('modelSelector');
        const paramContainers = document.querySelectorAll('.model-params');
        const outputContainers = document.querySelectorAll('.model-outputs');
        const recContainers = document.querySelectorAll('.model-recs');
        const gcodeParserContainer = document.getElementById('gcode-parser-container');

        function switchModel(selectedModel) {
            // Hide all containers
            [...paramContainers, ...outputContainers, ...recContainers].forEach(el => el.classList.add('hidden'));

            // Hide GCode parser by default
            gcodeParserContainer.classList.add('hidden');
            hideError();

            // Show containers for the selected model
            document.getElementById(`${selectedModel}-params`).classList.remove('hidden');
            document.getElementById(`${selectedModel}-outputs`).classList.remove('hidden');
            document.getElementById(`${selectedModel}-recs`).classList.remove('hidden');

            // Show GCode parser for Kaggle AND C3
            if (selectedModel === 'kaggle' || selectedModel === 'c3') {
                gcodeParserContainer.classList.remove('hidden');
            }

            // Run the simulation for the selected model
            if (selectedModel === 'kaggle') debouncedKaggleSim();
            else if (selectedModel === 'c3') debouncedC3Sim();
            else if (selectedModel === 'fea') {
                if (!scene) init3DViewer(); // Init 3D viewer if not already
                debouncedFEASim();
            }
            else if (selectedModel === 'fatigue') debouncedFatigueSim();
            else if (selectedModel === 'accuracy') debouncedAccuracySim(); // v5: New call
        }

        modelSelector.addEventListener('change', (e) => switchModel(e.target.value));

        // --- G-Code Parsing ---
        document.getElementById('parseGcodeBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('gcodeFile');
            if (fileInput.files.length === 0) {
                alert("Please select a .gcode file first.");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                const gcode = e.target.result;
                const selectedModel = modelSelector.value;

                try {
                    // Refactored: Parse all params once
                    const params = parseUnifiedOrcaSlicerGcode(gcode);
                    console.log("Parsed all G-Code params:", params);

                    // Route to the correct setter
                    if (selectedModel === 'kaggle') {
                        setKaggleInputs(params);
                        runKaggleSimulation(); // Re-run simulation
                    } else if (selectedModel === 'c3') {
                        setC3Inputs(params);
                        runC3Simulation(); // Re-run simulation
                    }
                } catch (error) {
                    console.error("G-Code parsing error:", error);
                    alert(`Failed to parse G-Code: ${error.message}`);
                }
            };

            reader.readAsText(file);
        });

        // Refactored: Unified G-Code Parser
        function parseUnifiedOrcaSlicerGcode(gcode) {
            const params = {};
            const lines = gcode.split('\n');

            const patterns = {
                // Kaggle Params
                layer_height: /; layer_height = ([\d.]+)/,
                wall_thickness: /; wall_loops = (\d+)/,
                infill_density: /; sparse_infill_density = ([\d.]+)%/,
                infill_pattern: /; sparse_infill_pattern = (\w+)/,
                nozzle_temperature: /; nozzle_temperature = (\d+)/,
                bed_temperature: /; bed_temperature = (\d+)/,
                print_speed: /; outer_wall_speed = ([\d.]+)/,
                material: /; filament_type = (\w+)/,
                fan_speed: /; fan_speed = (\d+)/,
                // C3 Params
                Angle: /; sparse_infill_angle = (\d+)/,
            };

            for (const line of lines) {
                if (!line.startsWith(';')) continue;
                for (const [key, regex] of Object.entries(patterns)) {
                    const match = line.match(regex);
                    if (match && !params[key]) params[key] = match[1];
                }
            }

            // Map material type
            if (params.material) {
                if (params.material.toLowerCase().includes('pla')) params.material = 'pla';
                else if (params.material.toLowerCase().includes('abs')) params.material = 'abs';
            }

            if (Object.keys(params).length < 3) { // Just a basic check
                console.warn("Could not find many parameters. Is this an OrcaSlicer G-Code file?");
            }
            return params;
        }

        // Helper to set slider and text value
        const setSlider = (id, value) => {
            const slider = document.getElementById(id);
            if (slider) {
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                // Clamp value to slider's min/max range
                const clampedValue = Math.max(min, Math.min(max, parseFloat(value)));
                if (isNaN(clampedValue)) return; // Skip if value is not a number

                slider.value = clampedValue;
                const valEl = document.getElementById(`${id}_val`);
                if (valEl) valEl.textContent = clampedValue;
            } else {
                console.warn(`Slider with id ${id} not found.`);
            }
        };

        // Helper to set select value
        const setSelect = (id, value) => {
            const select = document.getElementById(id);
            if (select) {
                const option = Array.from(select.options).find(opt => value.toLowerCase().includes(opt.value.toLowerCase()));
                if (option) select.value = option.value;
                else console.warn(`Could not find matching option for ${id}: ${value}`);
            }
        };

        // Updated Input Setters (pull from unified params)
        function setKaggleInputs(params) {
            if (params.layer_height) setSlider('layer_height', params.layer_height);
            if (params.wall_thickness) setSlider('wall_thickness', params.wall_thickness);
            if (params.infill_density) setSlider('infill_density', params.infill_density);
            if (params.nozzle_temperature) setSlider('nozzle_temperature', params.nozzle_temperature);
            if (params.bed_temperature) setSlider('bed_temperature', params.bed_temperature);
            if (params.print_speed) setSlider('print_speed', params.print_speed);
            if (params.fan_speed) setSlider('fan_speed', params.fan_speed);
            if (params.infill_pattern) setSelect('infill_pattern', params.infill_pattern);

            if (params.material) {
                // Set hidden material field
                document.getElementById('material').value = params.material;
                // Set the visible dropdown
                const dbSelect = document.getElementById('kaggle_material_database');
                const option = Array.from(dbSelect.options).find(opt => params.material.toLowerCase().includes(opt.value.toLowerCase()));
                if (option) dbSelect.value = option.value;
                else dbSelect.value = ""; // Not a known material
            }
        }

        function setC3Inputs(params) {
            if (params.nozzle_temperature) setSlider('c3_Temperature', params.nozzle_temperature);
            if (params.print_speed) setSlider('c3_Speed', params.print_speed);
            if (params.Angle) setSlider('c3_Angle', params.Angle);
            if (params.layer_height) setSlider('c3_Height', params.layer_height);
            if (params.infill_density) setSlider('c3_Fill', params.infill_density);
        }

        // --- Material Database Logic ---
        async function loadMaterials() {
            try {
                const response = await fetch(`${API_BASE_URL}/materials`);
                if (!response.ok) throw new Error('Failed to fetch materials');
                materialsDatabase = await response.json();

                // Get all three select dropdowns
                const kaggleSelect = document.getElementById('kaggle_material_database');
                const feaSelect = document.getElementById('fea_material_database');
                const fatigueSelect = document.getElementById('fatigue_material_database');

                // Populate all dropdowns
                for (const materialName of Object.keys(materialsDatabase)) {
                    const option = new Option(materialName, materialName);
                    // Check which models this material applies to
                    const materialData = materialsDatabase[materialName];
                    if (materialData.common && (materialName.toLowerCase().includes('pla') || materialName.toLowerCase().includes('abs'))) {
                        kaggleSelect.add(option.cloneNode(true));
                    }
                    if (materialData.fea) {
                        feaSelect.add(option.cloneNode(true));
                    }
                    if (materialData.fatigue) {
                        fatigueSelect.add(option.cloneNode(true));
                    }
                }
            } catch (error) {
                console.error("Failed to load materials database:", error);
                // Don't show a blocking error, just log it
            }
        }

        // Add listeners for the new material dropdowns
        document.getElementById('kaggle_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName]) return;

            const data = materialsDatabase[materialName].common;
            const materialType = materialName.toLowerCase().includes('pla') ? 'pla' : 'abs';

            // Set hidden material field
            document.getElementById('material').value = materialType;

            // Set sliders
            if (data.bed_temperature) setSlider('bed_temperature', data.bed_temperature);
            if (data.nozzle_temperature) setSlider('nozzle_temperature', data.nozzle_temperature);
            if (data.print_speed) setSlider('print_speed', data.print_speed);
            if (data.fan_speed) setSlider('fan_speed', data.fan_speed);

            debouncedKaggleSim(); // Re-run simulation
        });

        document.getElementById('fea_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName] || !materialsDatabase[materialName].fea) return;

            const data = materialsDatabase[materialName].fea;
            if (data.Material_Youngs_Modulus_GPa) setSlider('fea_Material_Youngs_Modulus_GPa', data.Material_Youngs_Modulus_GPa);
            if (data.Material_Tensile_Yield_Strenght_MPa) setSlider('fea_Material_Tensile_Yield_Strenght_MPa', data.Material_Tensile_Yield_Strenght_MPa);
            if (data.Material_Poissons_Ratio) setSlider('fea_Material_Poissons_Ratio', data.Material_Poissons_Ratio);

            debouncedFEASim(); // Re-run simulation
        });

        document.getElementById('fatigue_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName] || !materialsDatabase[materialName].fatigue) return;

            const data = materialsDatabase[materialName].fatigue;
            if (data.Nozzle_Temperature) setSlider('fatigue_Nozzle_Temperature', data.Nozzle_Temperature);
            if (data.Print_Speed) setSlider('fatigue_Print_Speed', data.Print_Speed);
            if (data.Nozzle_Diameter) setSlider('fatigue_Nozzle_Diameter', data.Nozzle_Diameter);

            debouncedFatigueSim(); // Re-run simulation
        });

        // --- Event Listeners ---

        // Add listeners for all sliders and selects
        const allInputs = document.querySelectorAll('input[type="range"], select');
        allInputs.forEach(input => {
            // Check if it's one of the new database selects, if so, skip it as it has its own listener
            if (input.id.includes('_material_database') || input.id === 'modelSelector' || input.id.startsWith('opt')) return;

            input.addEventListener('input', () => {
                // Update text for sliders
                if (input.type === 'range') {
                    const valEl = document.getElementById(`${input.id}_val`);
                    if (valEl) valEl.textContent = input.value;
                }

                // Special case for Kaggle material: set hidden input
                if (input.id === 'material') {
                    document.getElementById('material').value = input.value;
                }

                // Trigger the correct simulation
                const selectedModel = modelSelector.value;
                if (selectedModel === 'kaggle') debouncedKaggleSim();
                else if (selectedModel === 'c3') debouncedC3Sim();
                else if (selectedModel === 'fea') debouncedFEASim();
                else if (selectedModel === 'fatigue') debouncedFatigueSim();
                else if (selectedModel === 'accuracy') debouncedAccuracySim(); // v5: New call
            });
        });

        // STL file loader
        document.getElementById('stlFile').addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                loadSTL(event.target.files[0]);
            }
        });

        // --- v4: Tab Switching Logic ---
        const tabSimulator = document.getElementById('tab-simulator');
        const tabOptimizer = document.getElementById('tab-optimizer');
        const contentSimulator = document.getElementById('content-simulator');
        const contentOptimizer = document.getElementById('content-optimizer');

        tabSimulator.addEventListener('click', () => {
            tabSimulator.classList.add('active');
            tabOptimizer.classList.remove('active');
            contentSimulator.classList.add('active');
            contentOptimizer.classList.remove('active');
        });

        tabOptimizer.addEventListener('click', () => {
            tabOptimizer.classList.add('active');
            tabSimulator.classList.remove('active');
            contentOptimizer.classList.add('active');
            contentSimulator.classList.remove('active');
            updateOptimizerOptions(); // Update options when tab is clicked
        });

        // --- v4: Optimizer Logic ---

        // Config for optimizer
        const OPTIMIZER_CONFIG = {
            "kaggle": {
                outputs: [
                    { name: "tensile_strength", label: "Tensile Strength (MPa)" },
                    { name: "roughness", label: "Roughness (µm)" },
                    { name: "elongation", label: "Elongation (%)" },
                ],
                params: [
                    { name: "layer_height", label: "Layer Height (mm)" },
                    { name: "wall_thickness", label: "Wall Thickness (layers)" },
                    { name: "infill_density", label: "Infill Density (%)" },
                    { name: "nozzle_temperature", label: "Nozzle Temp (°C)" },
                    { name: "bed_temperature", label: "Bed Temp (°C)" },
                    { name: "print_speed", label: "Print Speed (mm/s)" },
                    { name: "fan_speed", label: "Fan Speed (%)" },
                ]
            },
            "accuracy": { // v5: New Optimizer Config
                outputs: [
                    { name: "Var_Length_percent", label: "% Variation in Length" },
                    { name: "Var_Width_percent", label: "% Variation in Width" },
                    { name: "Var_Thickness_percent", label: "% Variation in Thickness" },
                ],
                params: [
                    { name: "Layer_Thickness_mm", label: "Layer Thickness (mm)" },
                    { name: "Build_Orientation_deg", label: "Build Orientation (°)" },
                    { name: "Infill_Density_percent", label: "Infill Density (%)" },
                    { name: "Number_of_Contours", label: "Number of Contours" },
                ]
            }
            // Add other models (C3, Fatigue, FEA) here as they become supported
        };

        const optModelSelector = document.getElementById('optModelSelector');
        const optObjectivesContainer = document.getElementById('optObjectivesContainer');
        const optConstraintsContainer = document.getElementById('optConstraintsContainer');

        let objectiveCount = 0;
        let constraintCount = 0;

        function updateOptimizerOptions() {
            const modelName = optModelSelector.value;
            const config = OPTIMIZER_CONFIG[modelName];

            if (!config) {
                optObjectivesContainer.innerHTML = '<p class="text-sm text-gray-400">This model is not yet supported by the optimizer.</p>';
                optConstraintsContainer.innerHTML = '';
                return;
            }

            // Reset containers
            optObjectivesContainer.innerHTML = '';
            optConstraintsContainer.innerHTML = '';
            objectiveCount = 0;
            constraintCount = 0;

            // Create combined list of outputs + cost/time for objectives
            const allOutputs = [
                ...config.outputs,
                { name: "estimated_cost_usd", label: "Estimated Cost ($)" },
                { name: "estimated_print_time_min", label: "Estimated Time (min)" }
            ];

            const allParams = config.params;

            // Add first objective (required)
            addObjective(allOutputs, allParams, false);
            // Add first constraint (optional)
            addConstraint(allParams, false);
        }

        function createSelect(options, id, name) {
            const select = document.createElement('select');
            select.id = id;
            select.name = name;
            select.className = "w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2";
            options.forEach(opt => {
                const optionEl = new Option(opt.label, opt.name);
                select.add(optionEl);
            });
            return select;
        }

        function addObjective(allOutputs, allParams, canRemove = true) {
            objectiveCount++;
            const div = document.createElement('div');
            div.id = `obj_row_${objectiveCount}`;
            div.className = 'grid grid-cols-12 gap-2 items-center';

            // Goal (Min/Max) Select
            const goalSelect = createSelect([
                { label: "Minimize", name: "minimize" },
                { label: "Maximize", name: "maximize" }
            ], `obj_goal_${objectiveCount}`, 'obj_goal');
            goalSelect.className += ' col-span-4';

            // Property Select
            const propSelect = createSelect(allOutputs, `obj_prop_${objectiveCount}`, 'obj_prop');
            propSelect.className += ' col-span-7';

            // Remove Button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'col-span-1 text-red-400 font-bold text-2xl hover:text-red-300';
            removeBtn.onclick = () => div.remove();

            div.appendChild(goalSelect);
            div.appendChild(propSelect);
            if (canRemove) div.appendChild(removeBtn);

            optObjectivesContainer.appendChild(div);
        }

        function addConstraint(allParams, canRemove = true) {
            constraintCount++;
            const div = document.createElement('div');
            div.id = `con_row_${constraintCount}`;
            div.className = 'grid grid-cols-12 gap-2 items-center';

            // Property Select
            const propSelect = createSelect(allParams, `con_prop_${constraintCount}`, 'con_prop');
            propSelect.className += ' col-span-5';

            // Operator Select
            const opSelect = createSelect([
                { label: "<=", name: "lt" },
                { label: ">=", name: "gt" }
            ], `con_op_${constraintCount}`, 'con_op');
            opSelect.className += ' col-span-3';

            // Value Input
            const valInput = document.createElement('input');
            valInput.type = 'number';
            valInput.id = `con_val_${constraintCount}`;
            valInput.name = 'con_val';
            valInput.className = 'col-span-3 w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2';
            valInput.placeholder = 'Value';

            // Remove Button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'col-span-1 text-red-400 font-bold text-2xl hover:text-red-300';
            removeBtn.onclick = () => div.remove();

            div.appendChild(propSelect);
            div.appendChild(opSelect);
            div.appendChild(valInput);
            if (canRemove) div.appendChild(removeBtn);

            optConstraintsContainer.appendChild(div);
        }

        // Add Objective/Constraint Button Listeners
        document.getElementById('addObjectiveBtn').addEventListener('click', () => {
            const config = OPTIMIZER_CONFIG[optModelSelector.value];
            const allOutputs = [
                ...config.outputs,
                { name: "estimated_cost_usd", label: "Estimated Cost ($)" },
                { name: "estimated_print_time_min", label: "Estimated Time (min)" }
            ];
            addObjective(allOutputs, config.params, true);
        });

        document.getElementById('addConstraintBtn').addEventListener('click', () => {
            const config = OPTIMIZER_CONFIG[optModelSelector.value];
            addConstraint(config.params, true);
        });

        // Update options when model selection changes
        optModelSelector.addEventListener('change', updateOptimizerOptions);

        // Run Optimization
        const runOptimizationBtn = document.getElementById('runOptimizationBtn');
        const optSpinner = document.getElementById('optSpinner');
        const optBtnText = document.getElementById('optBtnText');
        const optErrorMsg = document.getElementById('optErrorMsg');
        const optErrorText = document.getElementById('optErrorText');
        const optResultsContainer = document.getElementById('optResultsContainer');
        const optPlaceholder = document.getElementById('optPlaceholder');
        const optResultsHeader = document.getElementById('optResultsHeader');
        const optResultsBody = document.getElementById('optResultsBody');

        runOptimizationBtn.addEventListener('click', async () => {
            // 1. Show loading state
            runOptimizationBtn.disabled = true;
            optSpinner.classList.remove('hidden');
            optBtnText.textContent = 'Optimizing...';
            optErrorMsg.classList.add('hidden');
            optPlaceholder.classList.remove('hidden');
            optResultsContainer.classList.add('hidden');

            let globalInputs;
            try {
                // 2. Get Global Inputs
                globalInputs = getGlobalInputs();
            } catch (error) {
                optErrorText.textContent = error.message;
                optErrorMsg.classList.remove('hidden');
                runOptimizationBtn.disabled = false;
                optSpinner.classList.add('hidden');
                optBtnText.textContent = 'Run Optimization';
                return;
            }

            // 3. Get Objectives
            const objectives = [];
            document.querySelectorAll('[name="obj_goal"]').forEach((goalEl, i) => {
                const propEl = document.getElementById(`obj_prop_${i + 1}`);
                objectives.push({
                    name: propEl.value,
                    goal: goalEl.value
                });
            });

            // 4. Get Constraints
            const constraints = [];
            document.querySelectorAll('[name="con_prop"]').forEach((propEl, i) => {
                const opEl = document.getElementById(`con_op_${i + 1}`);
                const valEl = document.getElementById(`con_val_${i + 1}`);
                if (valEl.value) { // Only add if a value is entered
                    constraints.push({
                        name: propEl.value,
                        operator: opEl.value,
                        value: parseFloat(valEl.value)
                    });
                }
            });

            // 5. Create Request Body
            const requestBody = {
                model_name: optModelSelector.value,
                objectives: objectives,
                constraints: constraints,
                global_inputs: globalInputs
            };

            // 6. Run API Call
            try {
                const response = await fetch(`${API_BASE_URL}/optimize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || `HTTP error! status: ${response.status}`);
                }

                const results = await response.json();

                // 7. Display Results
                displayOptimizationResults(results);

            } catch (error) {
                console.error("Optimization failed:", error);
                optErrorText.textContent = `Error: ${error.message}`;
                optErrorMsg.classList.remove('hidden');
            } finally {
                // 8. Hide loading state
                runOptimizationBtn.disabled = false;
                optSpinner.classList.add('hidden');
                optBtnText.textContent = 'Run Optimization';
            }
        });

        function displayOptimizationResults(results) {
            if (results.length === 0) {
                optPlaceholder.innerHTML = '<p>No optimal solutions found. Try relaxing your constraints.</p>';
                optPlaceholder.classList.remove('hidden');
                optResultsContainer.classList.add('hidden');
                return;
            }

            // Clear old results
            optResultsHeader.innerHTML = '';
            optResultsBody.innerHTML = '';

            // Get all input and output keys from the first result
            const inputKeys = Object.keys(results[0].inputs);
            const outputKeys = Object.keys(results[0].outputs);

            // Create Header Row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML += `<th scope="col" class="py-3 px-4">#</th>`;
            // Add output headers (objectives)
            outputKeys.forEach(key => {
                headerRow.innerHTML += `<th scope="col" class="py-3 px-4 bg-blue-900 bg-opacity-30">${key.replace(/_/g, ' ')}</th>`;
            });
            // Add input headers (parameters)
            inputKeys.forEach(key => {
                headerRow.innerHTML += `<th scope="col" class="py-3 px-4">${key.replace(/_/g, ' ')}</th>`;
            });
            optResultsHeader.appendChild(headerRow);

            // Create Body Rows
            results.forEach((result, i) => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700';

                row.innerHTML += `<td class="py-2 px-4 font-medium">${i + 1}</td>`;
                // Add output values
                outputKeys.forEach(key => {
                    row.innerHTML += `<td class="py-2 px-4 text-blue-300 font-mono">${result.outputs[key]}</td>`;
                });
                // Add input values
                inputKeys.forEach(key => {
                    row.innerHTML += `<td class="py-2 px-4 font-mono">${result.inputs[key]}</td>`;
                });
                optResultsBody.appendChild(row);
            });

            optPlaceholder.classList.add('hidden');
            optResultsContainer.classList.remove('hidden');
        }

        // --- Initial Run ---
        loadMaterials(); // Load the materials DB first
        switchModel(modelSelector.value); // Then run the default simulation

    </script>
</body>

</html>