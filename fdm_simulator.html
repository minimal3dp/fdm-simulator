<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDM 3D Print Property Simulator (v11)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load three.js for 3D viewer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        .simulator-card {
            background-color: rgba(31, 41, 55, 0.6);
            /* gray-800 with 60% opacity */
            border: 1px solid rgba(55, 65, 81, 0.7);
            /* gray-700 with 70% opacity */
            border-radius: 0.75rem;
            padding: 1.5rem;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #d1d5db;
            /* gray-300 */
        }

        .slider-value {
            font-weight: 600;
            color: #f9fafb;
            /* gray-50 */
        }

        /* Custom slider track */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #374151;
            /* gray-700 */
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #f9fafb;
            /* gray-50 */
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #f9fafb;
            /* gray-50 */
        }

        .output-card {
            background-color: #1f2937;
            /* gray-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output-label {
            font-size: 0.875rem;
            color: #9ca3af;
            /* gray-400 */
        }

        .output-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
            /* blue-500 */
        }

        #stlCanvas {
            width: 100%;
            height: 400px;
            border-radius: 0.5rem;
            background-color: #1f2937;
            /* gray-800 */
        }

        .fea-table-container,
        .optimizer-results-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1f2937;
            /* gray-800 */
            border-radius: 0.5rem;
        }

        .fea-table th,
        .optimizer-results-table th {
            position: sticky;
            top: 0;
            background-color: #374151;
            /* gray-700 */
        }

        /* Tab styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 0.5rem;
            border: 2px solid transparent;
            color: #9ca3af;
            /* gray-400 */
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn[aria-selected="true"] {
            background-color: #3b82f6;
            /* blue-500 */
            color: #ffffff;
        }

        .tab-btn:hover:not([aria-selected="true"]) {
            color: #d1d5db;
            /* gray-300 */
        }

        .tab-panel {
            display: none;
            /* Hidden by default */
        }

        .tab-panel[role="tabpanel"]:not([hidden]) {
            display: block;
            /* Shown when active */
        }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-trigger {
            cursor: help;
            border-bottom: 1px dotted #6b7280;
            /* gray-500 */
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            width: max-content;
            max-width: 300px;
            padding: 8px 12px;
            background-color: #1f2937;
            /* gray-800 */
            color: #e5e7eb;
            /* gray-200 */
            font-size: 0.75rem;
            line-height: 1.25rem;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            /* gray-600 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        .tooltip-container:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body class="h-full text-gray-100 p-4 md:p-8 bg-gray-900">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-white">FDM 3D Print Property Simulator (v11)</h1>
            <p class="text-lg text-gray-400">Simulate mechanical properties or optimize parameters based on your goals.
            </p>
        </header>

        <!-- Global Settings Card (v3) -->
        <div class="simulator-card mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">Global Print Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="relative group">
                    <label for="part_mass_g" class="block text-sm font-medium text-gray-300 mb-1">
                        <span class="tooltip-container">
                            <span class="tooltip-trigger">Filament Used (g)</span>
                            <span class="tooltip">Get this value from your slicer after slicing the part. It's used for
                                cost & time estimates.</span>
                        </span>
                    </label>
                    <input type="number" id="part_mass_g" value="50"
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                </div>
                <div class="relative group">
                    <label for="filament_cost_kg" class="block text-sm font-medium text-gray-300 mb-1">
                        <span class="tooltip-container">
                            <span class="tooltip-trigger">Filament Cost ($/kg)</span>
                            <span class="tooltip">The price you paid for a 1kg spool of filament (e.g., 24.99).</span>
                        </span>
                    </label>
                    <input type="number" id="filament_cost_kg" value="25"
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                </div>
                <div class="relative group">
                    <label for="global_material_name" class="block text-sm font-medium text-gray-300 mb-1">
                        <span class="tooltip-container">
                            <span class="tooltip-trigger">Global Material</span>
                            <span class="tooltip">Select the material you are printing with. This helps get the correct
                                density for cost/time estimates.</span>
                        </span>
                    </label>
                    <select id="global_material_name"
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                        <!-- Options will be populated by JS from /materials -->
                        <option value="Generic PLA">Generic PLA</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Content: Tabs (v4) -->
        <div role="tablist" class="flex items-center border-b border-gray-700 mb-6 space-x-2">
            <button id="tab-simulator" role="tab" aria-selected="true" class="tab-btn">Simulator</button>
            <button id="tab-optimizer" role="tab" aria-selected="false" class="tab-btn">Optimizer</button>
            <button id="tab-gcode" role="tab" aria-selected="false" class="tab-btn">G-Code Analysis</button>
        </div>

        <!-- Simulator Tab Panel -->
        <div id="panel-simulator" role="tabpanel" class="tab-panel">
            <!-- Model Selector -->
            <div class="mb-6">
                <label for="modelSelector" class="block text-sm font-medium text-gray-300 mb-2">Select Simulation
                    Model</label>
                <select id="modelSelector"
                    class="w-full max-w-md bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="kaggle" selected>Kaggle Model (Strength, Roughness)</option>
                    <option value="composite">Composite Filament (CF/GF)</option> <!-- v9: New -->
                    <option value="multimaterial">Multi-Material Bond Strength</option> <!-- v8: New -->
                    <option value="hardness">Hardness Model (Shore D)</option>
                    <option value="accuracy">Dimensional Accuracy (Error %)</option>
                    <option value="warpage">Warp Deformation (mm)</option>
                    <option value="fatigue">Fatigue Lifetime Model (Cycles)</option>
                    <option value="c3">C3 Model (Tensile & Elongation)</option>
                    <option value="fea">FEA Material Card (Anisotropic)</option>
                </select>
            </div>

            <!-- Simulator Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Column 1: G-Code Parser & Parameters -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- G-Code Parser (Kaggle & C3 Only) -->
                    <div id="gcode-parser-container" class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">G-Code Parser</h2>
                        <p class="text-gray-400 text-sm mb-4">Upload an OrcaSlicer `.gcode` file to automatically
                            populate parameters for the selected model.</p>
                        <input type="file" id="gcodeFile" accept=".gcode" class="block w-full text-sm text-gray-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-600 file:text-white
                            hover:file:bg-blue-700 file:cursor-pointer
                        " />
                        <button id="parseGcodeBtn"
                            class="mt-4 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                            Parse G-Code
                        </button>
                    </div>

                    <!-- Parameters Card -->
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Process Parameters</h2>

                        <!-- Kaggle Model Parameters -->
                        <div id="kaggle-params" class="model-params space-y-4">
                            <div class="relative group">
                                <label for="kaggle_material_database"
                                    class="block text-sm font-medium text-gray-300 mb-1">
                                    <span class="tooltip-container">
                                        <span class="tooltip-trigger">Material Datasheet (Preset)</span>
                                        <span class="tooltip">Select a known filament to auto-fill common
                                            parameters.</span>
                                    </span>
                                </label>
                                <select id="kaggle_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <hr class="border-gray-700" />
                            <div class="relative group">
                                <label for="layer_height" class="slider-label"><span>Layer Height (mm)</span><span
                                        id="layer_height_val" class="slider-value">0.1</span></label>
                                <input type="range" id="layer_height" min="0.02" max="0.3" step="0.01" value="0.1"
                                    class="w-full">
                                <span class="tooltip">Thickness of each individual printed layer.</span>
                            </div>
                            <div class="relative group">
                                <label for="wall_thickness" class="slider-label"><span>Wall Thickness
                                        (layers)</span><span id="wall_thickness_val"
                                        class="slider-value">4</span></label>
                                <input type="range" id="wall_thickness" min="1" max="10" step="1" value="4"
                                    class="w-full">
                                <span class="tooltip">Number of outer shells (perimeters). More walls = stronger
                                    part.</span>
                            </div>
                            <div class="relative group">
                                <label for="infill_density" class="slider-label"><span>Infill Density (%)</span><span
                                        id="infill_density_val" class="slider-value">50</span></label>
                                <input type="range" id="infill_density" min="10" max="100" step="1" value="50"
                                    class="w-full">
                                <span class="tooltip">Percentage of material used for the internal support
                                    structure.</span>
                            </div>
                            <div class="relative group">
                                <label for="nozzle_temperature" class="slider-label"><span>Nozzle Temp (°C)</span><span
                                        id="nozzle_temperature_val" class="slider-value">220</span></label>
                                <input type="range" id="nozzle_temperature" min="200" max="250" step="1" value="220"
                                    class="w-full">
                                <span class="tooltip">Temperature of the extruder. Critical for layer adhesion.</span>
                            </div>
                            <div class="relative group">
                                <label for="bed_temperature" class="slider-label"><span>Bed Temp (°C)</span><span
                                        id="bed_temperature_val" class="slider-value">60</span></label>
                                <input type="range" id="bed_temperature" min="50" max="100" step="1" value="60"
                                    class="w-full">
                                <span class="tooltip">Temperature of the print surface. Prevents warping.</span>
                            </div>
                            <div class="relative group">
                                <label for="print_speed" class="slider-label"><span>Print Speed (mm/s)</span><span
                                        id="print_speed_val" class="slider-value">60</span></label>
                                <input type="range" id="print_speed" min="40" max="120" step="1" value="60"
                                    class="w-full">
                                <span class="tooltip">Speed of the print head (mm/s). Slower is generally
                                    stronger.</span>
                            </div>
                            <div class="relative group">
                                <label for="fan_speed" class="slider-label"><span>Fan Speed (%)</span><span
                                        id="fan_speed_val" class="slider-value">50</span></label>
                                <input type="range" id="fan_speed" min="0" max="100" step="1" value="50" class="w-full">
                                <span class="tooltip">Cooling fan speed. Higher speed can reduce layer bonding.</span>
                            </div>
                            <div class="relative group">
                                <label for="infill_pattern" class="block text-sm font-medium text-gray-300 mb-2">Infill
                                    Pattern</label>
                                <select id="infill_pattern"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="grid">Grid</option>
                                    <option value="honeycomb">Honeycomb</option>
                                </select>
                            </div>
                            <!-- Hidden input for material type (PLA/ABS) -->
                            <input type="hidden" id="material" value="pla">
                        </div>

                        <!-- v8: Multi-Material Model Parameters -->
                        <div id="multimaterial-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="multimaterial_Material_A"
                                    class="block text-sm font-medium text-gray-300 mb-2">Material A</label>
                                <select id="multimaterial_Material_A"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="ABS">ABS</option>
                                </select>
                                <span class="tooltip">This model only supports ABS as the primary material.</span>
                            </div>
                            <div class="relative group">
                                <label for="multimaterial_Material_B"
                                    class="block text-sm font-medium text-gray-300 mb-2">Material B</label>
                                <select id="multimaterial_Material_B"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="PETG">PETG</option>
                                </select>
                                <span class="tooltip">This model only supports PETG as the secondary material.</span>
                            </div>
                            <div class="relative group">
                                <label for="multimaterial_Layer_Height_mm" class="slider-label"><span>Layer Height
                                        (mm)</span><span id="multimaterial_Layer_Height_mm_val"
                                        class="slider-value">0.3</span></label>
                                <input type="range" id="multimaterial_Layer_Height_mm" min="0.2" max="0.4" step="0.1"
                                    value="0.3" class="w-full">
                                <span class="tooltip">Thickness of each individual printed layer.</span>
                            </div>
                            <div class="relative group">
                                <label for="multimaterial_Extrusion_Temp_C" class="slider-label"><span>Extrusion Temp
                                        (°C)</span><span id="multimaterial_Extrusion_Temp_C_val"
                                        class="slider-value">240</span></label>
                                <input type="range" id="multimaterial_Extrusion_Temp_C" min="230" max="250" step="10"
                                    value="240" class="w-full">
                                <span class="tooltip">Nozzle temperature. Critical for bonding between different
                                    materials.</span>
                            </div>
                            <div class="relative group">
                                <label for="multimaterial_Infill_Density_percent" class="slider-label"><span>Infill
                                        Density (%)</span><span id="multimaterial_Infill_Density_percent_val"
                                        class="slider-value">80</span></label>
                                <input type="range" id="multimaterial_Infill_Density_percent" min="60" max="100"
                                    step="20" value="80" class="w-full">
                                <span class="tooltip">Infill density. Higher values increase the bonded surface
                                    area.</span>
                            </div>
                        </div>

                        <!-- v9: Composite Filament Parameters -->
                        <div id="composite-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="composite_Reinforcement_percent" class="slider-label"><span>Carbon Fiber Reinforcement (%)</span><span id="composite_Reinforcement_percent_val" class="slider-value">0</span></label>
                                <input type="range" id="composite_Reinforcement_percent" min="0" max="40" step="5" value="0" class="w-full">
                                <span class="tooltip">Weight percentage of carbon fiber reinforcement in the PETG composite.</span>
                            </div>
                            <div class="relative group">
                                <label for="composite_Infill_Pattern" class="block text-sm font-medium text-gray-300 mb-2">Infill Pattern</label>
                                <select id="composite_Infill_Pattern" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="Grid">Grid</option>
                                    <option value="Tri-Hexagon">Tri-Hexagon</option>
                                    <option value="Gyroid">Gyroid</option>
                                </select>
                            </div>
                            <div class="relative group">
                                <label for="composite_Infill_Density_percent" class="slider-label"><span>Infill Density (%)</span><span id="composite_Infill_Density_percent_val" class="slider-value">50</span></label>
                                <input type="range" id="composite_Infill_Density_percent" min="25" max="75" step="25" value="50" class="w-full">
                            </div>
                            <div class="relative group">
                                <label for="composite_Layer_Thickness_mm" class="slider-label"><span>Layer Thickness (mm)</span><span id="composite_Layer_Thickness_mm_val" class="slider-value">0.2</span></label>
                                <input type="range" id="composite_Layer_Thickness_mm" min="0.1" max="0.3" step="0.1" value="0.2" class="w-full">
                            </div>
                        </div>

                        <!-- v7: Hardness Model Parameters -->
                        <div id="hardness-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="hardness_Layer_Thickness_mm" class="slider-label"><span>Layer Thickness
                                        (mm)</span><span id="hardness_Layer_Thickness_mm_val"
                                        class="slider-value">0.2</span></label>
                                <input type="range" id="hardness_Layer_Thickness_mm" min="0.2" max="0.5" step="0.1"
                                    value="0.2" class="w-full">
                                <span class="tooltip">Thickness of each individual printed layer.</span>
                            </div>
                            <div class="relative group">
                                <label for="hardness_Shell_Thickness_mm" class="slider-label"><span>Shell Thickness
                                        (mm)</span><span id="hardness_Shell_Thickness_mm_val"
                                        class="slider-value">1.2</span></label>
                                <input type="range" id="hardness_Shell_Thickness_mm" min="1.2" max="1.6" step="0.4"
                                    value="1.2" class="w-full">
                                <span class="tooltip">Total thickness of the outer walls (perimeters).</span>
                            </div>
                            <div class="relative group">
                                <label for="hardness_Fill_Density_percent" class="slider-label"><span>Fill Density
                                        (%)</span><span id="hardness_Fill_Density_percent_val"
                                        class="slider-value">40</span></label>
                                <input type="range" id="hardness_Fill_Density_percent" min="20" max="80" step="20"
                                    value="40" class="w-full">
                                <span class="tooltip">Percentage of material used for the internal support
                                    structure.</span>
                            </div>
                            <div class="relative group">
                                <label for="hardness_Fill_Pattern"
                                    class="block text-sm font-medium text-gray-300 mb-2">Fill Pattern</label>
                                <select id="hardness_Fill_Pattern"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="Rectilinear">Rectilinear</option>
                                    <option value="Honey_Comb">Honeycomb</option>
                                </select>
                            </div>
                        </div>

                        <!-- v5: Accuracy Model Parameters -->
                        <div id="accuracy-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="accuracy_Layer_Thickness_mm" class="slider-label"><span>Layer Thickness
                                        (mm)</span><span id="accuracy_Layer_Thickness_mm_val"
                                        class="slider-value">0.2</span></label>
                                <input type="range" id="accuracy_Layer_Thickness_mm" min="0.1" max="0.4" step="0.1"
                                    value="0.2" class="w-full">
                                <span class="tooltip">Thickness of each individual printed layer. Thicker layers can
                                    increase error.</span>
                            </div>
                            <div class="relative group">
                                <label for="accuracy_Build_Orientation_deg" class="slider-label"><span>Build Orientation
                                        (°)</span><span id="accuracy_Build_Orientation_deg_val"
                                        class="slider-value">45</span></label>
                                <input type="range" id="accuracy_Build_Orientation_deg" min="0" max="90" step="15"
                                    value="45" class="w-full">
                                <span class="tooltip">Angle of the part on the build plate relative to the X-axis. 0° is
                                    aligned with X.</span>
                            </div>
                            <div class="relative group">
                                <label for="accuracy_Infill_Density_percent" class="slider-label"><span>Infill Density
                                        (%)</span><span id="accuracy_Infill_Density_percent_val"
                                        class="slider-value">90</span></label>
                                <input type="range" id="accuracy_Infill_Density_percent" min="80" max="100" step="10"
                                    value="90" class="w-full">
                                <span class="tooltip">This model is based on high-density infill (80-100%).</span>
                            </div>
                            <div class="relative group">
                                <label for="accuracy_Number_of_Contours" class="slider-label"><span>Number of
                                        Contours</span><span id="accuracy_Number_of_Contours_val"
                                        class="slider-value">2</span></label>
                                <input type="range" id="accuracy_Number_of_Contours" min="1" max="3" step="1" value="2"
                                    class="w-full">
                                <span class="tooltip">Number of outer walls (perimeters).</span>
                            </div>
                        </div>

                        <!-- v6: Warpage Model Parameters -->
                        <div id="warpage-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="warpage_Layer_Temperature_C" class="slider-label"><span>Layer Temp
                                        (°C)</span><span id="warpage_Layer_Temperature_C_val"
                                        class="slider-value">200</span></label>
                                <input type="range" id="warpage_Layer_Temperature_C" min="190" max="210" step="5"
                                    value="200" class="w-full">
                                <span class="tooltip">Nozzle temperature. Higher temperatures can increase
                                    warping.</span>
                            </div>
                            <div class="relative group">
                                <label for="warpage_Infill_Density_percent" class="slider-label"><span>Infill Density
                                        (%)</span><span id="warpage_Infill_Density_percent_val"
                                        class="slider-value">20</span></label>
                                <input type="range" id="warpage_Infill_Density_percent" min="10" max="30" step="10"
                                    value="20" class="w-full">
                                <span class="tooltip">This model is based on low-density infill (10-30%).</span>
                            </div>
                            <div class="relative group">
                                <label for="warpage_First_Layer_Height_mm" class="slider-label"><span>First Layer Height
                                        (mm)</span><span id="warpage_First_Layer_Height_mm_val"
                                        class="slider-value">0.3</span></label>
                                <input type="range" id="warpage_First_Layer_Height_mm" min="0.2" max="0.4" step="0.1"
                                    value="0.3" class="w-full">
                                <span class="tooltip">A thicker first layer can improve bed adhesion and reduce
                                    warping.</span>
                            </div>
                            <div class="relative group">
                                <label for="warpage_Other_Layer_Height_mm" class="slider-label"><span>Other Layer Height
                                        (mm)</span><span id="warpage_Other_Layer_Height_mm_val"
                                        class="slider-value">0.4</span></label>
                                <input type="range" id="warpage_Other_Layer_Height_mm" min="0.3" max="0.5" step="0.1"
                                    value="0.4" class="w-full">
                                <span class="tooltip">Height for all layers after the first.</span>
                            </div>
                        </div>

                        <!-- Fatigue Model Parameters -->
                        <div id="fatigue-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="fatigue_material_database"
                                    class="block text-sm font-medium text-gray-300 mb-1">
                                    <span class="tooltip-container">
                                        <span class="tooltip-trigger">Material Datasheet (Preset)</span>
                                        <span class="tooltip">Select a known filament to auto-fill common
                                            parameters.</span>
                                    </span>
                                </label>
                                <select id="fatigue_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <hr class="border-gray-700" />
                            <h3 class="text-lg font-semibold text-blue-300">Part Load</h3>
                            <div class="relative group">
                                <label for="fatigue_Stress_Level" class="slider-label"><span>Applied Stress Level
                                        (MPa)</span><span id="fatigue_Stress_Level_val"
                                        class="slider-value">10</span></label>
                                <input type="range" id="fatigue_Stress_Level" min="2.5" max="15" step="0.1" value="10"
                                    class="w-full">
                                <span class="tooltip">The real-world cyclical load (in MegaPascals) you expect the part
                                    to endure. This is *not* a slicer setting.</span>
                            </div>
                            <h3 class="text-lg font-semibold text-blue-300 mt-4">Slicer Settings</h3>
                            <div class="relative group">
                                <label for="fatigue_Nozzle_Diameter" class="slider-label"><span>Nozzle Diameter
                                        (mm)</span><span id="fatigue_Nozzle_Diameter_val"
                                        class="slider-value">0.4</span></label>
                                <input type="range" id="fatigue_Nozzle_Diameter" min="0.2" max="0.6" step="0.1"
                                    value="0.4" class="w-full">
                                <span class="tooltip">The diameter of the nozzle used to print the part.</span>
                            </div>
                            <div class="relative group">
                                <label for="fatigue_Print_Speed" class="slider-label"><span>Print Speed
                                        (mm/s)</span><span id="fatigue_Print_Speed_val"
                                        class="slider-value">10</span></label>
                                <input type="range" id="fatigue_Print_Speed" min="5" max="15" step="1" value="10"
                                    class="w-full">
                                <span class="tooltip">Speed of the print head (mm/s). Slower is generally
                                    stronger.</span>
                            </div>
                            <div class="relative group">
                                <label for="fatigue_Nozzle_Temperature" class="slider-label"><span>Nozzle Temp
                                        (°C)</span><span id="fatigue_Nozzle_Temperature_val"
                                        class="slider-value">210</span></label>
                                <input type="range" id="fatigue_Nozzle_Temperature" min="180" max="240" step="1"
                                    value="210" class="w-full">
                                <span class="tooltip">Temperature of the extruder. Critical for layer adhesion and
                                    fatigue life.</span>
                            </div>
                        </div>

                        <!-- C3 Model Parameters -->
                        <div id="c3-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="c3_Temperature" class="slider-label"><span>Nozzle Temp (°C)</span><span
                                        id="c3_Temperature_val" class="slider-value">205</span></label>
                                <input type="range" id="c3_Temperature" min="190" max="220" step="1" value="205"
                                    class="w-full">
                                <span class="tooltip">Temperature of the extruder. Critical for layer adhesion and
                                    strength.</span>
                            </div>
                            <div class="relative group">
                                <label for="c3_Speed" class="slider-label"><span>Print Speed (mm/s)</span><span
                                        id="c3_Speed_val" class="slider-value">70</span></label>
                                <input type="range" id="c3_Speed" min="40" max="100" step="1" value="70" class="w-full">
                                <span class="tooltip">Speed of the print head (mm/s). Slower is generally
                                    stronger.</span>
                            </div>
                            <div class="relative group">
                                <label for="c3_Angle" class="slider-label"><span>Raster Angle (°)</span><span
                                        id="c3_Angle_val" class="slider-value">45</span></label>
                                <input type="range" id="c3_Angle" min="0" max="90" step="15" value="45" class="w-full">
                                <span class="tooltip">Raster angle (e.g., 0°, 45°, 90°). The direction lines are
                                    printed.</span>
                            </div>
                            <div class="relative group">
                                <label for="c3_Height" class="slider-label"><span>Layer Height (mm)</span><span
                                        id="c3_Height_val" class="slider-value">0.15</span></label>
                                <input type="range" id="c3_Height" min="0.1" max="0.2" step="0.01" value="0.15"
                                    class="w-full">
                                <span class="tooltip">Thickness of each individual printed layer.</span>
                            </div>
                            <div class="relative group">
                                <label for="c3_Fill" class="slider-label"><span>Infill Density (%)</span><span
                                        id="c3_Fill_val" class="slider-value">85</span></label>
                                <input type="range" id="c3_Fill" min="70" max="100" step="1" value="85" class="w-full">
                                <span class="tooltip">Percentage of material used for the internal support
                                    structure.</span>
                            </div>
                        </div>

                        <!-- FEA Model Parameters -->
                        <div id="fea-params" class="model-params space-y-4 hidden">
                            <div class="relative group">
                                <label for="fea_material_database" class="block text-sm font-medium text-gray-300 mb-1">
                                    <span class="tooltip-container">
                                        <span class="tooltip-trigger">Material Datasheet (Preset)</span>
                                        <span class="tooltip">Select a known filament to auto-fill material properties
                                            from its Technical Data Sheet (TDS).</span>
                                    </span>
                                </label>
                                <select id="fea_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <hr class="border-gray-700" />
                            <h3 class="text-lg font-semibold text-blue-300">Filament Datasheet Properties</h3>
                            <div class="relative group">
                                <label for="fea_Material_Bonding_Perfection" class="slider-label"><span>Bonding
                                        Perfection</span><span id="fea_Material_Bonding_Perfection_val"
                                        class="slider-value">0.5</span></label>
                                <input type="range" id="fea_Material_Bonding_Perfection" min="0.1" max="1.0" step="0.01"
                                    value="0.5" class="w-full">
                                <span class="tooltip">A factor (0.1-1.0) representing how well layers bond. 1.0 is a
                                    perfect bond.</span>
                            </div>
                            <div class="relative group">
                                <label for="fea_Material_Youngs_Modulus_GPa" class="slider-label"><span>Young's Modulus
                                        (GPa)</span><span id="fea_Material_Youngs_Modulus_GPa_val"
                                        class="slider-value">2.5</span></label>
                                <input type="range" id="fea_Material_Youngs_Modulus_GPa" min="1.0" max="5.0" step="0.1"
                                    value="2.5" class="w-full">
                                <span class="tooltip">Material stiffness. Find this value on your filament's Technical
                                    Data Sheet (TDS).</span>
                            </div>
                            <div class="relative group">
                                <label for="fea_Material_Tensile_Yield_Strenght_MPa" class="slider-label"><span>Tensile
                                        Strength (MPa)</span><span id="fea_Material_Tensile_Yield_Strenght_MPa_val"
                                        class="slider-value">50</span></label>
                                <input type="range" id="fea_Material_Tensile_Yield_Strenght_MPa" min="20" max="80"
                                    step="1" value="50" class="w-full">
                                <span class="tooltip">Maximum stress the *raw filament* can take. Find this on your
                                    filament's TDS.</span>
                            </div>
                            <div class="relative group">
                                <label for="fea_Material_Poissons_Ratio" class="slider-label"><span>Poisson's
                                        Ratio</span><span id="fea_Material_Poissons_Ratio_val"
                                        class="slider-value">0.35</span></label>
                                <input type="range" id="fea_Material_Poissons_Ratio" min="0.1" max="0.5" step="0.01"
                                    value="0.35" class="w-full">
                                <span class="tooltip">Material's tendency to shrink/expand sideways when
                                    stretched/compressed. Find this on your filament's TDS.</span>
                            </div>

                            <h3 class="text-lg font-semibold text-blue-300 mt-4">Slicer Settings</h3>
                            <div class="relative group">
                                <label for="fea_User_Infill_Density" class="slider-label"><span>Infill Density
                                        (0.1-1.0)</span><span id="fea_User_Infill_Density_val"
                                        class="slider-value">0.5</span></label>
                                <input type="range" id="fea_User_Infill_Density" min="0.1" max="1.0" step="0.01"
                                    value="0.5" class="w-full">
                                <span class="tooltip">Infill percentage as a decimal (e.g., 0.5 = 50%).</span>
                            </div>
                            <div class="relative group">
                                <label for="fea_User_Line_Thickenss_mm" class="slider-label"><span>Line Thickness
                                        (mm)</span><span id="fea_User_Line_Thickenss_mm_val"
                                        class="slider-value">0.4</span></label>
                                <input type="range" id="fea_User_Line_Thickenss_mm" min="0.2" max="0.8" step="0.01"
                                    value="0.4" class="w-full">
                                <span class="tooltip">Width of a single extruded line (e.g., 0.4mm for a 0.4mm
                                    nozzle).</span>
                            </div>
                            <div class="relative group">
                                <label for="fea_User_Layer_Height_mm" class="slider-label"><span>Layer Height
                                        (mm)</span><span id="fea_User_Layer_Height_mm_val"
                                        class="slider-value">0.2</span></label>
                                <input type="range" id="fea_User_Layer_Height_mm" min="0.1" max="0.4" step="0.01"
                                    value="0.2" class="w-full">
                                <span class="tooltip">Thickness of each individual printed layer for the part.</span>
                            </div>
                            <div class="relative group">
                                <label for="fea_User_Infill_Pattern"
                                    class="block text-sm font-medium text-gray-300 mb-2">Infill Pattern</label>
                                <select id="fea_User_Infill_Pattern"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="Rectilinear">Rectilinear</option>
                                    <option value="concentric">Concentric</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Column 2: Predicted Properties -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- Predicted Properties Card -->
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Predicted Properties</h2>
                        <div id="spinner" class="hidden text-center text-gray-400">
                            <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p>Simulating...</p>
                        </div>
                        <div id="error-message"
                            class="hidden text-center text-red-400 p-3 bg-red-900 bg-opacity-30 rounded-lg">
                            <p class="font-bold">Simulation Failed</p>
                            <p id="error-text" class="text-sm">Error details here.</p>
                        </div>

                        <!-- v3: Cost & Time Outputs (Common to all) -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Est. Cost</div>
                                    <div id="estimated_cost" class="output-value text-green-400">$...</div>
                                </div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Est. Time</div>
                                    <div id="estimated_time" class="output-value text-yellow-400">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400 self-end">min</div>
                            </div>
                        </div>

                        <!-- Kaggle Model Outputs -->
                        <div id="kaggle-outputs" class="model-outputs space-y-3">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Tensile Strength</div>
                                    <div id="tensile_strength" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">MPa</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Roughness</div>
                                    <div id="roughness" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">µm</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Elongation</div>
                                    <div id="elongation" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>

                        <!-- v8: Multi-Material Model Outputs -->
                        <div id="multimaterial-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Predicted Bond Strength</div>
                                    <div id="multimaterial_tensile_strength" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">MPa</div>
                            </div>
                        </div>

                        <!-- v9: Composite Model Outputs -->
                        <div id="composite-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Tensile Strength</div>
                                    <div id="composite_Tensile_Strength_MPa" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">MPa</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Elastic Modulus</div>
                                    <div id="composite_Elastic_Modulus_GPa" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">GPa</div>
                            </div>
                        </div>

                        <!-- v7: Hardness Model Outputs -->
                        <div id="hardness-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Predicted Hardness</div>
                                    <div id="hardness_shore_d" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">Shore D</div>
                            </div>
                        </div>

                        <!-- v5: Accuracy Model Outputs -->
                        <div id="accuracy-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">% Error (Length)</div>
                                    <div id="var_length_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">% Error (Width)</div>
                                    <div id="var_width_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">% Error (Thickness)</div>
                                    <div id="var_thickness_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>

                        <!-- v6: Warpage Model Outputs -->
                        <div id="warpage-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Predicted Warpage</div>
                                    <div id="warpage_mm" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">mm</div>
                            </div>
                        </div>

                        <!-- Fatigue Model Outputs -->
                        <div id="fatigue-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Predicted Fatigue Lifetime</div>
                                    <div id="fatigue_lifetime" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">Cycles</div>
                            </div>
                        </div>

                        <!-- C3 Model Outputs -->
                        <div id="c3-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Tensile Strength</div>
                                    <div id="c3_tensile_strength" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">MPa</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Elongation at Break</div>
                                    <div id="c3_elongation" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>

                        <!-- FEA Model Outputs -->
                        <div id="fea-outputs" class="model-outputs space-y-4 hidden">
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Upload Part Geometry</h3>
                                    <p class="text-gray-400 text-sm mb-4">Upload an STL file to visualize your part.</p>
                                    <input type="file" id="stlFile" accept=".stl" class="block w-full text-sm text-gray-400
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-full file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-600 file:text-white
                                        hover:file:bg-blue-700 file:cursor-pointer
                                    " />
                                </div>
                                <div id="stlCanvas"></div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-2">Predicted Material Card</h3>
                                <p class="text-gray-400 text-sm mb-2">These anisotropic properties can be exported to
                                    professional FEA software.</p>
                                <div class="fea-table-container">
                                    <table class="w-full text-left text-sm text-gray-300">
                                        <thead class="text-xs text-gray-100 uppercase">
                                            <tr>
                                                <th scope="col" class="py-3 px-4">Property</th>
                                                <th scope="col" class="py-3 px-4">Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fea-results-table">
                                            <!-- Rows will be injected by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Column 3: Recommendations -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Optimization Recommendations</h2>

                        <!-- Kaggle Recommendations -->
                        <div id="kaggle-recs" class="model-recs space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Quality (Strength &
                                    Finish):</h3>
                                <ul id="kaggle-rec-quality"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-yellow-400">To Maximize Speed &
                                    Cost-Effectiveness:</h3>
                                <ul id="kaggle-rec-speed" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- v8: Multi-Material Recommendations -->
                        <div id="multimaterial-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Bond Strength (ABS+PETG):
                                </h3>
                                <ul id="multimaterial-rec-quality"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- v9: Composite Recommendations -->
                        <div id="composite-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Composite Performance:</h3>
                                <ul id="composite-rec-quality" class="list-disc list-inside text-gray-300 text-sm space-y-1"></ul>
                            </div>
                        </div>

                        <!-- v7: Hardness Recommendations -->
                        <div id="hardness-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Hardness (Shore D):</h3>
                                <ul id="hardness-rec-quality"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- v5: Accuracy Recommendations -->
                        <div id="accuracy-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Minimize Dimensional Error:</h3>
                                <ul id="accuracy-rec-quality"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- v6: Warpage Recommendations -->
                        <div id="warpage-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-red-400">To Minimize Warpage:</h3>
                                <ul id="warpage-rec-quality"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- Fatigue Recommendations -->
                        <div id="fatigue-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Fatigue Life (Durability):
                                </h3>
                                <ul id="fatigue-rec-life" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- C3 Recommendations -->
                        <div id="c3-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Tensile Strength:</h3>
                                <ul id="c3-rec-strength" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- FEA Recommendations -->
                        <div id="fea-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300">FEA Model Notes</h3>
                                <p class="text-gray-400 text-sm">
                                    This model predicts the anisotropic material properties based on your filament's
                                    datasheet values and slicer settings.
                                </p>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1 mt-2">
                                    <li>The predicted values are for the **part as printed**, not the raw filament.</li>
                                    <li>**Higher 'Bonding Perfection'** (better layer adhesion) dramatically increases
                                        vertical strength.</li>
                                    <li>Use these properties in FEA software to simulate real-world performance of your
                                        specific part geometry.</li>
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Optimizer Tab Panel (v4) -->
        <div id="panel-optimizer" role="tabpanel" class="tab-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Column 1: Optimizer Settings -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Optimizer Settings</h2>

                        <!-- Optimizer Model Selector -->
                        <div class="mb-4">
                            <label for="optimizerModelSelector" class="block text-sm font-medium text-gray-300 mb-2">1.
                                Select Model to Optimize</label>
                            <select id="optimizerModelSelector"
                                class="w-full max-w-md bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="kaggle" selected>Kaggle Model (Strength, Roughness)</option>
                                <option value="composite">Composite Filament (CF/GF)</option> <!-- v9: New -->
                                <option value="multimaterial">Multi-Material Bond Strength</option> <!-- v8: New -->
                                <option value="hardness">Hardness Model (Shore D)</option>
                                <option value="accuracy">Dimensional Accuracy (Error %)</option>
                                <option value="warpage">Warp Deformation (mm)</option>
                            </select>
                        </div>

                        <!-- Optimizer Objectives -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">2. Define Objectives (What to
                                Max/Min)</label>
                            <div id="optimizerObjectivesContainer" class="space-y-2">
                                <!-- JS will populate this based on model selection -->
                            </div>
                            <p class="text-xs text-gray-400 mt-2">The optimizer will find the best trade-offs for all
                                selected goals.</p>
                        </div>

                        <!-- Optimizer Constraints -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">3. Define Constraints
                                (Optional)</label>
                            <div id="optimizerConstraintsContainer" class="space-y-3">
                                <!-- JS will populate this -->
                            </div>
                            <button id="addConstraintBtn" class="mt-2 text-sm text-blue-400 hover:text-blue-300">+ Add
                                constraint</button>
                        </div>

                        <!-- Run Button -->
                        <div>
                            <button id="runOptimizerBtn"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center">
                                <svg id="optimizerSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span id="optimizerBtnText">Find Optimal Settings</span>
                            </button>
                            <div id="optimizer-error-message"
                                class="hidden text-center text-red-400 p-3 mt-4 bg-red-900 bg-opacity-30 rounded-lg">
                                <p class="font-bold">Optimization Failed</p>
                                <p id="optimizer-error-text" class="text-sm">Error details here.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column 2: Optimizer Results -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Optimization Results</h2>
                        <p class="text-gray-400 text-sm mb-4">Top 5 "best-compromise" settings based on your goals. The
                            results are sorted by the first objective.</p>
                        <div class="optimizer-results-container">
                            <table class="w-full text-left text-sm text-gray-300 optimizer-results-table">
                                <thead class="text-xs text-gray-100 uppercase">
                                    <tr id="optimizerResultsHeader">
                                        <!-- JS will populate this -->
                                    </tr>
                                </thead>
                                <tbody id="optimizerResultsBody">
                                    <tr>
                                        <td colspan="10" class="text-center p-4 text-gray-500">Run the optimizer to see
                                            results.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- G-Code Analysis Tab Panel (v9) -->
        <div id="panel-gcode" role="tabpanel" class="tab-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Column 1: Upload & Controls -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Upload G-Code File</h2>
                        <p class="text-gray-400 text-sm mb-4">
                            Upload your sliced G-code file to analyze toolpaths, estimate print time, 
                            and receive AI-powered optimization suggestions.
                        </p>
                        <div id="gcode-dropzone" class="border-2 border-dashed border-gray-600 rounded-lg p-4 mb-3 text-gray-400 text-sm hover:border-blue-500 transition-colors">
                            <p class="mb-2">Drag & drop your .gcode here, or click to select.</p>
                            <input type="file" id="gcodeAnalysisFile" accept=".gcode,.gco,.g" class="hidden" />
                            <button id="gcodeSelectBtn" class="mt-2 bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded">Choose File</button>
                            <div id="gcode-file-meta" class="mt-2 text-xs text-gray-500"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Material</label>
                                <div class="w-full bg-gray-800 text-gray-200 rounded p-2 text-sm">
                                    <span>Using Global Material: </span>
                                    <span id="gcode-material-current" class="text-blue-300">Generic PLA</span>
                                </div>
                            </div>
                            <div>
                                <label for="gcode-filament-diameter" class="block text-xs text-gray-400 mb-1">Filament Diameter (mm)</label>
                                <input id="gcode-filament-diameter" type="number" step="0.01" min="1.00" max="3.00" value="1.75" class="w-full bg-gray-800 text-gray-200 rounded p-2 text-sm" />
                            </div>
                        </div>
                        <button id="analyzeGcodeBtn"
                            class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            Analyze G-Code
                        </button>
                        
                        <div id="gcode-analysis-spinner" class="hidden text-center text-gray-400 mt-4">
                            <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p class="mt-2">Analyzing G-code...</p>
                        </div>
                        
                        <div id="gcode-error-message"
                            class="hidden text-center text-red-400 p-3 mt-4 bg-red-900 bg-opacity-30 rounded-lg">
                            <p class="font-bold">Analysis Failed</p>
                            <p id="gcode-error-text" class="text-sm">Error details here.</p>
                        </div>
                    </div>

                    <!-- Statistics Panel -->
                    <div id="gcode-stats-panel" class="simulator-card hidden">
                        <h2 class="text-xl font-semibold text-white mb-4">Print Statistics</h2>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Print Time</div>
                                    <div id="gcode-print-time" class="output-value text-yellow-400">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400 self-end">min</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Material Used</div>
                                    <div id="gcode-material" class="output-value text-green-400">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400 self-end">g</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Layer Count</div>
                                    <div id="gcode-layers" class="output-value text-blue-400">...</div>
                                </div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Total Lines</div>
                                    <div id="gcode-lines" class="output-value text-purple-400">...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h3 class="text-lg font-semibold text-white mb-2">Feature Breakdown</h3>
                            <div id="gcode-feature-breakdown" class="space-y-2">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Optimization Suggestions -->
                    <div id="gcode-suggestions-panel" class="simulator-card hidden">
                        <h2 class="text-xl font-semibold text-green-400 mb-4">AI Optimization Suggestions</h2>
                        <ul id="gcode-suggestions-list" class="list-disc list-inside text-gray-300 text-sm space-y-2">
                            <!-- Will be populated by JS -->
                        </ul>
                        
                        <div id="gcode-warnings" class="mt-4 hidden">
                            <h3 class="text-lg font-semibold text-yellow-400 mb-2">⚠️ Warnings</h3>
                            <ul id="gcode-warnings-list" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                <!-- Will be populated by JS -->
                            </ul>
                        </div>
                    </div>

                    <!-- v11: STL Mesh Quality Analysis -->
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">STL Mesh Quality Analysis</h2>
                        <p class="text-gray-400 text-sm mb-4">
                            Upload an STL file to analyze mesh quality and detect potential slicing issues before printing.
                        </p>
                        <div id="stl-dropzone" class="border-2 border-dashed border-gray-600 rounded-lg p-4 mb-3 text-gray-400 text-sm hover:border-blue-500 transition-colors">
                            <p class="mb-2">Drag & drop your .stl here, or click to select.</p>
                            <input type="file" id="stlAnalysisFile" accept=".stl" class="hidden" />
                            <button id="stlSelectBtn" class="mt-2 bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded">Choose STL File</button>
                            <div id="stl-file-meta" class="mt-2 text-xs text-gray-500"></div>
                        </div>

                        <div class="mb-3">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="compare-with-gcode" class="form-checkbox h-4 w-4 text-blue-600" />
                                <span class="text-sm text-gray-300">Compare with loaded G-code (calculate deviation)</span>
                            </label>
                        </div>
                        
                        <button id="analyzeStlBtn"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                            Analyze STL Mesh
                        </button>
                        
                        <div id="stl-analysis-spinner" class="hidden text-center text-gray-400 mt-4">
                            <svg class="animate-spin h-5 w-5 text-purple-500 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p class="mt-2">Analyzing STL mesh...</p>
                        </div>
                        
                        <div id="stl-error-message"
                            class="hidden text-center text-red-400 p-3 mt-4 bg-red-900 bg-opacity-30 rounded-lg">
                            <p class="font-bold">Analysis Failed</p>
                            <p id="stl-error-text" class="text-sm">Error details here.</p>
                        </div>
                    </div>

                    <!-- STL Analysis Results -->
                    <div id="stl-results-panel" class="simulator-card hidden">
                        <h2 class="text-xl font-semibold text-white mb-4">Mesh Quality Results</h2>
                        
                        <!-- Quality Score Badge -->
                        <div class="mb-4 text-center">
                            <div class="inline-block">
                                <div class="text-sm text-gray-400 mb-1">Overall Quality Score</div>
                                <div id="stl-quality-score" class="text-5xl font-bold" style="color: #10b981;">95</div>
                                <div class="text-sm text-gray-400">/ 100</div>
                            </div>
                        </div>

                        <!-- Mesh Statistics -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-xs text-gray-400">Vertices</div>
                                <div id="stl-vertices" class="text-lg font-semibold text-white">-</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-xs text-gray-400">Faces</div>
                                <div id="stl-faces" class="text-lg font-semibold text-white">-</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-xs text-gray-400">Volume</div>
                                <div id="stl-volume" class="text-lg font-semibold text-white">-</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-xs text-gray-400">Surface Area</div>
                                <div id="stl-area" class="text-lg font-semibold text-white">-</div>
                            </div>
                        </div>

                        <!-- Quality Indicators -->
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center justify-between bg-gray-800 rounded p-2">
                                <span class="text-sm text-gray-300">Watertight</span>
                                <span id="stl-watertight" class="text-sm font-semibold">-</span>
                            </div>
                            <div class="flex items-center justify-between bg-gray-800 rounded p-2">
                                <span class="text-sm text-gray-300">Manifold</span>
                                <span id="stl-manifold" class="text-sm font-semibold">-</span>
                            </div>
                            <div class="flex items-center justify-between bg-gray-800 rounded p-2">
                                <span class="text-sm text-gray-300">Triangle Quality (mean)</span>
                                <span id="stl-tri-quality" class="text-sm font-semibold">-</span>
                            </div>
                            <div class="flex items-center justify-between bg-gray-800 rounded p-2">
                                <span class="text-sm text-gray-300">Aspect Ratio (max)</span>
                                <span id="stl-aspect-ratio" class="text-sm font-semibold">-</span>
                            </div>
                        </div>

                        <!-- G-code Comparison (if available) -->
                        <div id="stl-gcode-comparison" class="hidden mt-4 p-3 bg-blue-900 bg-opacity-30 rounded">
                            <h3 class="text-sm font-semibold text-blue-300 mb-2">G-code Deviation Analysis</h3>
                            <div class="space-y-1 text-sm text-gray-300">
                                <div class="flex justify-between">
                                    <span>Max Deviation:</span>
                                    <span id="stl-hausdorff" class="font-semibold">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Mean Deviation:</span>
                                    <span id="stl-mean-dev" class="font-semibold">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Accuracy:</span>
                                    <span id="stl-accuracy" class="font-semibold">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Warnings and Recommendations -->
                        <div id="stl-warnings" class="mt-4 hidden">
                            <h3 class="text-sm font-semibold text-yellow-400 mb-2">⚠️ Warnings</h3>
                            <ul id="stl-warnings-list" class="list-disc list-inside text-xs text-gray-300 space-y-1">
                            </ul>
                        </div>
                        
                        <div id="stl-recommendations" class="mt-4 hidden">
                            <h3 class="text-sm font-semibold text-green-400 mb-2">💡 Recommendations</h3>
                            <ul id="stl-recommendations-list" class="list-disc list-inside text-xs text-gray-300 space-y-1">
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Column 2: 3D Toolpath Visualization -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Toolpath Visualization</h2>
                        <p class="text-gray-400 text-sm mb-4">
                            3D visualization of actual print toolpaths, color-coded by feature type.
                        </p>
                        <!-- Layer Scrubber -->
                        <div class="mb-3 flex items-center gap-3">
                            <label for="gcode-layer-slider" class="text-sm text-gray-300 whitespace-nowrap">Layer</label>
                            <input id="gcode-layer-slider" type="range" min="0" max="0" value="0" class="w-full">
                            <div id="gcode-layer-label" class="text-sm text-gray-300 w-24 text-right">0 / 0</div>
                        </div>
                        <div id="gcodeVisualizationCanvas" style="width: 100%; height: 500px; border-radius: 0.5rem; background-color: #1f2937;">
                        </div>
                        
                        <!-- Legend -->
                        <div class="mt-4 grid grid-cols-3 gap-2 text-xs">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-3 w-3" data-feature="outer_wall" checked />
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: #ef4444;"></span><span class="text-gray-300">Outer Wall</span></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-3 w-3" data-feature="inner_wall" checked />
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: #f59e0b;"></span><span class="text-gray-300">Inner Wall</span></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-3 w-3" data-feature="infill" checked />
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: #3b82f6;"></span><span class="text-gray-300">Infill</span></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-3 w-3" data-feature="top_surface" checked />
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: #10b981;"></span><span class="text-gray-300">Top Surface</span></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-3 w-3" data-feature="bottom_surface" checked />
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: #8b5cf6;"></span><span class="text-gray-300">Bottom Surface</span></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-3 w-3" data-feature="support" checked />
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: #ec4899;"></span><span class="text-gray-300">Support</span></span>
                            </label>
                        </div>

                        <div class="mt-3">
                            <button id="gcode-reset-view" class="text-xs bg-gray-700 hover:bg-gray-600 text-white py-1 px-3 rounded">Reset View</button>
                        </div>

                        <!-- Layer Scrubber & Stats -->
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-white">Layer Scrubber</h3>
                                <span id="gcode-layer-label" class="text-xs text-gray-400">0 / 0</span>
                            </div>
                            <input id="gcode-layer-slider" type="range" min="0" max="0" value="0" class="w-full">
                            <div class="mt-2 grid grid-cols-2 gap-2 text-xs text-gray-300">
                                <div>Segments: <span id="gcode-segment-count" class="text-blue-300">0</span></div>
                                <div class="text-right">FPS: <span id="gcode-fps" class="text-green-300">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer: References -->
        <footer class="mt-12 text-gray-500 text-xs">
            <div class="simulator-card bg-gray-900 bg-opacity-50">
                <h3 class="text-sm font-semibold text-gray-400 mb-2">Data Sources & References</h3>
                <ol class="list-decimal list-inside space-y-2">
                    <li>
                        <strong>Kaggle Model:</strong> Based on the dataset from "3D Printer (Process-Product-Property)"
                        by Afumento (2020) on Kaggle. This model predicts general mechanical and visual properties for
                        PLA/ABS.
                    </li>
                    <li>
                        <strong>C3 Model:</strong> Based on the dataset from Wang et al. (2024), "Machine learning
                        enabled 3D printing parameter settings for desired mechanical properties."
                    </li>
                    <li>
                        <strong>FEA Material Card:</strong> Based on the dataset from Lee & Tucker (2025), "Data-Driven
                        3D-Printed Material Data Prediction From Benchmark Specimens." This predicts anisotropic
                        properties for FEA software.
                    </li>
                    <li>
                        <strong>Fatigue Lifetime:</strong> Based on the dataset from Azadi & Dadashi (2022),
                        "Experimental fatigue dataset for additive-manufactured 3D-printed Polylactic acid
                        biomaterials..."
                    </li>
                    <li>
                        <strong>Dimensional Accuracy:</strong> Based on the dataset from Deswal et al. (2019), "Modeling
                        and parametric optimization of FDM 3D printing process using hybrid techniques for enhancing
                        dimensional preciseness."
                    </li>
                    <li>
                        <strong>Warp Deformation:</strong> Based on the dataset from Nazan et al. (2017), "Process
                        parameter optimization of 3D printer using response surface method."
                    </li>
                    <li>
                        <strong>Hardness:</strong> Based on the dataset from Kadam et al. (2019), "Process Parameter
                        Optimization for FDM 3D Printer."
                    </li>
                    <li>
                        <strong>Multi-Material Bond:</strong> Based on the dataset from Yadav et al. (2019),
                        "Optimization of FDM 3D printing process parameters for multi-material using artificial neural
                        network."
                    </li>
                    <li>
                        <strong>Optimization Algorithm:</strong> Uses the NSGA-II genetic algorithm, a method validated
                        for FDM optimization in research by Panico et al. (2025).
                    </li>
                </ol>
            </div>
        </footer>

    </div>

    <script type="module">
        // === 3D Viewer (three.js) ===
        let scene, camera, renderer, controls, mesh;

        function init3DViewer() {
            const canvas = document.getElementById('stlCanvas');
            if (!canvas) return;

            // 1. Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1f2937); // gray-800

            // 2. Camera
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.z = 100;

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            canvas.innerHTML = ''; // Clear canvas
            canvas.appendChild(renderer.domElement);

            // 4. Lights
            const ambientLight = new THREE.AmbientLight(0x404040, 2); // soft white light
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-1, -1, -1).normalize();
            scene.add(directionalLight2);

            // 5. Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.enableZoom = true;

            // 6. Animation Loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // 7. Resize Handler
            window.addEventListener('resize', () => {
                if (canvas.offsetParent === null) return; // Only resize if visible
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }, false);
        }

        function loadSTL(file) {
            const loader = new THREE.STLLoader();
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const geometry = loader.parse(event.target.result);

                    if (mesh) {
                        scene.remove(mesh); // Remove old mesh
                    }

                    // Create material
                    const material = new THREE.MeshStandardMaterial({
                        color: 0x3b82f6, // blue-500
                        metalness: 0.1,
                        roughness: 0.5,
                    });

                    // Create mesh
                    mesh = new THREE.Mesh(geometry, material);

                    // Center the geometry
                    geometry.computeBoundingBox();
                    const center = geometry.boundingBox.getCenter(new THREE.Vector3());
                    mesh.position.sub(center);

                    // Add to scene
                    scene.add(mesh);

                    // Zoom to fit
                    const size = geometry.boundingBox.getSize(new THREE.Vector3()).length();
                    camera.position.z = size;
                    controls.update();

                } catch (e) {
                    console.error("Error parsing STL:", e);
                    showError("Error: Could not parse the STL file. It may be corrupt or in the wrong format.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // === API & Simulation Logic ===
        const API_BASE_URL = "http://127.0.0.1:8000";
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // --- Global State ---
        let materialsDatabase = {}; // To store materials.json

        // --- Input Getters ---
        function getGlobalInputs() {
            return {
                part_mass_g: parseFloat(document.getElementById('part_mass_g').value) || 0,
                filament_cost_kg: parseFloat(document.getElementById('filament_cost_kg').value) || 0,
                material_name: document.getElementById('global_material_name').value || "Generic PLA"
            };
        }

        function getKaggleInputs() {
            return {
                ...getGlobalInputs(),
                layer_height: parseFloat(document.getElementById('layer_height').value),
                wall_thickness: parseInt(document.getElementById('wall_thickness').value),
                infill_density: parseInt(document.getElementById('infill_density').value),
                infill_pattern: document.getElementById('infill_pattern').value,
                nozzle_temperature: parseInt(document.getElementById('nozzle_temperature').value),
                bed_temperature: parseInt(document.getElementById('bed_temperature').value),
                print_speed: parseInt(document.getElementById('print_speed').value),
                material: document.getElementById('material').value,
                fan_speed: parseInt(document.getElementById('fan_speed').value),
            };
        }

        function getC3Inputs() {
            return {
                ...getGlobalInputs(),
                Temperature: parseFloat(document.getElementById('c3_Temperature').value),
                Speed: parseFloat(document.getElementById('c3_Speed').value),
                Angle: parseFloat(document.getElementById('c3_Angle').value),
                Height: parseFloat(document.getElementById('c3_Height').value),
                Fill: parseFloat(document.getElementById('c3_Fill').value),
            };
        }

        function getFEAInputs() {
            return {
                ...getGlobalInputs(),
                Material_Bonding_Perfection: parseFloat(document.getElementById('fea_Material_Bonding_Perfection').value),
                Material_Youngs_Modulus_GPa: parseFloat(document.getElementById('fea_Material_Youngs_Modulus_GPa').value),
                Material_Tensile_Yield_Strenght_MPa: parseFloat(document.getElementById('fea_Material_Tensile_Yield_Strenght_MPa').value),
                Material_Poissons_Ratio: parseFloat(document.getElementById('fea_Material_Poissons_Ratio').value),
                User_Infill_Pattern: document.getElementById('fea_User_Infill_Pattern').value,
                User_Infill_Density: parseFloat(document.getElementById('fea_User_Infill_Density').value),
                User_Line_Thickenss_mm: parseFloat(document.getElementById('fea_User_Line_Thickenss_mm').value),
                User_Layer_Height_mm: parseFloat(document.getElementById('fea_User_Layer_Height_mm').value),
            };
        }

        function getFatigueInputs() {
            return {
                ...getGlobalInputs(),
                Nozzle_Diameter: parseFloat(document.getElementById('fatigue_Nozzle_Diameter').value),
                Print_Speed: parseFloat(document.getElementById('fatigue_Print_Speed').value),
                Nozzle_Temperature: parseFloat(document.getElementById('fatigue_Nozzle_Temperature').value),
                Stress_Level: parseFloat(document.getElementById('fatigue_Stress_Level').value),
            };
        }

        function getAccuracyInputs() {
            return {
                ...getGlobalInputs(),
                Layer_Thickness_mm: parseFloat(document.getElementById('accuracy_Layer_Thickness_mm').value),
                Build_Orientation_deg: parseInt(document.getElementById('accuracy_Build_Orientation_deg').value),
                Infill_Density_percent: parseInt(document.getElementById('accuracy_Infill_Density_percent').value),
                Number_of_Contours: parseInt(document.getElementById('accuracy_Number_of_Contours').value),
            };
        }

        function getWarpageInputs() {
            return {
                ...getGlobalInputs(),
                Layer_Temperature_C: parseInt(document.getElementById('warpage_Layer_Temperature_C').value),
                Infill_Density_percent: parseInt(document.getElementById('warpage_Infill_Density_percent').value),
                First_Layer_Height_mm: parseFloat(document.getElementById('warpage_First_Layer_Height_mm').value),
                Other_Layer_Height_mm: parseFloat(document.getElementById('warpage_Other_Layer_Height_mm').value),
            };
        }

        function getHardnessInputs() {
            return {
                ...getGlobalInputs(),
                Layer_Thickness_mm: parseFloat(document.getElementById('hardness_Layer_Thickness_mm').value),
                Shell_Thickness_mm: parseFloat(document.getElementById('hardness_Shell_Thickness_mm').value),
                Fill_Density_percent: parseInt(document.getElementById('hardness_Fill_Density_percent').value),
                Fill_Pattern: document.getElementById('hardness_Fill_Pattern').value,
            };
        }

        function getMultimaterialInputs() { // v8: New
            return {
                ...getGlobalInputs(),
                Material_A: document.getElementById('multimaterial_Material_A').value,
                Material_B: document.getElementById('multimaterial_Material_B').value,
                Layer_Height_mm: parseFloat(document.getElementById('multimaterial_Layer_Height_mm').value),
                Extrusion_Temp_C: parseInt(document.getElementById('multimaterial_Extrusion_Temp_C').value),
                Infill_Density_percent: parseInt(document.getElementById('multimaterial_Infill_Density_percent').value),
            };
        }

        function getCompositeInputs() { // v9: New
            return {
                ...getGlobalInputs(),
                Reinforcement_percent: parseFloat(document.getElementById('composite_Reinforcement_percent').value),
                Infill_Pattern: document.getElementById('composite_Infill_Pattern').value,
                Infill_Density_percent: parseInt(document.getElementById('composite_Infill_Density_percent').value),
                Layer_Thickness_mm: parseFloat(document.getElementById('composite_Layer_Thickness_mm').value),
            };
        }

        // --- UI Updaters ---
        function updateGlobalOutputs(data) {
            document.getElementById('estimated_cost').textContent = `$${data.estimated_cost_usd.toFixed(2)}`;
            document.getElementById('estimated_time').textContent = data.estimated_print_time_min.toFixed(0);
        }

        function updateKaggleUI(data) {
            updateGlobalOutputs(data);
            document.getElementById('tensile_strength').textContent = data.tensile_strength.toFixed(2);
            document.getElementById('roughness').textContent = data.roughness.toFixed(2);
            document.getElementById('elongation').textContent = data.elongation.toFixed(2);
        }

        function updateC3UI(data) {
            updateGlobalOutputs(data);
            document.getElementById('c3_tensile_strength').textContent = data.Tensile_Strength_MPa.toFixed(2);
            document.getElementById('c3_elongation').textContent = data.Elongation_at_Break_percent.toFixed(2);
        }

        function updateFEAUI(data) {
            updateGlobalOutputs(data);
            const tableBody = document.getElementById('fea-results-table');
            tableBody.innerHTML = ''; // Clear old results
            for (const [key, value] of Object.entries(data.properties)) {
                const row = `
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <td class="py-2 px-4 font-medium">${key.replace(/_/g, ' ')}</td>
                        <td class="py-2 px-4 text-blue-300 font-mono">${parseFloat(value).toFixed(4)}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
        }

        function updateFatigueUI(data) {
            updateGlobalOutputs(data);
            document.getElementById('fatigue_lifetime').textContent = Math.round(data.Fatigue_Lifetime).toLocaleString();
        }

        function updateAccuracyUI(data) {
            updateGlobalOutputs(data);
            document.getElementById('var_length_percent').textContent = data.Var_Length_percent.toFixed(3);
            document.getElementById('var_width_percent').textContent = data.Var_Width_percent.toFixed(3);
            document.getElementById('var_thickness_percent').textContent = data.Var_Thickness_percent.toFixed(3);
        }

        function updateWarpageUI(data) {
            updateGlobalOutputs(data);
            document.getElementById('warpage_mm').textContent = data.Warpage_mm.toFixed(3);
        }

        function updateHardnessUI(data) {
            updateGlobalOutputs(data);
            document.getElementById('hardness_shore_d').textContent = data.Hardness_Shore_D.toFixed(1);
        }

        function updateMultimaterialUI(data) { // v8: New
            updateGlobalOutputs(data);
            document.getElementById('multimaterial_tensile_strength').textContent = data.Tensile_Strength_MPa.toFixed(2);
        }

        function updateCompositeUI(data) { // v9: New
            updateGlobalOutputs(data);
            document.getElementById('composite_Tensile_Strength_MPa').textContent = data.Tensile_Strength_MPa.toFixed(2);
            document.getElementById('composite_Elastic_Modulus_GPa').textContent = data.Elastic_Modulus_GPa.toFixed(2);
        }

        // --- Recommendation Engines ---
        function updateKaggleRecs(inputs) {
            const recQuality = [];
            const recSpeed = [];
            if (inputs.layer_height <= 0.1) recQuality.push("Low layer height is good for quality.");
            else recQuality.push("Consider lowering layer height (< 0.1mm) for better finish and strength.");
            if (inputs.infill_density > 80) recQuality.push("High infill density is great for strength.");
            else recQuality.push("Increase infill density (> 80%) for maximum strength.");
            if (inputs.print_speed < 60) recQuality.push("Low print speed improves layer adhesion.");
            else recQuality.push("Reduce print speed (< 60mm/s) to increase strength.");
            if (inputs.layer_height > 0.2) recSpeed.push("High layer height is great for speed.");
            else recSpeed.push("Increase layer height (> 0.2mm) to reduce print time.");
            if (inputs.infill_density < 30) recSpeed.push("Low infill density saves time and material.");
            else recSpeed.push("Lower infill density (< 30%) for faster, cheaper prints (if strength is not critical).");
            document.getElementById('kaggle-rec-quality').innerHTML = recQuality.map(rec => `<li>${rec}</li>`).join('');
            document.getElementById('kaggle-rec-speed').innerHTML = recSpeed.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateC3Recs(inputs) {
            const recStrength = [];
            if (inputs.Temperature > 210) recStrength.push("High nozzle temp (> 210°C) is good for strength.");
            else recStrength.push("Increase nozzle temp (> 210°C) for better layer bonding.");
            if (inputs.Fill > 90) recStrength.push("High infill density (> 90%) maximizes strength.");
            else recStrength.push("Increase infill density for higher strength.");
            document.getElementById('c3-rec-strength').innerHTML = recStrength.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateFatigueRecs(inputs) {
            const recLife = [];
            if (inputs.Nozzle_Temperature > 220) recLife.push("High nozzle temp (> 220°C) improves layer bonding, increasing fatigue life.");
            else recLife.push("Increase nozzle temp (> 220°C) for significantly better durability.");
            if (inputs.Print_Speed < 8) recLife.push("Low print speed (< 8 mm/s) allows better layer fusion.");
            else recLife.push("Reduce print speed (< 8 mm/s) to maximize fatigue life.");
            document.getElementById('fatigue-rec-life').innerHTML = recLife.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateAccuracyRecs(inputs) {
            const recAccuracy = [];
            if (inputs.Layer_Thickness_mm > 0.2) recAccuracy.push("Thicker layers (> 0.2mm) can increase dimensional error.");
            else recAccuracy.push("Low layer thickness (≤ 0.2mm) is good for accuracy.");
            if (inputs.Build_Orientation_deg === 0) recAccuracy.push("A 0° orientation (aligned with X-axis) often gives the lowest length error.");
            document.getElementById('accuracy-rec-quality').innerHTML = recAccuracy.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateWarpageRecs(inputs) {
            const recWarpage = [];
            if (inputs.Layer_Temperature_C > 200) recWarpage.push("Higher nozzle temps (> 200°C) increase thermal stress and warping.");
            else recWarpage.push("Lower nozzle temps (≤ 200°C) help reduce warping.");
            if (inputs.Infill_Density_percent > 20) recWarpage.push("Higher infill density increases internal tension and warping.");
            else recWarpage.push("Low infill (≤ 20%) is recommended to minimize warping.");
            document.getElementById('warpage-rec-quality').innerHTML = recWarpage.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateHardnessRecs(inputs) {
            const recHardness = [];
            if (inputs.Fill_Density_percent < 80) recHardness.push("Increase fill density (> 80%) for maximum hardness.");
            else recHardness.push("High fill density (80%) is ideal for hardness.");
            if (inputs.Shell_Thickness_mm < 1.6) recHardness.push("A thicker shell (1.6mm) improves surface hardness.");
            else recHardness.push("High shell thickness (1.6mm) is ideal.");
            document.getElementById('hardness-rec-quality').innerHTML = recHardness.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateMultimaterialRecs(inputs) { // v8: New
            const recStrength = [];
            if (inputs.Extrusion_Temp_C < 250) recStrength.push("Increase extrusion temp (250°C) to maximize the bond between ABS and PETG.");
            else recStrength.push("High extrusion temp (250°C) is ideal for ABS/PETG bonding.");
            if (inputs.Infill_Density_percent < 100) recStrength.push("A 100% infill density creates the strongest possible bond.");
            else recStrength.push("100% infill is ideal for bond strength.");
            document.getElementById('multimaterial-rec-quality').innerHTML = recStrength.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateCompositeRecs(inputs) { // v9: New
            const recs = [];
            if (inputs.Reinforcement_percent < 20) {
                recs.push("Increase carbon fiber content (≥ 20%) for significantly higher stiffness and tensile modulus.");
            }
            if (inputs.Layer_Thickness_mm > 0.2) {
                recs.push("Use thinner layers (≤ 0.2mm) to improve interlayer bonding in composites.");
            }
            if (inputs.Infill_Pattern === 'Gyroid') {
                recs.push("Gyroid pattern provides good strength with moderate material usage.");
            }
            if (inputs.Infill_Density_percent < 50) {
                recs.push("Increase infill density (≥ 50%) for better mechanical properties in composite parts.");
            }
            document.getElementById('composite-rec-quality').innerHTML = recs.map(rec => `<li>${rec}</li>`).join('');
        }

        // --- State Management ---
        function showSpinner() {
            spinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideSpinner() {
            spinner.classList.add('hidden');
        }

        function showError(message) {
            hideSpinner();
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // --- Main Simulation Functions ---

        // Use a debounce function to prevent spamming the API on every slider move
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- v8: Create a Simulation Map ---
        const simulationRunners = {
            "kaggle": async () => {
                const inputs = getKaggleInputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/kaggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateKaggleUI(data);
                updateKaggleRecs(inputs);
            },
            "c3": async () => {
                const inputs = getC3Inputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/c3`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateC3UI(data);
                updateC3Recs(inputs);
            },
            "fea": async () => {
                const inputs = getFEAInputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/fea`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateFEAUI(data);
            },
            "fatigue": async () => {
                const inputs = getFatigueInputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/fatigue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateFatigueUI(data);
                updateFatigueRecs(inputs);
            },
            "accuracy": async () => {
                const inputs = getAccuracyInputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/accuracy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateAccuracyUI(data);
                updateAccuracyRecs(inputs);
            },
            "warpage": async () => {
                const inputs = getWarpageInputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/warpage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateWarpageUI(data);
                updateWarpageRecs(inputs);
            },
            "hardness": async () => {
                const inputs = getHardnessInputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/hardness`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateHardnessUI(data);
                updateHardnessRecs(inputs);
            },
            "multimaterial": async () => { // v8: New
                const inputs = getMultimaterialInputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/multimaterial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateMultimaterialUI(data);
                updateMultimaterialRecs(inputs);
            },
            "composite": async () => { // v9: New
                const inputs = getCompositeInputs();
                const response = await fetchWithRetry(`${API_BASE_URL}/predict/composite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const data = await response.json();
                updateCompositeUI(data);
                updateCompositeRecs(inputs);
            }
        };

        // --- Generic Simulation Runner ---
        const debouncedSimRunners = {};
        for (const key in simulationRunners) {
            debouncedSimRunners[key] = debounce(runSimulation, 300);
        }

        async function runSimulation() {
            const selectedModel = document.getElementById('modelSelector').value;
            if (!simulationRunners[selectedModel]) return;

            showSpinner();
            try {
                await simulationRunners[selectedModel]();
                hideSpinner();
                hideError();
            } catch (error) {
                console.error("Simulation failed:", error);
                showError(`Error: ${error.message}. Is the server running?`);
            }
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 500) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || `HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * (i + 1)));
                }
            }
        }

        // --- Model Switching Logic ---
        const modelSelector = document.getElementById('modelSelector');
        const paramContainers = document.querySelectorAll('.model-params');
        const outputContainers = document.querySelectorAll('.model-outputs');
        const recContainers = document.querySelectorAll('.model-recs');
        const gcodeParserContainer = document.getElementById('gcode-parser-container');

        function switchModel(selectedModel) {
            // Hide all containers
            [...paramContainers, ...outputContainers, ...recContainers].forEach(el => el.classList.add('hidden'));

            // Hide GCode parser by default
            gcodeParserContainer.classList.add('hidden');
            hideError();

            // Show containers for the selected model
            document.getElementById(`${selectedModel}-params`).classList.remove('hidden');
            document.getElementById(`${selectedModel}-outputs`).classList.remove('hidden');
            document.getElementById(`${selectedModel}-recs`).classList.remove('hidden');

            // Show GCode parser for Kaggle AND C3
            if (selectedModel === 'kaggle' || selectedModel === 'c3') {
                gcodeParserContainer.classList.remove('hidden');
            }

            // Init 3D viewer if needed
            if (selectedModel === 'fea' && !scene) {
                init3DViewer();
            }

            // Run the simulation for the selected model
            runSimulation();
        }

        modelSelector.addEventListener('change', (e) => switchModel(e.target.value));

        // --- G-Code Parsing ---
        document.getElementById('parseGcodeBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('gcodeFile');
            if (fileInput.files.length === 0) {
                alert("Please select a .gcode file first.");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                const gcode = e.target.result;
                const selectedModel = modelSelector.value;

                try {
                    // Refactored: Parse all params once
                    const params = parseUnifiedOrcaSlicerGcode(gcode);
                    console.log("Parsed all G-Code params:", params);

                    // Route to the correct setter
                    if (selectedModel === 'kaggle') {
                        setKaggleInputs(params);
                        runSimulation(); // Re-run simulation
                    } else if (selectedModel === 'c3') {
                        setC3Inputs(params);
                        runSimulation(); // Re-run simulation
                    }
                } catch (error) {
                    console.error("G-Code parsing error:", error);
                    alert(`Failed to parse G-Code: ${error.message}`);
                }
            };

            reader.readAsText(file);
        });

        // Refactored: Unified G-Code Parser
        function parseUnifiedOrcaSlicerGcode(gcode) {
            const params = {};
            const lines = gcode.split('\n');

            const patterns = {
                // Kaggle Params
                layer_height: /; layer_height = ([\d.]+)/,
                wall_thickness: /; wall_loops = (\d+)/,
                infill_density: /; sparse_infill_density = ([\d.]+)%/,
                infill_pattern: /; sparse_infill_pattern = (\w+)/,
                nozzle_temperature: /; nozzle_temperature = (\d+)/,
                bed_temperature: /; bed_temperature = (\d+)/,
                print_speed: /; outer_wall_speed = ([\d.]+)/,
                material: /; filament_type = (\w+)/,
                fan_speed: /; fan_speed = (\d+)/,
                // C3 Params
                Angle: /; sparse_infill_angle = (\d+)/,
            };

            for (const line of lines) {
                if (!line.startsWith(';')) continue;
                for (const [key, regex] of Object.entries(patterns)) {
                    const match = line.match(regex);
                    if (match && !params[key]) params[key] = match[1];
                }
            }

            // Map material type
            if (params.material) {
                if (params.material.toLowerCase().includes('pla')) params.material = 'pla';
                else if (params.material.toLowerCase().includes('abs')) params.material = 'abs';
            }

            if (Object.keys(params).length < 3) { // Just a basic check
                console.warn("Could not find many parameters. Is this an OrcaSlicer G-Code file?");
            }
            return params;
        }

        // Helper to set slider and text value
        const setSlider = (id, value) => {
            const slider = document.getElementById(id);
            if (slider) {
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                // Clamp value to slider's min/max range
                const clampedValue = Math.max(min, Math.min(max, parseFloat(value)));
                if (isNaN(clampedValue)) return; // Skip if value is not a number

                slider.value = clampedValue;
                const valEl = document.getElementById(`${id}_val`);
                if (valEl) valEl.textContent = clampedValue;
            } else {
                console.warn(`Slider with id ${id} not found.`);
            }
        };

        // Helper to set select value
        const setSelect = (id, value) => {
            const select = document.getElementById(id);
            if (select) {
                const option = Array.from(select.options).find(opt => value.toLowerCase().includes(opt.value.toLowerCase()));
                if (option) select.value = option.value;
                else console.warn(`Could not find matching option for ${id}: ${value}`);
            }
        };

        // Updated Input Setters (pull from unified params)
        function setKaggleInputs(params) {
            if (params.layer_height) setSlider('layer_height', params.layer_height);
            if (params.wall_thickness) setSlider('wall_thickness', params.wall_thickness);
            if (params.infill_density) setSlider('infill_density', params.infill_density);
            if (params.nozzle_temperature) setSlider('nozzle_temperature', params.nozzle_temperature);
            if (params.bed_temperature) setSlider('bed_temperature', params.bed_temperature);
            if (params.print_speed) setSlider('print_speed', params.print_speed);
            if (params.fan_speed) setSlider('fan_speed', params.fan_speed);
            if (params.infill_pattern) setSelect('infill_pattern', params.infill_pattern);

            if (params.material) {
                // Set the hidden input
                document.getElementById('material').value = params.material;
                // Set the visible dropdown
                const dbSelect = document.getElementById('kaggle_material_database');
                const option = Array.from(dbSelect.options).find(opt => params.material.toLowerCase().includes(opt.value.toLowerCase()));
                if (option) dbSelect.value = option.value;
                else dbSelect.value = ""; // Not a known material
            }
        }

        function setC3Inputs(params) {
            if (params.nozzle_temperature) setSlider('c3_Temperature', params.nozzle_temperature);
            if (params.print_speed) setSlider('c3_Speed', params.print_speed);
            if (params.Angle) setSlider('c3_Angle', params.Angle);
            if (params.layer_height) setSlider('c3_Height', params.layer_height);
            if (params.infill_density) setSlider('c3_Fill', params.infill_density);
        }

        // --- Material Database Logic ---
        async function loadMaterials() {
            try {
                const response = await fetchWithRetry(`${API_BASE_URL}/materials`);
                materialsDatabase = await response.json();

                // Get all select dropdowns
                const globalSelect = document.getElementById('global_material_name');
                const kaggleSelect = document.getElementById('kaggle_material_database');
                const feaSelect = document.getElementById('fea_material_database');
                const fatigueSelect = document.getElementById('fatigue_material_database');

                // Clear existing options (except placeholder)
                globalSelect.innerHTML = '';
                kaggleSelect.innerHTML = '<option value="">-- Select Material --</option>';
                feaSelect.innerHTML = '<option value="">-- Select Material --</option>';
                fatigueSelect.innerHTML = '<option value="">-- Select Material --</option>';

                // Populate all dropdowns
                for (const materialName of Object.keys(materialsDatabase)) {
                    const option = new Option(materialName, materialName);
                    globalSelect.add(option.cloneNode(true)); // Add all to global selector

                    const materialData = materialsDatabase[materialName];
                    if (materialData.common && (materialName.toLowerCase().includes('pla') || materialName.toLowerCase().includes('abs'))) {
                        kaggleSelect.add(option.cloneNode(true));
                    }
                    if (materialData.fea) {
                        feaSelect.add(option.cloneNode(true));
                    }
                    if (materialData.fatigue) {
                        fatigueSelect.add(option.cloneNode(true));
                    }
                }
            } catch (error) {
                console.error("Failed to load materials database:", error);
                // Don't show a blocking error, just log it
            }
        }

        // Add listeners for the new material dropdowns
        document.getElementById('kaggle_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName]) return;

            const data = materialsDatabase[materialName].common;
            const materialType = materialName.toLowerCase().includes('pla') ? 'pla' : 'abs';

            // Set hidden material field
            document.getElementById('material').value = materialType;

            // Set sliders
            if (data.bed_temperature) setSlider('bed_temperature', data.bed_temperature);
            if (data.nozzle_temperature) setSlider('nozzle_temperature', data.nozzle_temperature);
            if (data.print_speed) setSlider('print_speed', data.print_speed);
            if (data.fan_speed) setSlider('fan_speed', data.fan_speed);

            debouncedSimRunners['kaggle'](); // Re-run simulation
        });

        document.getElementById('fea_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName] || !materialsDatabase[materialName].fea) return;

            const data = materialsDatabase[materialName].fea;
            if (data.Material_Youngs_Modulus_GPa) setSlider('fea_Material_Youngs_Modulus_GPa', data.Material_Youngs_Modulus_GPa);
            if (data.Material_Tensile_Yield_Strenght_MPa) setSlider('fea_Material_Tensile_Yield_Strenght_MPa', data.Material_Tensile_Yield_Strenght_MPa);
            if (data.Material_Poissons_Ratio) setSlider('fea_Material_Poissons_Ratio', data.Material_Poissons_Ratio);

            debouncedSimRunners['fea'](); // Re-run simulation
        });

        document.getElementById('fatigue_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName] || !materialsDatabase[materialName].fatigue) return;

            const data = materialsDatabase[materialName].fatigue;
            if (data.Nozzle_Temperature) setSlider('fatigue_Nozzle_Temperature', data.Nozzle_Temperature);
            if (data.Print_Speed) setSlider('fatigue_Print_Speed', data.Print_Speed);
            if (data.Nozzle_Diameter) setSlider('fatigue_Nozzle_Diameter', data.Nozzle_Diameter);

            debouncedSimRunners['fatigue'](); // Re-run simulation
        });

        // --- Event Listeners ---

        // Global inputs listener
        ['part_mass_g', 'filament_cost_kg', 'global_material_name'].forEach(id => {
            document.getElementById(id).addEventListener('input', runSimulation);
        });

        // Add listeners for all sliders and selects
        const allInputs = document.querySelectorAll('input[type="range"], select');
        allInputs.forEach(input => {
            // Check if it's one of the new database selects or global, if so, skip it
            if (input.id.includes('_material_database') || input.id.includes('global_')) return;
            if (input.id === 'modelSelector' || input.id === 'optimizerModelSelector') return; // Skip tab/model selectors

            input.addEventListener('input', () => {
                // Update text for sliders
                if (input.type === 'range') {
                    const valEl = document.getElementById(`${input.id}_val`);
                    if (valEl) valEl.textContent = input.value;
                }

                // Special case for Kaggle material: set hidden input
                if (input.id === 'material') {
                    document.getElementById('material').value = input.value;
                }

                // Trigger the correct simulation
                const selectedModel = modelSelector.value;
                if (debouncedSimRunners[selectedModel]) {
                    debouncedSimRunners[selectedModel]();
                }
            });
        });

        // STL file loader
        document.getElementById('stlFile').addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                loadSTL(event.target.files[0]);
            }
        });

        // --- Tab Switching Logic ---
        const tabs = document.querySelectorAll('[role="tab"]');
        const panels = document.querySelectorAll('[role="tabpanel"]');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
                tab.setAttribute('aria-selected', 'true');

                const panelId = tab.id.replace('tab-', 'panel-');
                panels.forEach(p => {
                    if (p.id === panelId) {
                        p.removeAttribute('hidden');
                        if (panelId === 'panel-gcode') {
                            // Initialize the G-code visualization when tab is shown
                            initGcodeVisualization();
                        }
                    } else {
                        p.setAttribute('hidden', 'true');
                    }
                });
            });
        });

        // --- v4: Optimizer Logic ---

        const optimizerModelSelector = document.getElementById('optimizerModelSelector');
        const objectivesContainer = document.getElementById('optimizerObjectivesContainer');
        const constraintsContainer = document.getElementById('optimizerConstraintsContainer');
        const addConstraintBtn = document.getElementById('addConstraintBtn');
        const runOptimizerBtn = document.getElementById('runOptimizerBtn');
        const optimizerSpinner = document.getElementById('optimizerSpinner');
        const optimizerBtnText = document.getElementById('optimizerBtnText');
        const optimizerError = document.getElementById('optimizer-error-message');
        const optimizerErrorText = document.getElementById('optimizer-error-text');
        const resultsHeader = document.getElementById('optimizerResultsHeader');
        const resultsBody = document.getElementById('optimizerResultsBody');

        // Define available objectives and parameters for optimization
        const optimizerConfig = {
            "kaggle": {
                objectives: [
                    { id: "tensile_strength", name: "Tensile Strength (MPa)", defaultGoal: "maximize" },
                    { id: "roughness", name: "Roughness (µm)", defaultGoal: "minimize" },
                    { id: "elongation", name: "Elongation (%)", defaultGoal: "maximize" },
                    { id: "estimated_cost_usd", name: "Est. Cost ($)", defaultGoal: "minimize" },
                    { id: "estimated_print_time_min", name: "Est. Time (min)", defaultGoal: "minimize" }
                ],
                constraints: [
                    "layer_height", "wall_thickness", "infill_density", "nozzle_temperature",
                    "bed_temperature", "print_speed", "fan_speed"
                ]
            },
                "composite": { // v9: New
                    objectives: [
                        { id: "Tensile_Strength_MPa", name: "Tensile Strength (MPa)", defaultGoal: "maximize" },
                        { id: "Elastic_Modulus_GPa", name: "Elastic Modulus (GPa)", defaultGoal: "maximize" },
                        { id: "estimated_cost_usd", name: "Est. Cost ($)", defaultGoal: "minimize" },
                        { id: "estimated_print_time_min", name: "Est. Time (min)", defaultGoal: "minimize" }
                    ],
                    constraints: [
                        "Reinforcement_percent", "Infill_Density_percent", "Layer_Thickness_mm"
                    ]
                },
            "accuracy": {
                objectives: [
                    { id: "Var_Length_percent", name: "Length Error (%)", defaultGoal: "minimize" },
                    { id: "Var_Width_percent", name: "Width Error (%)", defaultGoal: "minimize" },
                    { id: "Var_Thickness_percent", name: "Thickness Error (%)", defaultGoal: "minimize" },
                    { id: "estimated_cost_usd", name: "Est. Cost ($)", defaultGoal: "minimize" },
                    { id: "estimated_print_time_min", name: "Est. Time (min)", defaultGoal: "minimize" }
                ],
                constraints: [
                    "Layer_Thickness_mm", "Build_Orientation_deg", "Infill_Density_percent", "Number_of_Contours"
                ]
            },
            "warpage": {
                objectives: [
                    { id: "Warpage_mm", name: "Warpage (mm)", defaultGoal: "minimize" },
                    { id: "estimated_cost_usd", name: "Est. Cost ($)", defaultGoal: "minimize" },
                    { id: "estimated_print_time_min", name: "Est. Time (min)", defaultGoal: "minimize" }
                ],
                constraints: [
                    "Layer_Temperature_C", "Infill_Density_percent", "First_Layer_Height_mm", "Other_Layer_Height_mm"
                ]
            },
            "hardness": {
                objectives: [
                    { id: "Hardness_Shore_D", name: "Hardness (Shore D)", defaultGoal: "maximize" },
                    { id: "estimated_cost_usd", name: "Est. Cost ($)", defaultGoal: "minimize" },
                    { id: "estimated_print_time_min", name: "Est. Time (min)", defaultGoal: "minimize" }
                ],
                constraints: [
                    "Layer_Thickness_mm", "Shell_Thickness_mm", "Fill_Density_percent"
                ]
            },
            "multimaterial": { // v8: New
                objectives: [
                    { id: "Tensile_Strength_MPa", name: "Bond Strength (MPa)", defaultGoal: "maximize" },
                    { id: "estimated_cost_usd", name: "Est. Cost ($)", defaultGoal: "minimize" },
                    { id: "estimated_print_time_min", name: "Est. Time (min)", defaultGoal: "minimize" }
                ],
                constraints: [
                    "Layer_Height_mm", "Extrusion_Temp_C", "Infill_Density_percent"
                ]
            }
        };

        function populateOptimizerObjectives(modelName) {
            const config = optimizerConfig[modelName];
            if (!config) {
                objectivesContainer.innerHTML = '<p class="text-sm text-red-400">This model is not configured for optimization.</p>';
                return;
            }

            objectivesContainer.innerHTML = ''; // Clear
            config.objectives.forEach(obj => {
                const checked = (obj.id.includes('cost') || obj.id.includes('time')) ? '' : 'checked';
                const html = `
                    <div class="flex items-center justify-between bg-gray-800 p-2 rounded-lg">
                        <label for="obj-${obj.id}" class="flex items-center space-x-2 text-sm text-gray-200">
                            <input id="obj-${obj.id}" name="optimizerObjective" type="checkbox" value="${obj.id}" ${checked} class="form-checkbox h-4 w-4 bg-gray-700 border-gray-600 rounded text-blue-500 focus:ring-blue-500">
                            <span>${obj.name}</span>
                        </label>
                        <select id="goal-${obj.id}" class="bg-gray-700 border-gray-600 text-white text-xs rounded-md p-1 focus:ring-blue-500 focus:border-blue-500">
                            <option value="minimize" ${obj.defaultGoal === 'minimize' ? 'selected' : ''}>Minimize</option>
                            <option value="maximize" ${obj.defaultGoal === 'maximize' ? 'selected' : ''}>Maximize</option>
                        </select>
                    </div>
                `;
                objectivesContainer.innerHTML += html;
            });

            // Also update constraints
            populateOptimizerConstraints(modelName);
        }

        function populateOptimizerConstraints(modelName) {
            constraintsContainer.innerHTML = ''; // Clear
            constraintIdCounter = 0; // Reset counter

            const config = optimizerConfig[modelName];
            if (!config || config.constraints.length === 0) {
                constraintsContainer.innerHTML = '<p class="text-sm text-gray-500">No constraints available for this model.</p>';
                addConstraintBtn.classList.add('hidden');
                return;
            }

            addConstraintBtn.classList.remove('hidden');
            // Create one default constraint
            createConstraintElement(config.constraints);
        }

        let constraintIdCounter = 0;
        function createConstraintElement(paramNames) {
            const id = constraintIdCounter++;
            const div = document.createElement('div');
            div.id = `constraint-${id}`;
            div.className = "flex items-center space-x-2";

            let paramOptions = paramNames.map(p => `<option value="${p}">${p.replace(/_/g, ' ')}</option>`).join('');

            div.innerHTML = `
                <select id="constraint-name-${id}" class="flex-1 bg-gray-700 border-gray-600 text-white text-sm rounded-md p-2">
                    ${paramOptions}
                </select>
                <select id="constraint-op-${id}" class="bg-gray-700 border-gray-600 text-white text-sm rounded-md p-2">
                    <option value="lt">&lt; (Less Than)</option>
                    <option value="gt">&gt; (Greater Than)</option>
                </select>
                <input type="number" id="constraint-val-${id}" value="60" class="w-20 bg-gray-700 border-gray-600 text-white text-sm rounded-md p-2">
                <button data-id="${id}" class="removeConstraintBtn text-red-400 hover:text-red-300 p-1 rounded-full">&times;</button>
            `;
            constraintsContainer.appendChild(div);

            // Add listener to new remove button
            div.querySelector('.removeConstraintBtn').addEventListener('click', (e) => {
                const idToRemove = e.target.dataset.id;
                document.getElementById(`constraint-${idToRemove}`).remove();
            });
        }

        addConstraintBtn.addEventListener('click', () => {
            const modelName = optimizerModelSelector.value;
            const config = optimizerConfig[modelName];
            if (config) createConstraintElement(config.constraints);
        });

        optimizerModelSelector.addEventListener('change', (e) => {
            populateOptimizerObjectives(e.target.value);
        });

        function getOptimizerSettings() {
            const modelName = optimizerModelSelector.value;

            // 1. Get Objectives
            const objectives = [];
            document.querySelectorAll('input[name="optimizerObjective"]:checked').forEach(cb => {
                const name = cb.value;
                const goal = document.getElementById(`goal-${name}`).value;
                objectives.push({ name, goal });
            });

            // 2. Get Constraints
            const constraints = [];
            document.querySelectorAll('[id^="constraint-name-"]').forEach(select => {
                const id = select.id.split('-').pop();
                const name = select.value;
                const operator = document.getElementById(`constraint-op-${id}`).value;
                const value = parseFloat(document.getElementById(`constraint-val-${id}`).value);
                if (!isNaN(value)) {
                    constraints.push({ name, operator, value });
                }
            });

            // 3. Get Global Inputs
            const globalInputs = getGlobalInputs();

            return { model_name: modelName, objectives, constraints, global_inputs: globalInputs };
        }

        runOptimizerBtn.addEventListener('click', async () => {
            const settings = getOptimizerSettings();

            if (settings.objectives.length === 0) {
                alert("Please select at least one objective to optimize.");
                return;
            }

            // Show spinner
            optimizerSpinner.classList.remove('hidden');
            optimizerBtnText.textContent = "Optimizing... (this may take a minute)";
            runOptimizerBtn.disabled = true;
            optimizerError.classList.add('hidden');
            resultsBody.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-gray-500">Running genetic algorithm...</td></tr>`;

            try {
                const response = await fetchWithRetry(`${API_BASE_URL}/optimize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const results = await response.json();
                displayOptimizerResults(results, settings);

            } catch (error) {
                console.error("Optimizer failed:", error);
                optimizerErrorText.textContent = `Error: ${error.message}. Is the server running?`;
                optimizerError.classList.remove('hidden');
                resultsBody.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-red-400">Optimization failed.</td></tr>`;
            } finally {
                // Hide spinner
                optimizerSpinner.classList.add('hidden');
                optimizerBtnText.textContent = "Find Optimal Settings";
                runOptimizerBtn.disabled = false;
            }
        });

        function displayOptimizerResults(results, settings) {
            if (results.length === 0) {
                resultsBody.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-gray-500">No solutions found.</td></tr>`;
                return;
            }

            const allInputKeys = Object.keys(results[0].inputs);
            const allOutputKeys = Object.keys(results[0].outputs);

            // Create Header
            let headerHtml = '';
            allOutputKeys.forEach(key => headerHtml += `<th scope="col" class="py-3 px-4 text-blue-300">${key.replace(/_/g, ' ')}</th>`);
            allInputKeys.forEach(key => headerHtml += `<th scope="col" class="py-3 px-4">${key.replace(/_/g, ' ')}</th>`);
            resultsHeader.innerHTML = `<tr>${headerHtml}</tr>`;

            // Create Body
            let bodyHtml = '';
            results.forEach(res => {
                bodyHtml += `<tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">`;
                // Add output values
                allOutputKeys.forEach(key => {
                    bodyHtml += `<td class="py-2 px-4 font-medium text-blue-300">${res.outputs[key]}</td>`;
                });
                // Add input values
                allInputKeys.forEach(key => {
                    bodyHtml += `<td class="py-2 px-4">${res.inputs[key]}</td>`;
                });
                bodyHtml += `</tr>`;
            });
            resultsBody.innerHTML = bodyHtml;
        }

            // ===== G-Code Analysis (v9) =====
    let gcodeScene, gcodeCamera, gcodeRenderer, gcodeControls;
    let gcodeContainer, gcodeBounds, gcodeCenter, gcodeMaxDim;
        let gcodeOriginalSegments = [];
    let gcodeLayerMax = 0;
    let gcodeLastTime = 0, gcodeFpsEma = 0;
        let gcodeLayersGroup = null; // parent group for all layer lines
        let gcodeLayerLines = new Map(); // layer -> THREE.Group
        let gcodeLayerFeatureLines = new Map(); // layer -> Map(feature -> [THREE.Line])
        const gcodeFeatureEnabled = {
            outer_wall: true,
            inner_wall: true,
            infill: true,
            top_surface: true,
            bottom_surface: true,
            support: true,
            unknown: true,
        };

            function initGcodeVisualization() {
                gcodeContainer = document.getElementById('gcodeVisualizationCanvas');
                if (!gcodeContainer || gcodeScene) return; // Already initialized
            
                gcodeScene = new THREE.Scene();
                gcodeScene.background = new THREE.Color(0x1f2937);
            
                gcodeCamera = new THREE.PerspectiveCamera(45, gcodeContainer.clientWidth / gcodeContainer.clientHeight, 0.1, 2000);
                gcodeCamera.position.set(100, 100, 100);
                gcodeCamera.lookAt(0, 0, 0);
            
                gcodeRenderer = new THREE.WebGLRenderer({ antialias: true });
                gcodeRenderer.setSize(gcodeContainer.clientWidth, gcodeContainer.clientHeight);
                gcodeContainer.appendChild(gcodeRenderer.domElement);
            
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                gcodeScene.add(ambientLight);
            
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                gcodeScene.add(directionalLight);
            
                const gridHelper = new THREE.GridHelper(200, 20);
                gcodeScene.add(gridHelper);
            
                const axesHelper = new THREE.AxesHelper(50);
                gcodeScene.add(axesHelper);
            
                // Orbit controls
                if (THREE.OrbitControls) {
                    gcodeControls = new THREE.OrbitControls(gcodeCamera, gcodeRenderer.domElement);
                    gcodeControls.enableDamping = true;
                    gcodeControls.dampingFactor = 0.08;
                    gcodeControls.screenSpacePanning = true;
                    gcodeControls.minDistance = 5;
                    gcodeControls.maxDistance = 2000;
                }

                // Handle window resize
                window.addEventListener('resize', onGcodeResize);

                animateGcode();
            }

            function onGcodeResize() {
                if (!gcodeContainer || !gcodeRenderer || !gcodeCamera) return;
                const w = gcodeContainer.clientWidth;
                const h = gcodeContainer.clientHeight;
                if (w === 0 || h === 0) return;
                gcodeRenderer.setSize(w, h);
                gcodeCamera.aspect = w / h;
                gcodeCamera.updateProjectionMatrix();
                // Fit camera to current bounds on resize
                if (gcodeCenter && gcodeMaxDim) fitCameraToCurrentBounds();
            }

            function animateGcode() {
                if (!gcodeRenderer || !gcodeScene || !gcodeCamera) return;
                requestAnimationFrame(animateGcode);
                if (gcodeControls) gcodeControls.update();
                // FPS
                const now = performance.now();
                if (gcodeLastTime) {
                    const dt = now - gcodeLastTime;
                    const inst = 1000 / dt;
                    gcodeFpsEma = gcodeFpsEma * 0.9 + inst * 0.1;
                    const fpsEl = document.getElementById('gcode-fps');
                    if (fpsEl) fpsEl.textContent = String(Math.round(gcodeFpsEma));
                }
                gcodeLastTime = now;
                gcodeRenderer.render(gcodeScene, gcodeCamera);
            }

            function fitCameraToCurrentBounds() {
                if (!gcodeCenter || !gcodeMaxDim || !gcodeCamera || !gcodeControls) return;
                gcodeCamera.position.set(
                    gcodeCenter.x + gcodeMaxDim * 1.5,
                    gcodeCenter.y + gcodeMaxDim * 1.5,
                    gcodeCenter.z + gcodeMaxDim * 1.5
                );
                gcodeCamera.lookAt(gcodeCenter);
                gcodeControls.target.copy(gcodeCenter);
            }

            function renderToolpaths(segments) {
                if (!gcodeScene) initGcodeVisualization();

                // Build or update grouped layer lines
                buildLayerLines(segments);

                const featureColors = {
                    'outer_wall': 0xef4444,    // red
                    'inner_wall': 0xf59e0b,    // orange
                    'infill': 0x3b82f6,        // blue
                    'top_surface': 0x10b981,   // green
                    'bottom_surface': 0x8b5cf6, // purple
                    'support': 0xec4899,       // pink
                    'unknown': 0x6b7280        // gray
                };
            
                if (!segments || segments.length === 0) return;
            
                // Store bounds and fit camera
                const allPoints = segments.map(seg => new THREE.Vector3(seg.x, seg.z, seg.y));
                gcodeBounds = new THREE.Box3().setFromPoints(allPoints);
                gcodeCenter = gcodeBounds.getCenter(new THREE.Vector3());
                const size = gcodeBounds.getSize(new THREE.Vector3());
                gcodeMaxDim = Math.max(size.x, size.y, size.z);
                if (gcodeControls) gcodeControls.target.copy(gcodeCenter);
                fitCameraToCurrentBounds();
                const segCountEl = document.getElementById('gcode-segment-count');
                if (segCountEl) segCountEl.textContent = String(segments.length);
            }

            function buildLayerLines(segments) {
                if (!gcodeScene) return;
                if (!gcodeLayersGroup) {
                    gcodeLayersGroup = new THREE.Group();
                    gcodeScene.add(gcodeLayersGroup);
                }
                // Clear previous
                gcodeLayersGroup.clear();
                gcodeLayerLines.clear();
                gcodeLayerFeatureLines.clear();
                if (!segments || segments.length === 0) return;

                const colorMap = {
                    'outer_wall': 0xef4444,
                    'inner_wall': 0xf59e0b,
                    'infill': 0x3b82f6,
                    'top_surface': 0x10b981,
                    'bottom_surface': 0x8b5cf6,
                    'support': 0xec4899,
                    'unknown': 0x6b7280
                };

                // Group segments by layer and feature
                const layers = new Map(); // layer -> feature -> points array
                segments.forEach(seg => {
                    const layer = (seg.layer ?? 0);
                    const type = (seg.type || seg.feature_type) || 'unknown';
                    if (!layers.has(layer)) layers.set(layer, new Map());
                    const featMap = layers.get(layer);
                    if (!featMap.has(type)) featMap.set(type, []);
                    featMap.get(type).push(new THREE.Vector3(seg.x, seg.z, seg.y));
                });

                // Build lines per layer/feature
                layers.forEach((featMap, layer) => {
                    const layerGroup = new THREE.Group();
                    const featureMap = new Map();
                    featMap.forEach((points, type) => {
                        if (points.length < 2) return;
                        const geometry = new THREE.BufferGeometry().setFromPoints(points);
                        const material = new THREE.LineBasicMaterial({ color: colorMap[type] || colorMap['unknown'], linewidth: 2 });
                        const line = new THREE.Line(geometry, material);
                        layerGroup.add(line);
                        if (!featureMap.has(type)) featureMap.set(type, []);
                        featureMap.get(type).push(line);
                    });
                    layerGroup.visible = true;
                    gcodeLayersGroup.add(layerGroup);
                    gcodeLayerLines.set(layer, layerGroup);
                    gcodeLayerFeatureLines.set(layer, featureMap);
                });
            }

            function applyVisibility(maxLayer) {
                gcodeLayerFeatureLines.forEach((featMap, layer) => {
                    const layerVisible = (layer <= maxLayer);
                    featMap.forEach((lines, feature) => {
                        const featVisible = !!gcodeFeatureEnabled[feature];
                        lines.forEach(line => line.visible = layerVisible && featVisible);
                    });
                });
            }

            function filterSegmentsUpToLayer(segments, layer) {
                if (segments.length === 0) return segments;
                // Prefer explicit layer index if present, else infer by Z ranking
                if (segments[0].layer !== undefined) {
                    return segments.filter(s => (s.layer || 0) <= layer);
                }
                // Fallback: infer layers by unique Z values
                const uniqueZ = Array.from(new Set(segments.map(s => s.z))).sort((a,b) => a-b);
                const zThreshold = uniqueZ[Math.min(layer, uniqueZ.length - 1)] ?? uniqueZ[uniqueZ.length - 1];
                return segments.filter(s => s.z <= zThreshold);
            }

        function displayGCodeAnalysis(result) {
            // Show stats panel
            document.getElementById('gcode-stats-panel').classList.remove('hidden');
            document.getElementById('gcode-print-time').textContent = result.print_time_estimate_min.toFixed(1);
            document.getElementById('gcode-material').textContent = result.material_used_g.toFixed(2);
            document.getElementById('gcode-layers').textContent = result.layer_count;
            document.getElementById('gcode-lines').textContent = result.total_lines;
            
            // Setup scrubber
            gcodeOriginalSegments = result.toolpath_segments || [];
            gcodeLayerMax = result.layer_count || 0;
            const slider = document.getElementById('gcode-layer-slider');
            const label = document.getElementById('gcode-layer-label');
            slider.max = gcodeLayerMax;
            slider.value = gcodeLayerMax;
            label.textContent = `${gcodeLayerMax} / ${gcodeLayerMax}`;
            slider.oninput = () => {
                const val = parseInt(slider.value, 10) || 0;
                label.textContent = `${val} / ${gcodeLayerMax}`;
                applyVisibility(val);
                // Update counts using filtered segments and feature toggles
                const count = gcodeOriginalSegments.filter(s => (s.layer ?? 0) <= val && (gcodeFeatureEnabled[(s.type || s.feature_type) || 'unknown'] ?? true)).length;
                const segCountEl = document.getElementById('gcode-segment-count');
                if (segCountEl) segCountEl.textContent = String(count);
            };
            
            // Feature breakdown
            const breakdownDiv = document.getElementById('gcode-feature-breakdown');
            let breakdownHtml = '';
            Object.entries(result.feature_breakdown).forEach(([feature, percent]) => {
                const colorMap = {
                    'outer_wall': 'bg-red-500',
                    'inner_wall': 'bg-orange-500',
                    'infill': 'bg-blue-500',
                    'top_surface': 'bg-green-500',
                    'bottom_surface': 'bg-purple-500',
                    'support': 'bg-pink-500',
                    'unknown': 'bg-gray-500'
                };
                const color = colorMap[feature] || 'bg-gray-500';
                breakdownHtml += `
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-300">${feature.replace(/_/g, ' ')}</span>
                            <span class="text-gray-400">${percent.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="${color} h-2 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });
            breakdownDiv.innerHTML = breakdownHtml;
            
            // Optimization suggestions
            const suggestionsPanel = document.getElementById('gcode-suggestions-panel');
            suggestionsPanel.classList.remove('hidden');
            const suggestionsList = document.getElementById('gcode-suggestions-list');
            let suggestionsHtml = '';
            result.optimization_suggestions.forEach(suggestion => {
                suggestionsHtml += `<li class="text-green-300">${suggestion}</li>`;
            });
            suggestionsList.innerHTML = suggestionsHtml || '<li class="text-gray-500">No suggestions available.</li>';
            
            // Warnings
            const warningsDiv = document.getElementById('gcode-warnings');
            if (result.warnings && result.warnings.length > 0) {
                warningsDiv.classList.remove('hidden');
                const warningsList = document.getElementById('gcode-warnings-list');
                let warningsHtml = '';
                result.warnings.forEach(warning => {
                    warningsHtml += `<li class="text-yellow-300">${warning}</li>`;
                });
                warningsList.innerHTML = warningsHtml;
            } else {
                warningsDiv.classList.add('hidden');
            }
            
            // Render toolpaths (build all layers, then show all)
            if (gcodeOriginalSegments.length > 0) {
                renderToolpaths(gcodeOriginalSegments);
                applyVisibility(gcodeLayerMax);
            }
        }

    document.getElementById('analyzeGcodeBtn').addEventListener('click', async () => {
                const fileInput = document.getElementById('gcodeAnalysisFile');
                const file = fileInput.files[0];
            
                if (!file) {
                    alert('Please select a G-code file first.');
                    return;
                }
            
                const spinner = document.getElementById('gcode-analysis-spinner');
                const errorDiv = document.getElementById('gcode-error-message');
                const errorText = document.getElementById('gcode-error-text');
            
                // Hide previous results and errors
                document.getElementById('gcode-stats-panel').classList.add('hidden');
                document.getElementById('gcode-suggestions-panel').classList.add('hidden');
                errorDiv.classList.add('hidden');
            
                // Show spinner
                spinner.classList.remove('hidden');
            
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    // Optional material/diameter
                    const globalSel = document.getElementById('global_material_name');
                    const diaInput = document.getElementById('gcode-filament-diameter');
                    if (globalSel && globalSel.value) formData.append('material_name', globalSel.value);
                    if (diaInput && diaInput.value) formData.append('filament_diameter_mm', diaInput.value);
            
                    const response = await fetch(`${API_BASE_URL}/analyze_gcode`, {
                        method: 'POST',
                        body: formData
                    });
                
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `Server error: ${response.status}`);
                    }
                
                    const result = await response.json();
                    displayGCodeAnalysis(result);
                
                } catch (error) {
                    console.error('G-Code analysis failed:', error);
                    errorText.textContent = error.message || 'Unknown error occurred.';
                    errorDiv.classList.remove('hidden');
                } finally {
                    spinner.classList.add('hidden');
                }
            });

        // Drag-and-drop handlers for G-code upload
        (function initGcodeDropzone(){
            const drop = document.getElementById('gcode-dropzone');
            const input = document.getElementById('gcodeAnalysisFile');
            const choose = document.getElementById('gcodeSelectBtn');
            const meta = document.getElementById('gcode-file-meta');
            if (!drop || !input) return;
            ['dragenter','dragover','dragleave','drop'].forEach(evt => {
                drop.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            drop.addEventListener('dragover', () => drop.classList.add('border-blue-500'));
            drop.addEventListener('dragleave', () => drop.classList.remove('border-blue-500'));
            drop.addEventListener('drop', e => {
                drop.classList.remove('border-blue-500');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    input.files = e.dataTransfer.files;
                    const f = e.dataTransfer.files[0];
                    if (meta) meta.textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB`;
                }
            });
            if (choose) choose.addEventListener('click', () => input.click());
            drop.addEventListener('click', () => input.click());
            input.addEventListener('change', () => {
                if (input.files && input.files[0] && meta) {
                    const f = input.files[0];
                    meta.textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB`;
                }
            });
        })();

        // Keep G-code material display in sync with Global Material
        (function initGcodeMaterialBinding(){
            const label = document.getElementById('gcode-material-current');
            const globalSel = document.getElementById('global_material_name');
            if (!label || !globalSel) return;
            const update = () => { label.textContent = globalSel.value || 'Generic PLA'; };
            update();
            globalSel.addEventListener('change', update);
            document.addEventListener('materials-loaded', update);
        })();

        // Reset view button
        document.getElementById('gcode-reset-view').addEventListener('click', () => {
            fitCameraToCurrentBounds();
        });

        // Feature toggle checkboxes wiring
        (function initFeatureToggles(){
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-feature]');
            const slider = document.getElementById('gcode-layer-slider');
            if (!checkboxes || checkboxes.length === 0) return;
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const feature = cb.getAttribute('data-feature');
                    const enabled = cb.checked;
                    if (feature) gcodeFeatureEnabled[feature] = enabled;
                    const current = parseInt(slider?.value || '0', 10) || 0;
                    applyVisibility(current);
                    // Update segment count display
                    const count = gcodeOriginalSegments.filter(s => (s.layer ?? 0) <= current && (gcodeFeatureEnabled[(s.type || s.feature_type) || 'unknown'] ?? true)).length;
                    const segCountEl = document.getElementById('gcode-segment-count');
                    if (segCountEl) segCountEl.textContent = String(count);
                });
            });
        })();

        // ===== v11: STL Mesh Analysis =====
        
        // STL dropzone handlers
        (function initStlDropzone(){
            const drop = document.getElementById('stl-dropzone');
            const input = document.getElementById('stlAnalysisFile');
            const choose = document.getElementById('stlSelectBtn');
            const meta = document.getElementById('stl-file-meta');
            if (!drop || !input) return;
            ['dragenter','dragover','dragleave','drop'].forEach(evt => {
                drop.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            drop.addEventListener('dragover', () => drop.classList.add('border-blue-500'));
            drop.addEventListener('dragleave', () => drop.classList.remove('border-blue-500'));
            drop.addEventListener('drop', e => {
                drop.classList.remove('border-blue-500');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    input.files = e.dataTransfer.files;
                    const f = e.dataTransfer.files[0];
                    if (meta) meta.textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB`;
                }
            });
            if (choose) choose.addEventListener('click', () => input.click());
            drop.addEventListener('click', () => input.click());
            input.addEventListener('change', () => {
                if (input.files && input.files[0] && meta) {
                    const f = input.files[0];
                    meta.textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB`;
                }
            });
        })();

        // STL analysis handler
        document.getElementById('analyzeStlBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('stlAnalysisFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an STL file first.');
                return;
            }
            
            const spinner = document.getElementById('stl-analysis-spinner');
            const errorDiv = document.getElementById('stl-error-message');
            const errorText = document.getElementById('stl-error-text');
            const resultsPanel = document.getElementById('stl-results-panel');
            
            // Hide previous results and errors
            resultsPanel.classList.add('hidden');
            errorDiv.classList.add('hidden');
            
            // Show spinner
            spinner.classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                // Check if comparing with G-code
                const compareCheckbox = document.getElementById('compare-with-gcode');
                if (compareCheckbox && compareCheckbox.checked) {
                    const gcodeInput = document.getElementById('gcodeAnalysisFile');
                    if (gcodeInput.files[0]) {
                        formData.append('compare_gcode', gcodeInput.files[0]);
                    }
                }
                
                const response = await fetch(`${API_BASE_URL}/analyze_stl`, {
                    method: 'POST',
                    body: formData
                });
            
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }
            
                const result = await response.json();
                displayStlAnalysis(result);
            
            } catch (error) {
                console.error('STL analysis failed:', error);
                errorText.textContent = error.message || 'Unknown error occurred.';
                errorDiv.classList.remove('hidden');
            } finally {
                spinner.classList.add('hidden');
            }
        });

        function displayStlAnalysis(result) {
            const resultsPanel = document.getElementById('stl-results-panel');
            resultsPanel.classList.remove('hidden');
            
            const quality = result.mesh_quality;
            
            // Quality score with color
            const scoreEl = document.getElementById('stl-quality-score');
            scoreEl.textContent = quality.mesh_quality_score;
            if (quality.mesh_quality_score >= 80) {
                scoreEl.style.color = '#10b981'; // green
            } else if (quality.mesh_quality_score >= 60) {
                scoreEl.style.color = '#f59e0b'; // orange
            } else {
                scoreEl.style.color = '#ef4444'; // red
            }
            
            // Basic stats
            document.getElementById('stl-vertices').textContent = quality.vertex_count.toLocaleString();
            document.getElementById('stl-faces').textContent = quality.face_count.toLocaleString();
            document.getElementById('stl-volume').textContent = `${quality.volume_cm3.toFixed(2)} cm³`;
            document.getElementById('stl-area').textContent = `${quality.surface_area_cm2.toFixed(2)} cm²`;
            
            // Quality indicators
            document.getElementById('stl-watertight').textContent = quality.is_watertight ? '✅ Yes' : '❌ No';
            document.getElementById('stl-watertight').style.color = quality.is_watertight ? '#10b981' : '#ef4444';
            
            document.getElementById('stl-manifold').textContent = quality.is_manifold ? '✅ Yes' : '❌ No';
            document.getElementById('stl-manifold').style.color = quality.is_manifold ? '#10b981' : '#ef4444';
            
            document.getElementById('stl-tri-quality').textContent = quality.triangle_quality_mean.toFixed(3);
            document.getElementById('stl-aspect-ratio').textContent = quality.aspect_ratio_max.toFixed(2);
            
            // G-code comparison
            if (result.gcode_comparison) {
                const comp = result.gcode_comparison;
                const compDiv = document.getElementById('stl-gcode-comparison');
                compDiv.classList.remove('hidden');
                
                document.getElementById('stl-hausdorff').textContent = `${comp.hausdorff_distance_mm.toFixed(3)} mm`;
                document.getElementById('stl-mean-dev').textContent = `${comp.mean_deviation_mm.toFixed(3)} mm`;
                document.getElementById('stl-accuracy').textContent = `${comp.overall_accuracy_percent.toFixed(1)}%`;
            }
            
            // Warnings
            if (quality.warnings && quality.warnings.length > 0) {
                const warningsDiv = document.getElementById('stl-warnings');
                const warningsList = document.getElementById('stl-warnings-list');
                warningsDiv.classList.remove('hidden');
                warningsList.innerHTML = quality.warnings.map(w => `<li>${w}</li>`).join('');
            }
            
            // Recommendations
            if (quality.recommendations && quality.recommendations.length > 0) {
                const recsDiv = document.getElementById('stl-recommendations');
                const recsList = document.getElementById('stl-recommendations-list');
                recsDiv.classList.remove('hidden');
                recsList.innerHTML = quality.recommendations.map(r => `<li>${r}</li>`).join('');
            }
        }

        // --- Initial Run ---
        loadMaterials(); // Load the materials DB first
        switchModel(modelSelector.value); // Then run the default simulation
        populateOptimizerObjectives(optimizerModelSelector.value); // Populate optimizer

    </script>
</body>

</html>