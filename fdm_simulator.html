<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDM 3D Print Property Simulator (v6)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load three.js for 3D viewer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        .simulator-card {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #d1d5db;
            /* gray-300 */
        }

        .slider-value {
            font-weight: 600;
            color: #f9fafb;
            /* gray-50 */
        }

        /* Custom slider track */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #374151;
            /* gray-700 */
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #f9fafb;
            /* gray-50 */
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #f9fafb;
            /* gray-50 */
        }

        .output-card {
            background-color: #1f2937;
            /* gray-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output-label {
            font-size: 0.875rem;
            color: #9ca3af;
            /* gray-400 */
        }

        .output-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
            /* blue-500 */
        }

        /* Tab styles */
        .tab-button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: #9ca3af;
            /* gray-400 */
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .tab-button.active {
            color: #3b82f6;
            /* blue-500 */
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #stlCanvas {
            width: 100%;
            height: 400px;
            border-radius: 0.5rem;
            background-color: #1f2937;
            /* gray-800 */
        }

        .fea-table-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1f2937;
            /* gray-800 */
            border-radius: 0.5rem;
        }

        .fea-table th {
            position: sticky;
            top: 0;
            background-color: #374151;
            /* gray-700 */
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: max-content;
            max-width: 250px;
            background-color: #1f2937;
            /* gray-800 */
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            font-weight: 400;
            pointer-events: none;
            border: 1px solid #374151;
            /* gray-700 */
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Optimizer table */
        .optimizer-table th,
        .optimizer-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #374151;
            /* gray-700 */
        }

        .optimizer-table th {
            background-color: #374151;
            /* gray-700 */
        }

        .optimizer-table td {
            background-color: #1f2937;
            /* gray-800 */
        }
    </style>
</head>

<body class="h-full text-gray-100 p-4 md:p-8 bg-gray-900">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-white">FDM 3D Print Property Simulator (v6)</h1>
            <p class="text-lg text-gray-400">Simulate mechanical properties or optimize settings based on your goals.
            </p>
        </header>

        <!-- Global Settings -->
        <div class="simulator-card mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">Global Print Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- v3: Changed to Filament Used (g) -->
                <div>
                    <label for="part_mass_g" class="block text-sm font-medium text-gray-300 mb-2 tooltip">
                        Filament Used (g)
                        <span class="tooltip-text">Enter the estimated filament weight for your part (in grams) from
                            your slicer.</span>
                    </label>
                    <input type="number" id="part_mass_g" value="50"
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                </div>
                <div>
                    <label for="filament_cost_kg" class="block text-sm font-medium text-gray-300 mb-2 tooltip">
                        Filament Cost ($/kg)
                        <span class="tooltip-text">Enter the cost of a 1kg spool of your filament (e.g., 25.00).</span>
                    </label>
                    <input type="number" id="filament_cost_kg" value="25.0"
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                </div>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="mb-6 border-b border-gray-700">
            <nav class="flex">
                <button class="tab-button active" data-tab="simulator">Simulator</button>
                <button class="tab-button" data-tab="optimizer">Optimizer</button>
            </nav>
        </div>

        <!-- Simulator Tab Content -->
        <div id="tab-simulator" class="tab-content active">
            <div class="mb-6">
                <label for="modelSelector" class="block text-sm font-medium text-gray-300 mb-2">Select Simulation
                    Model</label>
                <select id="modelSelector"
                    class="w-full max-w-md bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="kaggle" selected>Kaggle Model (Strength, Roughness, Elongation)</option>
                    <option value="warpage">Warp Deformation (Nazan et al.)</option> <!-- v6: New -->
                    <option value="accuracy">Dimensional Accuracy (Deswal et al.)</option>
                    <option value="fatigue">Fatigue Lifetime Model (Azadi et al.)</option>
                    <option value="c3">C3 Model (Tensile Strength & Elongation)</option>
                    <option value="fea">FEA Material Card (Lee & Tucker)</option>
                </select>
            </div>

            <!-- Simulator Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Column 1: G-Code Parser & Parameters -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- G-Code Parser (Kaggle & C3 Only) -->
                    <div id="gcode-parser-container" class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">G-Code Parser</h2>
                        <p class="text-gray-400 text-sm mb-4">Upload an OrcaSlicer `.gcode` file to automatically
                            populate parameters for the selected model.</p>
                        <input type="file" id="gcodeFile" accept=".gcode" class="block w-full text-sm text-gray-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-600 file:text-white
                            hover:file:bg-blue-700 file:cursor-pointer
                        " />
                        <button id="parseGcodeBtn"
                            class="mt-4 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                            Parse G-Code
                        </button>
                    </div>

                    <!-- Parameters Card -->
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Process Parameters</h2>

                        <!-- Kaggle Model Parameters -->
                        <div id="kaggle-params" class="model-params space-y-4">
                            <!-- Material Database Selector -->
                            <div>
                                <label for="kaggle_material_database"
                                    class="block text-sm font-medium text-gray-300 mb-2 tooltip">
                                    Load Material Profile (Kaggle)
                                    <span class="tooltip-text">Select a material to auto-fill common settings.</span>
                                </label>
                                <select id="kaggle_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Options populated by JS -->
                                </select>
                                <input type="hidden" id="material" value="pla"> <!-- Hidden field for the model -->
                            </div>
                            <!-- Sliders -->
                            <div>
                                <label for="layer_height" class="slider-label tooltip">
                                    <span>Layer Height (mm)</span>
                                    <span class="tooltip-text">Thickness of each individual printed layer. Smaller is
                                        higher quality but slower.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="layer_height" min="0.02" max="0.3" step="0.01" value="0.1"
                                        class="w-full">
                                    <span id="layer_height_val" class="slider-value w-12 text-right">0.1</span>
                                </div>
                            </div>
                            <div>
                                <label for="wall_thickness" class="slider-label tooltip">
                                    <span>Wall Thickness (layers)</span>
                                    <span class="tooltip-text">Number of outer shells (perimeters). More walls =
                                        stronger part.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="wall_thickness" min="1" max="10" step="1" value="4"
                                        class="w-full">
                                    <span id="wall_thickness_val" class="slider-value w-12 text-right">4</span>
                                </div>
                            </div>
                            <div>
                                <label for="infill_density" class="slider-label tooltip">
                                    <span>Infill Density (%)</span>
                                    <span class="tooltip-text">Percentage of material used for the internal support
                                        structure. Higher = stronger and heavier.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="infill_density" min="10" max="100" step="1" value="50"
                                        class="w-full">
                                    <span id="infill_density_val" class="slider-value w-12 text-right">50</span>
                                </div>
                            </div>
                            <div>
                                <label for="nozzle_temperature" class="slider-label tooltip">
                                    <span>Nozzle Temp (°C)</span>
                                    <span class="tooltip-text">Temperature of the extruder. Critical for layer adhesion
                                        and strength.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="nozzle_temperature" min="200" max="250" step="1" value="220"
                                        class="w-full">
                                    <span id="nozzle_temperature_val" class="slider-value w-12 text-right">220</span>
                                </div>
                            </div>
                            <div>
                                <label for="bed_temperature" class="slider-label tooltip">
                                    <span>Bed Temp (°C)</span>
                                    <span class="tooltip-text">Temperature of the print surface. Prevents warping and
                                        helps with first-layer adhesion.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="bed_temperature" min="50" max="100" step="1" value="60"
                                        class="w-full">
                                    <span id="bed_temperature_val" class="slider-value w-12 text-right">60</span>
                                </div>
                            </div>
                            <div>
                                <label for="print_speed" class="slider-label tooltip">
                                    <span>Print Speed (mm/s)</span>
                                    <span class="tooltip-text">Speed of the print head (mm/s). Slower is generally
                                        stronger and more accurate.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="print_speed" min="40" max="120" step="1" value="60"
                                        class="w-full">
                                    <span id="print_speed_val" class="slider-value w-12 text-right">60</span>
                                </div>
                            </div>
                            <div>
                                <label for="fan_speed" class="slider-label tooltip">
                                    <span>Fan Speed (%)</span>
                                    <span class="tooltip-text">Cooling fan speed. Higher speed cools the plastic faster,
                                        improving overhangs but can reduce layer bonding.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fan_speed" min="0" max="100" step="1" value="50"
                                        class="w-full">
                                    <span id="fan_speed_val" class="slider-value w-12 text-right">50</span>
                                </div>
                            </div>
                            <div>
                                <label for="infill_pattern"
                                    class="block text-sm font-medium text-gray-300 mb-2 tooltip">
                                    Infill Pattern
                                    <span class="tooltip-text">Geometric shape of the internal infill (e.g., Grid,
                                        Honeycomb).</span>
                                </label>
                                <select id="infill_pattern"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="grid">Grid</option>
                                    <option value="honeycomb">Honeycomb</option>
                                </select>
                            </div>
                        </div>

                        <!-- C3 Model Parameters -->
                        <div id="c3-params" class="model-params space-y-4 hidden">
                            <!-- ... C3 sliders ... -->
                            <div>
                                <label for="c3_Temperature" class="slider-label tooltip"><span>Nozzle Temp
                                        (°C)</span><span class="tooltip-text">Temperature of the extruder. Critical for
                                        layer adhesion and strength.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="c3_Temperature" min="190" max="220" step="1" value="205"
                                        class="w-full">
                                    <span id="c3_Temperature_val" class="slider-value w-12 text-right">205</span>
                                </div>
                            </div>
                            <div>
                                <label for="c3_Speed" class="slider-label tooltip"><span>Print Speed (mm/s)</span><span
                                        class="tooltip-text">Speed of the print head (mm/s). Slower is generally
                                        stronger.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="c3_Speed" min="40" max="100" step="1" value="70"
                                        class="w-full">
                                    <span id="c3_Speed_val" class="slider-value w-12 text-right">70</span>
                                </div>
                            </div>
                            <div>
                                <label for="c3_Angle" class="slider-label tooltip"><span>Raster Angle (°)</span><span
                                        class="tooltip-text">Raster angle (e.g., 0°, 45°, 90°). The direction lines are
                                        printed relative to the part's X/Y axes.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="c3_Angle" min="0" max="90" step="15" value="45"
                                        class="w-full">
                                    <span id="c3_Angle_val" class="slider-value w-12 text-right">45</span>
                                </div>
                            </div>
                            <div>
                                <label for="c3_Height" class="slider-label tooltip"><span>Layer Height (mm)</span><span
                                        class="tooltip-text">Thickness of each individual printed layer. Smaller is
                                        higher quality but slower.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="c3_Height" min="0.1" max="0.2" step="0.01" value="0.15"
                                        class="w-full">
                                    <span id="c3_Height_val" class="slider-value w-12 text-right">0.15</span>
                                </div>
                            </div>
                            <div>
                                <label for="c3_Fill" class="slider-label tooltip"><span>Infill Density (%)</span><span
                                        class="tooltip-text">Percentage of material used for the internal support
                                        structure. Higher = stronger.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="c3_Fill" min="70" max="100" step="1" value="85"
                                        class="w-full">
                                    <span id="c3_Fill_val" class="slider-value w-12 text-right">85</span>
                                </div>
                            </div>
                        </div>

                        <!-- FEA Model Parameters -->
                        <div id="fea-params" class="model-params space-y-4 hidden">
                            <!-- Material Database Selector -->
                            <div>
                                <label for="fea_material_database"
                                    class="block text-sm font-medium text-gray-300 mb-2 tooltip">
                                    Load Material Profile (FEA)
                                    <span class="tooltip-text">Select a material to auto-fill its datasheet properties
                                        (Young's Modulus, etc.).</span>
                                </label>
                                <select id="fea_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <h3 class="text-lg font-semibold text-blue-300">Filament Datasheet Properties</h3>
                            <div>
                                <label for="fea_Material_Bonding_Perfection" class="slider-label tooltip"><span>Bonding
                                        Perfection</span><span class="tooltip-text">A factor (0.1-1.0) representing how
                                        well layers bond. 1.0 is a perfect bond (like injection molding).</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fea_Material_Bonding_Perfection" min="0.1" max="1.0"
                                        step="0.01" value="0.5" class="w-full">
                                    <span id="fea_Material_Bonding_Perfection_val"
                                        class="slider-value w-12 text-right">0.5</span>
                                </div>
                            </div>
                            <div>
                                <label for="fea_Material_Youngs_Modulus_GPa" class="slider-label tooltip"><span>Young's
                                        Modulus (GPa)</span><span class="tooltip-text">Material stiffness. Find this
                                        value on your filament's Technical Data Sheet (TDS).</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fea_Material_Youngs_Modulus_GPa" min="1.0" max="5.0"
                                        step="0.1" value="2.5" class="w-full">
                                    <span id="fea_Material_Youngs_Modulus_GPa_val"
                                        class="slider-value w-12 text-right">2.5</span>
                                </div>
                            </div>
                            <div>
                                <label for="fea_Material_Tensile_Yield_Strenght_MPa"
                                    class="slider-label tooltip"><span>Tensile Strength (MPa)</span><span
                                        class="tooltip-text">Maximum stress the *raw filament* can take. Find this on
                                        your filament's TDS.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fea_Material_Tensile_Yield_Strenght_MPa" min="20" max="80"
                                        step="1" value="50" class="w-full">
                                    <span id="fea_Material_Tensile_Yield_Strenght_MPa_val"
                                        class="slider-value w-12 text-right">50</span>
                                </div>
                            </div>
                            <div>
                                <label for="fea_Material_Poissons_Ratio" class="slider-label tooltip"><span>Poisson's
                                        Ratio</span><span class="tooltip-text">Material's tendency to shrink/expand
                                        sideways when stretched/compressed. Find this on your filament's
                                        TDS.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fea_Material_Poissons_Ratio" min="0.1" max="0.5" step="0.01"
                                        value="0.35" class="w-full">
                                    <span id="fea_Material_Poissons_Ratio_val"
                                        class="slider-value w-12 text-right">0.35</span>
                                </div>
                            </div>

                            <h3 class="text-lg font-semibold text-blue-300 mt-4">Slicer Settings</h3>
                            <div>
                                <label for="fea_User_Infill_Density" class="slider-label tooltip"><span>Infill Density
                                        (0.1-1.0)</span><span class="tooltip-text">Infill percentage (as a decimal,
                                        0.1-1.0) for the part you are simulating.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fea_User_Infill_Density" min="0.1" max="1.0" step="0.01"
                                        value="0.5" class="w-full">
                                    <span id="fea_User_Infill_Density_val"
                                        class="slider-value w-12 text-right">0.5</span>
                                </div>
                            </div>
                            <div>
                                <label for="fea_User_Line_Thickenss_mm" class="slider-label tooltip"><span>Line
                                        Thickness (mm)</span><span class="tooltip-text">Width of a single extruded line
                                        (e.g., 0.4mm for a 0.4mm nozzle).</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fea_User_Line_Thickenss_mm" min="0.2" max="0.8" step="0.01"
                                        value="0.4" class="w-full">
                                    <span id="fea_User_Line_Thickenss_mm_val"
                                        class="slider-value w-12 text-right">0.4</span>
                                </div>
                            </div>
                            <div>
                                <label for="fea_User_Layer_Height_mm" class="slider-label tooltip"><span>Layer Height
                                        (mm)</span><span class="tooltip-text">Thickness of each individual printed layer
                                        for the part you are simulating.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fea_User_Layer_Height_mm" min="0.1" max="0.4" step="0.01"
                                        value="0.2" class="w-full">
                                    <span id="fea_User_Layer_Height_mm_val"
                                        class="slider-value w-12 text-right">0.2</span>
                                </div>
                            </div>
                            <div>
                                <label for="fea_User_Infill_Pattern"
                                    class="block text-sm font-medium text-gray-300 mb-2 tooltip">
                                    Infill Pattern
                                    <span class="tooltip-text">Geometric shape of the internal infill. This model
                                        supports Rectilinear and Concentric.</span>
                                </label>
                                <select id="fea_User_Infill_Pattern"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="Rectilinear">Rectilinear</option>
                                    <option value="concentric">Concentric</option>
                                </select>
                            </div>
                        </div>

                        <!-- Fatigue Model Parameters -->
                        <div id="fatigue-params" class="model-params space-y-4 hidden">
                            <!-- Material Database Selector -->
                            <div>
                                <label for="fatigue_material_database"
                                    class="block text-sm font-medium text-gray-300 mb-2 tooltip">
                                    Load Material Profile (Fatigue)
                                    <span class="tooltip-text">Select a material to auto-fill common settings.</span>
                                </label>
                                <select id="fatigue_material_database"
                                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                    <option value="">-- Select Material --</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <h3 class="text-lg font-semibold text-blue-300">Part Load</h3>
                            <div>
                                <label for="fatigue_Stress_Level" class="slider-label tooltip"><span>Applied Stress
                                        Level (MPa)</span><span class="tooltip-text">The real-world cyclical load (in
                                        MegaPascals) you expect the part to endure. This is *not* a slicer setting.
                                        Estimate this based on your part's use case.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fatigue_Stress_Level" min="2.5" max="15" step="0.1"
                                        value="10" class="w-full">
                                    <span id="fatigue_Stress_Level_val" class="slider-value w-12 text-right">10.0</span>
                                </div>
                            </div>
                            <h3 class="text-lg font-semibold text-blue-300 mt-4">Slicer Settings</h3>
                            <div>
                                <label for="fatigue_Nozzle_Diameter" class="slider-label tooltip"><span>Nozzle Diameter
                                        (mm)</span><span class="tooltip-text">The diameter of the nozzle used to print
                                        the part (e.g., 0.4mm, 0.6mm).</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fatigue_Nozzle_Diameter" min="0.2" max="0.6" step="0.1"
                                        value="0.4" class="w-full">
                                    <span id="fatigue_Nozzle_Diameter_val"
                                        class="slider-value w-12 text-right">0.4</span>
                                </div>
                            </div>
                            <div>
                                <label for="fatigue_Print_Speed" class="slider-label tooltip"><span>Print Speed
                                        (mm/s)</span><span class="tooltip-text">Speed of the print head (mm/s). Slower
                                        is generally stronger and more durable.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fatigue_Print_Speed" min="5" max="15" step="1" value="10"
                                        class="w-full">
                                    <span id="fatigue_Print_Speed_val" class="slider-value w-12 text-right">10</span>
                                </div>
                            </div>
                            <div>
                                <label for="fatigue_Nozzle_Temperature" class="slider-label tooltip"><span>Nozzle Temp
                                        (°C)</span><span class="tooltip-text">Temperature of the extruder. Critical for
                                        layer adhesion and fatigue life.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="fatigue_Nozzle_Temperature" min="180" max="240" step="1"
                                        value="210" class="w-full">
                                    <span id="fatigue_Nozzle_Temperature_val"
                                        class="slider-value w-12 text-right">210</span>
                                </div>
                            </div>
                        </div>

                        <!-- Accuracy Model Parameters -->
                        <div id="accuracy-params" class="model-params space-y-4 hidden">
                            <div>
                                <label for="accuracy_Layer_Thickness_mm" class="slider-label tooltip"><span>Layer Height
                                        (mm)</span><span class="tooltip-text">Thickness of each individual printed
                                        layer.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="accuracy_Layer_Thickness_mm" min="0.1" max="0.4" step="0.1"
                                        value="0.2" class="w-full">
                                    <span id="accuracy_Layer_Thickness_mm_val"
                                        class="slider-value w-12 text-right">0.2</span>
                                </div>
                            </div>
                            <div>
                                <label for="accuracy_Build_Orientation_deg" class="slider-label tooltip"><span>Build
                                        Orientation (°)</span><span class="tooltip-text">Orientation of the part on the
                                        build plate relative to the X-axis (0-90°).</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="accuracy_Build_Orientation_deg" min="0" max="90" step="15"
                                        value="45" class="w-full">
                                    <span id="accuracy_Build_Orientation_deg_val"
                                        class="slider-value w-12 text-right">45</span>
                                </div>
                            </div>
                            <div>
                                <label for="accuracy_Infill_Density_percent" class="slider-label tooltip"><span>Infill
                                        Density (%)</span><span class="tooltip-text">Percentage of material used for the
                                        internal support structure.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="accuracy_Infill_Density_percent" min="80" max="100" step="5"
                                        value="90" class="w-full">
                                    <span id="accuracy_Infill_Density_percent_val"
                                        class="slider-value w-12 text-right">90</span>
                                </div>
                            </div>
                            <div>
                                <label for="accuracy_Number_of_Contours" class="slider-label tooltip"><span>Number of
                                        Contours</span><span class="tooltip-text">Number of outer shells
                                        (perimeters/walls).</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="accuracy_Number_of_Contours" min="1" max="3" step="1"
                                        value="1" class="w-full">
                                    <span id="accuracy_Number_of_Contours_val"
                                        class="slider-value w-12 text-right">1</span>
                                </div>
                            </div>
                        </div>

                        <!-- v6: Warpage Model Parameters -->
                        <div id="warpage-params" class="model-params space-y-4 hidden">
                            <div>
                                <label for="warpage_Layer_Temperature_C" class="slider-label tooltip"><span>Nozzle Temp
                                        (°C)</span><span class="tooltip-text">Temperature of the extruder. Higher
                                        temperatures can increase warping.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="warpage_Layer_Temperature_C" min="190" max="210" step="1"
                                        value="200" class="w-full">
                                    <span id="warpage_Layer_Temperature_C_val"
                                        class="slider-value w-12 text-right">200</span>
                                </div>
                            </div>
                            <div>
                                <label for="warpage_Infill_Density_percent" class="slider-label tooltip"><span>Infill
                                        Density (%)</span><span class="tooltip-text">Higher infill density creates more
                                        internal stress, increasing warping.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="warpage_Infill_Density_percent" min="10" max="30" step="1"
                                        value="20" class="w-full">
                                    <span id="warpage_Infill_Density_percent_val"
                                        class="slider-value w-12 text-right">20</span>
                                </div>
                            </div>
                            <div>
                                <label for="warpage_First_Layer_Height_mm" class="slider-label tooltip"><span>First
                                        Layer Height (mm)</span><span class="tooltip-text">A thicker, more 'squished'
                                        first layer can help reduce corner lift.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="warpage_First_Layer_Height_mm" min="0.2" max="0.4"
                                        step="0.01" value="0.3" class="w-full">
                                    <span id="warpage_First_Layer_Height_mm_val"
                                        class="slider-value w-12 text-right">0.3</span>
                                </div>
                            </div>
                            <div>
                                <label for="warpage_Other_Layer_Height_mm" class="slider-label tooltip"><span>Layer
                                        Height (mm)</span><span class="tooltip-text">Thickness of all subsequent
                                        layers.</span></label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="warpage_Other_Layer_Height_mm" min="0.3" max="0.5"
                                        step="0.01" value="0.4" class="w-full">
                                    <span id="warpage_Other_Layer_Height_mm_val"
                                        class="slider-value w-12 text-right">0.4</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Column 2: Predicted Properties -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- Predicted Properties Card -->
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Predicted Properties</h2>
                        <div id="spinner" class="hidden text-center text-gray-400">
                            <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p>Simulating...</p>
                        </div>
                        <div id="error-message"
                            class="hidden text-center text-red-400 p-3 bg-red-900 bg-opacity-30 rounded-lg">
                            <p class="font-bold">Simulation Failed</p>
                            <p id="error-text" class="text-sm">Error details here.</p>
                        </div>

                        <!-- v3: Cost/Time Outputs (Common to all) -->
                        <div class="model-outputs space-y-3 mb-4">
                            <div class="output-card bg-gray-800 border border-gray-700">
                                <div>
                                    <div class="output-label">Estimated Cost</div>
                                    <div id="estimated_cost_usd" class="output-value text-green-400">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">USD</div>
                            </div>
                            <div class="output-card bg-gray-800 border border-gray-700">
                                <div>
                                    <div class="output-label">Estimated Print Time</div>
                                    <div id="estimated_print_time_min" class="output-value text-yellow-400">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">min</div>
                            </div>
                        </div>

                        <!-- Kaggle Model Outputs -->
                        <div id="kaggle-outputs" class="model-outputs space-y-3">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Tensile Strength</div>
                                    <div id="tensile_strength" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">MPa</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Roughness</div>
                                    <div id="roughness" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">µm</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Elongation</div>
                                    <div id="elongation" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>

                        <!-- C3 Model Outputs -->
                        <div id="c3-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Tensile Strength</div>
                                    <div id="c3_tensile_strength" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">MPa</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Elongation at Break</div>
                                    <div id="c3_elongation" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>

                        <!-- FEA Model Outputs -->
                        <div id="fea-outputs" class="model-outputs space-y-4 hidden">
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Upload Part Geometry</h3>
                                    <p class="text-gray-400 text-sm mb-4">Upload an STL file to visualize your part.</p>
                                    <input type="file" id="stlFile" accept=".stl" class="block w-full text-sm text-gray-400
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-full file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-600 file:text-white
                                        hover:file:bg-blue-700 file:cursor-pointer
                                    " />
                                </div>
                                <div id="stlCanvas"></div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-2">Predicted Material Card</h3>
                                <p class="text-gray-400 text-sm mb-2">These anisotropic properties can be exported to
                                    professional FEA software.</p>
                                <div class="fea-table-container">
                                    <table class="w-full text-left text-sm text-gray-300">
                                        <thead class="text-xs text-gray-100 uppercase">
                                            <tr>
                                                <th scope="col" class="py-3 px-4">Property</th>
                                                <th scope="col" class="py-3 px-4">Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fea-results-table">
                                            <!-- Rows will be injected by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Fatigue Model Outputs -->
                        <div id="fatigue-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Predicted Fatigue Lifetime</div>
                                    <div id="fatigue_lifetime" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">Cycles</div>
                            </div>
                            <div class="text-gray-400 text-sm p-2">
                                This is an estimate of how many times the part can withstand the specified stress level
                                before failure.
                            </div>
                        </div>

                        <!-- Accuracy Model Outputs -->
                        <div id="accuracy-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Length Error</div>
                                    <div id="Var_Length_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Width Error</div>
                                    <div id="Var_Width_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Thickness Error</div>
                                    <div id="Var_Thickness_percent" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">%</div>
                            </div>
                        </div>

                        <!-- v6: Warpage Model Outputs -->
                        <div id="warpage-outputs" class="model-outputs space-y-3 hidden">
                            <div class="output-card">
                                <div>
                                    <div class="output-label">Predicted Warpage</div>
                                    <div id="Warpage_mm" class="output-value">...</div>
                                </div>
                                <div class="text-lg font-medium text-gray-400">mm</div>
                            </div>
                            <div class="text-gray-400 text-sm p-2">
                                This is an estimate of the maximum corner lift (in mm) due to thermal stress. Lower is
                                better.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column 3: Recommendations -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Optimization Recommendations</h2>

                        <!-- Kaggle Recommendations -->
                        <div id="kaggle-recs" class="model-recs space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Quality (Strength &
                                    Finish):</h3>
                                <ul id="kaggle-rec-quality"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-yellow-400">To Maximize Speed &
                                    Cost-Effectiveness:</h3>
                                <ul id="kaggle-rec-speed" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- C3 Recommendations -->
                        <div id="c3-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Tensile Strength:</h3>
                                <ul id="c3-rec-strength" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-blue-400">To Maximize Elongation (Ductility):</h3>
                                <ul id="c3-rec-elongation"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- FEA Recommendations -->
                        <div id="fea-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300">FEA Model Notes</h3>
                                <p class="text-gray-400 text-sm">
                                    This model predicts the anisotropic material properties based on your filament's
                                    datasheet values and slicer settings.
                                </p>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1 mt-2">
                                    <li>The predicted values are for the **part as printed**, not the raw filament.</li>
                                    <li>**Higher 'Bonding Perfection'** (better layer adhesion) dramatically increases
                                        vertical strength.</li>
                                    <li>The **Infill Pattern** (Rectilinear vs. Concentric) has a major impact on how
                                        the part behaves under load from different directions.</li>
                                    <li>Use these properties in FEA software to simulate real-world performance of your
                                        specific part geometry.</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Fatigue Recommendations -->
                        <div id="fatigue-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Fatigue Life (Durability):
                                </h3>
                                <ul id="fatigue-rec-life" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-red-400">To Reduce Fatigue Life (Warning):</h3>
                                <ul id="fatigue-rec-warning"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- Accuracy Recommendations -->
                        <div id="accuracy-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Maximize Dimensional Accuracy
                                    (Minimize Error):</h3>
                                <ul id="accuracy-rec-life"
                                    class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                        <!-- v6: Warpage Recommendations -->
                        <div id="warpage-recs" class="model-recs space-y-4 hidden">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">To Minimize Warpage (Corner Lift):</h3>
                                <ul id="warpage-rec-life" class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>

            </div> <!-- End Simulator Grid -->
        </div> <!-- End Simulator Tab -->

        <!-- Optimizer Tab Content -->
        <div id="tab-optimizer" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Column 1: Optimizer Setup -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Optimization Goals</h2>
                        <p class="text-gray-400 text-sm mb-4">
                            Select a model and define your goals. The optimizer will find the top 5 settings that best
                            match your objectives.
                        </p>

                        <div>
                            <label for="optimizerModelSelector" class="block text-sm font-medium text-gray-300 mb-2">1.
                                Select Model to Optimize</label>
                            <select id="optimizerModelSelector"
                                class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2">
                                <option value="kaggle">Kaggle Model (Strength, Roughness)</option>
                                <option value="warpage">Warp Deformation (Nazan et al.)</option> <!-- v6: New -->
                                <option value="accuracy">Dimensional Accuracy (Deswal et al.)</option>
                                <!-- Add other models (C3, Fatigue) here when their opt params are defined -->
                            </select>
                        </div>

                        <div id="optimizer-objectives-container" class="space-y-4 mt-4">
                            <label class="block text-sm font-medium text-gray-300">2. Define Objectives (What to
                                Max/Min)</label>
                            <!-- Objectives will be dynamically added here by JS -->
                        </div>

                        <button id="runOptimizer"
                            class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                            Run Optimization
                        </button>
                    </div>
                </div>

                <!-- Column 2-3: Optimizer Results -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="simulator-card">
                        <h2 class="text-xl font-semibold text-white mb-4">Optimization Results</h2>

                        <!-- Optimizer Spinner -->
                        <div id="optimizer-spinner" class="hidden text-center text-gray-400 p-8">
                            <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p class="mt-4 text-lg">Running Genetic Algorithm...</p>
                            <p class="text-sm">This may take 30-60 seconds as we simulate thousands of possibilities.
                            </p>
                        </div>

                        <!-- Optimizer Error -->
                        <div id="optimizer-error-message"
                            class="hidden text-center text-red-400 p-3 bg-red-900 bg-opacity-30 rounded-lg">
                            <p class="font-bold">Optimization Failed</p>
                            <p id="optimizer-error-text" class="text-sm">Error details here.</p>
                        </div>

                        <!-- Optimizer Results Table -->
                        <div id="optimizer-results-container" class="hidden overflow-x-auto">
                            <p class="text-gray-300 text-sm mb-4">
                                Here are the Top 5 "Pareto Front" solutions. These represent the best possible
                                trade-offs for your selected goals.
                            </p>
                            <table class="w-full min-w-max optimizer-table">
                                <thead id="optimizer-results-head">
                                    <!-- Header populated by JS -->
                                </thead>
                                <tbody id="optimizer-results-body">
                                    <!-- Body populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End Optimizer Tab -->

        <!-- v3: References Footer -->
        <footer class="mt-12 simulator-card">
            <h2 class="text-xl font-semibold text-white mb-4">Data Sources & References</h2>
            <div class="text-gray-400 text-sm space-y-3">
                <p>This tool is an educational and research demonstrator. The predictive models are based on datasets
                    and methodologies from the following peer-reviewed articles:</p>
                <ol class="list-decimal list-inside space-y-2">
                    <li>
                        <strong>Kaggle Model:</strong> Based on the "3D Printer" dataset by Afumento on Kaggle.
                        Parameters and outputs are derived from this dataset of experimental prints.
                    </li>
                    <li>
                        <strong>C3 Model:</strong> Based on the dataset from Wang et al. (2024), "Machine learning
                        enabled 3D printing parameter settings for desired mechanical properties."
                    </li>
                    <li>
                        <strong>FEA Material Card:</strong> Based on the dataset and methodology from Lee & Tucker
                        (2025), "Data-Driven 3D-Printed Material Data Prediction From Benchmark Specimens."
                    </li>
                    <li>
                        <strong>Fatigue Lifetime Model:</strong> Based on the dataset from Azadi & Dadashi (2022),
                        "Experimental fatigue dataset for additive-manufactured 3D-printed Polylactic acid
                        biomaterials..."
                    </li>
                    <li>
                        <strong>Dimensional Accuracy Model:</strong> Based on the dataset from Deswal et al. (2019),
                        "Modeling and parametric optimization of FDM 3D printing process using hybrid techniques for
                        enhancing dimensional preciseness."
                    </li>
                    <li>
                        <strong>Warp Deformation Model:</strong> Based on the dataset from Nazan et al. (2017), "Process
                        parameter optimization of 3D printer using response surface method." (v6: New)
                    </li>
                    <li>
                        <strong>Optimization Methodology:</strong> The multi-objective genetic algorithm (NSGA-II) is a
                        method widely used in FDM optimization research, such as in Panico et al. (2025), "Multi
                        objective optimization of FDM 3D printing parameters set via design of experiments and machine
                        learning algorithms."
                    </li>
                </ol>
            </div>
        </footer>

    </div>

    <script type="module">
        // === 3D Viewer (three.js) ===
        let scene, camera, renderer, controls, mesh;

        function init3DViewer() {
            const canvas = document.getElementById('stlCanvas');
            if (!canvas) return;

            // 1. Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1f2937); // gray-800

            // 2. Camera
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.z = 100;

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            canvas.innerHTML = ''; // Clear canvas
            canvas.appendChild(renderer.domElement);

            // 4. Lights
            const ambientLight = new THREE.AmbientLight(0x404040, 2); // soft white light
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-1, -1, -1).normalize();
            scene.add(directionalLight2);

            // 5. Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.enableZoom = true;

            // 6. Animation Loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // 7. Resize Handler
            window.addEventListener('resize', () => {
                if (canvas.offsetParent === null) return; // Only resize if visible
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }, false);
        }

        function loadSTL(file) {
            const loader = new THREE.STLLoader();
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const geometry = loader.parse(event.target.result);

                    if (mesh) {
                        scene.remove(mesh); // Remove old mesh
                    }

                    // Create material
                    const material = new THREE.MeshStandardMaterial({
                        color: 0x3b82f6, // blue-500
                        metalness: 0.1,
                        roughness: 0.5,
                    });

                    // Create mesh
                    mesh = new THREE.Mesh(geometry, material);

                    // Center the geometry
                    geometry.computeBoundingBox();
                    const center = geometry.boundingBox.getCenter(new THREE.Vector3());
                    mesh.position.sub(center);

                    // Add to scene
                    scene.add(mesh);

                    // Zoom to fit
                    const size = geometry.boundingBox.getSize(new THREE.Vector3()).length();
                    camera.position.z = size;
                    controls.update();

                } catch (e) {
                    console.error("Error parsing STL:", e);
                    showError("Error: Could not parse the STL file. It may be corrupt or in the wrong format.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // === API & Simulation Logic ===
        const API_BASE_URL = "http://127.0.0.1:8000";
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // --- Global State ---
        let materialsDatabase = {}; // To store materials.json

        // --- Helper: Get Global Inputs ---
        function getGlobalInputs() {
            const selectedMaterialName = getSelectedMaterialName();
            return {
                part_mass_g: parseFloat(document.getElementById('part_mass_g').value) || 50.0,
                filament_cost_kg: parseFloat(document.getElementById('filament_cost_kg').value) || 25.0,
                material_name: selectedMaterialName
            };
        }

        function getSelectedMaterialName() {
            const model = modelSelector.value;
            let selectorId = "kaggle_material_database"; // default
            if (model === 'fea') selectorId = "fea_material_database";
            if (model === 'fatigue') selectorId = "fatigue_material_database";
            // C3, Accuracy, Warpage models don't have a material DB, so we derive it
            if (model === 'c3' || model === 'accuracy' || model === 'warpage') return "PLA"; // These datasets were PLA

            const selector = document.getElementById(selectorId);
            if (selector && selector.value) return selector.value;

            // Fallback for Kaggle if no DB entry is selected
            if (model === 'kaggle') return document.getElementById('material').value;

            return "PLA"; // Generic fallback
        }

        // --- Input Getters ---
        function getKaggleInputs() {
            return {
                ...getGlobalInputs(),
                layer_height: parseFloat(document.getElementById('layer_height').value),
                wall_thickness: parseInt(document.getElementById('wall_thickness').value),
                infill_density: parseInt(document.getElementById('infill_density').value),
                infill_pattern: document.getElementById('infill_pattern').value,
                nozzle_temperature: parseInt(document.getElementById('nozzle_temperature').value),
                bed_temperature: parseInt(document.getElementById('bed_temperature').value),
                print_speed: parseInt(document.getElementById('print_speed').value),
                material: document.getElementById('material').value,
                fan_speed: parseInt(document.getElementById('fan_speed').value),
            };
        }

        function getC3Inputs() {
            return {
                ...getGlobalInputs(),
                Temperature: parseFloat(document.getElementById('c3_Temperature').value),
                Speed: parseFloat(document.getElementById('c3_Speed').value),
                Angle: parseFloat(document.getElementById('c3_Angle').value),
                Height: parseFloat(document.getElementById('c3_Height').value),
                Fill: parseFloat(document.getElementById('c3_Fill').value),
            };
        }

        function getFEAInputs() {
            return {
                ...getGlobalInputs(),
                Material_Bonding_Perfection: parseFloat(document.getElementById('fea_Material_Bonding_Perfection').value),
                Material_Youngs_Modulus_GPa: parseFloat(document.getElementById('fea_Material_Youngs_Modulus_GPa').value),
                Material_Tensile_Yield_Strenght_MPa: parseFloat(document.getElementById('fea_Material_Tensile_Yield_Strenght_MPa').value),
                Material_Poissons_Ratio: parseFloat(document.getElementById('fea_Material_Poissons_Ratio').value),
                User_Infill_Pattern: document.getElementById('fea_User_Infill_Pattern').value,
                User_Infill_Density: parseFloat(document.getElementById('fea_User_Infill_Density').value),
                User_Line_Thickenss_mm: parseFloat(document.getElementById('fea_User_Line_Thickenss_mm').value),
                User_Layer_Height_mm: parseFloat(document.getElementById('fea_User_Layer_Height_mm').value),
            };
        }

        function getFatigueInputs() {
            return {
                ...getGlobalInputs(),
                Nozzle_Diameter: parseFloat(document.getElementById('fatigue_Nozzle_Diameter').value),
                Print_Speed: parseFloat(document.getElementById('fatigue_Print_Speed').value),
                Nozzle_Temperature: parseFloat(document.getElementById('fatigue_Nozzle_Temperature').value),
                Stress_Level: parseFloat(document.getElementById('fatigue_Stress_Level').value),
            };
        }

        function getAccuracyInputs() {
            return {
                ...getGlobalInputs(),
                Layer_Thickness_mm: parseFloat(document.getElementById('accuracy_Layer_Thickness_mm').value),
                Build_Orientation_deg: parseInt(document.getElementById('accuracy_Build_Orientation_deg').value),
                Infill_Density_percent: parseInt(document.getElementById('accuracy_Infill_Density_percent').value),
                Number_of_Contours: parseInt(document.getElementById('accuracy_Number_of_Contours').value),
            };
        }

        function getWarpageInputs() { // v6: New
            return {
                ...getGlobalInputs(),
                Layer_Temperature_C: parseInt(document.getElementById('warpage_Layer_Temperature_C').value),
                Infill_Density_percent: parseInt(document.getElementById('warpage_Infill_Density_percent').value),
                First_Layer_Height_mm: parseFloat(document.getElementById('warpage_First_Layer_Height_mm').value),
                Other_Layer_Height_mm: parseFloat(document.getElementById('warpage_Other_Layer_Height_mm').value),
            };
        }

        // --- UI Updaters ---
        function updateGlobalUI(data) {
            document.getElementById('estimated_cost_usd').textContent = data.estimated_cost_usd.toFixed(2);
            document.getElementById('estimated_print_time_min').textContent = data.estimated_print_time_min.toFixed(1);
        }

        function updateKaggleUI(data) {
            updateGlobalUI(data);
            document.getElementById('tensile_strength').textContent = data.tensile_strength.toFixed(2);
            document.getElementById('roughness').textContent = data.roughness.toFixed(2);
            document.getElementById('elongation').textContent = data.elongation.toFixed(2);
        }

        function updateC3UI(data) {
            updateGlobalUI(data);
            document.getElementById('c3_tensile_strength').textContent = data.Tensile_Strength_MPa.toFixed(2);
            document.getElementById('c3_elongation').textContent = data.Elongation_at_Break_percent.toFixed(2);
        }

        function updateFEAUI(data) {
            updateGlobalUI(data);
            const tableBody = document.getElementById('fea-results-table');
            if (tableBody) {
                tableBody.innerHTML = ''; // Clear old results
                for (const [key, value] of Object.entries(data.properties)) {
                    const row = `
                        <tr class="bg-gray-800 border-b border-gray-700">
                            <td class="py-2 px-4 font-medium">${key.replace(/_/g, ' ')}</td>
                            <td class="py-2 px-4 text-blue-300 font-mono">${parseFloat(value).toFixed(4)}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            }
        }

        function updateFatigueUI(data) {
            updateGlobalUI(data);
            document.getElementById('fatigue_lifetime').textContent = Math.round(data.Fatigue_Lifetime).toLocaleString();
        }

        function updateAccuracyUI(data) {
            updateGlobalUI(data);
            document.getElementById('Var_Length_percent').textContent = data.Var_Length_percent.toFixed(3);
            document.getElementById('Var_Width_percent').textContent = data.Var_Width_percent.toFixed(3);
            document.getElementById('Var_Thickness_percent').textContent = data.Var_Thickness_percent.toFixed(3);
        }

        function updateWarpageUI(data) { // v6: New
            updateGlobalUI(data);
            document.getElementById('Warpage_mm').textContent = data.Warpage_mm.toFixed(3);
        }

        // --- Recommendation Engines ---
        function updateKaggleRecs(inputs) {
            const recQuality = [];
            const recSpeed = [];

            // Quality
            if (inputs.layer_height <= 0.1) recQuality.push("Low layer height is good for quality.");
            else recQuality.push("Consider lowering layer height (< 0.1mm) for better finish and strength.");

            if (inputs.infill_density > 80) recQuality.push("High infill density is great for strength.");
            else recQuality.push("Increase infill density (> 80%) for maximum strength.");

            if (inputs.print_speed < 60) recQuality.push("Low print speed improves layer adhesion.");
            else recQuality.push("Reduce print speed (< 60mm/s) to increase strength.");

            if (inputs.material === 'abs' && inputs.nozzle_temperature < 230) recQuality.push("Increase ABS temp (> 230°C) for better layer bonding.");
            if (inputs.material === 'pla' && inputs.nozzle_temperature < 210) recQuality.push("Increase PLA temp (> 210°C) for better layer bonding.");

            // Speed
            if (inputs.layer_height > 0.2) recSpeed.push("High layer height is great for speed.");
            else recSpeed.push("Increase layer height (> 0.2mm) to reduce print time.");

            if (inputs.infill_density < 30) recSpeed.push("Low infill density saves time and material.");
            else recSpeed.push("Lower infill density (< 30%) for faster, cheaper prints (if strength is not critical).");

            if (inputs.print_speed > 90) recSpeed.push("High print speed is fast.");
            else recSpeed.push("Increase print speed (> 90mm/s) to reduce print time.");

            document.getElementById('kaggle-rec-quality').innerHTML = recQuality.map(rec => `<li>${rec}</li>`).join('');
            document.getElementById('kaggle-rec-speed').innerHTML = recSpeed.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateC3Recs(inputs) {
            const recStrength = [];
            const recElongation = [];

            if (inputs.Temperature > 210) recStrength.push("High nozzle temp (> 210°C) is good for strength.");
            else recStrength.push("Increase nozzle temp (> 210°C) for better layer bonding.");

            if (inputs.Fill > 90) recStrength.push("High infill density (> 90%) maximizes strength.");
            else recStrength.push("Increase infill density for higher strength.");

            if (inputs.Height <= 0.1) recStrength.push("Low layer height (0.1mm) improves strength.");
            else recStrength.push("Decrease layer height to 0.1mm for better strength.");

            if (inputs.Temperature < 200) recElongation.push("Lower temps (< 200°C) can increase ductility.");
            else recElongation.push("Try a moderate temperature (~200-210°C).");

            if (inputs.Angle === 45) recElongation.push("A 45° raster angle provides a good balance of properties.");
            else recElongation.push("Consider a 45° raster angle for balanced ductility.");

            document.getElementById('c3-rec-strength').innerHTML = recStrength.map(rec => `<li>${rec}</li>`).join('');
            document.getElementById('c3-rec-elongation').innerHTML = recElongation.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateFatigueRecs(inputs) {
            const recLife = [];
            const recWarning = [];

            if (inputs.Nozzle_Temperature > 220) recLife.push("High nozzle temp (> 220°C) improves layer bonding, increasing fatigue life.");
            else recLife.push("Increase nozzle temp (> 220°C) for significantly better durability.");

            if (inputs.Print_Speed < 8) recLife.push("Low print speed (< 8 mm/s) allows better layer fusion.");
            else recLife.push("Reduce print speed (< 8 mm/s) to maximize fatigue life.");

            if (inputs.Nozzle_Diameter > 0.4) recLife.push("A larger nozzle diameter (0.6mm) can create stronger bonds.");
            else recLife.push("Consider a larger nozzle (0.6mm) if durability is critical.");

            if (inputs.Stress_Level > 10) recWarning.push("High stress levels drastically reduce part lifetime.");
            else recWarning.push("Lowering the applied stress is the most effective way to increase life.");

            if (inputs.Nozzle_Temperature < 200) recWarning.push("Low nozzle temp (< 200°C) creates weak bonds that fail quickly under fatigue.");
            if (inputs.Print_Speed > 12) recWarning.push("High print speed (> 12 mm/s) can lead to poor layer adhesion.");

            document.getElementById('fatigue-rec-life').innerHTML = recLife.map(rec => `<li>${rec}</li>`).join('');
            document.getElementById('fatigue-rec-warning').innerHTML = recWarning.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateAccuracyRecs(inputs) {
            const recs = [];
            if (inputs.Layer_Thickness_mm < 0.2) recs.push("Low layer height (0.1mm) provides the best accuracy.");
            else recs.push("Reduce layer height (to 0.1mm) for best accuracy.");

            if (inputs.Build_Orientation_deg === 0) recs.push("A 0° orientation (aligned with X-axis) is optimal for accuracy.");
            else recs.push("Set Build Orientation to 0° for lowest dimensional error.");

            if (inputs.Infill_Density_percent > 95) recs.push("High infill (100%) is best for accuracy.");
            else recs.push("Increase infill density to 100% to minimize dimensional errors.");

            document.getElementById('accuracy-rec-life').innerHTML = recs.map(rec => `<li>${rec}</li>`).join('');
        }

        function updateWarpageRecs(inputs) { // v6: New
            const recs = [];
            if (inputs.Layer_Temperature_C < 195) recs.push("Low nozzle temp (< 195°C) is ideal for minimizing warpage.");
            else recs.push("Reduce nozzle temp (to 190-195°C) to reduce thermal stress.");

            if (inputs.Infill_Density_percent < 15) recs.push("Low infill density (< 15%) reduces internal stress and warpage.");
            else recs.push("Reduce infill density (< 15%) to minimize warpage.");

            if (inputs.First_Layer_Height_mm < 0.3) recs.push("A thinner first layer (0.2mm) can help reduce warpage.");
            else recs.push("Consider a thinner first layer (0.2mm) for better adhesion and less lift.");

            document.getElementById('warpage-rec-life').innerHTML = recs.map(rec => `<li>${rec}</li>`).join('');
        }

        // --- State Management ---
        function showSpinner() {
            spinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideSpinner() {
            spinner.classList.add('hidden');
        }

        function showError(message) {
            hideSpinner();
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // --- Main Simulation Functions ---

        // Use a debounce function to prevent spamming the API on every slider move
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Generic simulation runner
        async function runSimulation(modelName, inputs, successCallback, recCallback) {
            showSpinner();
            try {
                const response = await fetch(`${API_BASE_URL}/predict/${modelName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                hideSpinner();
                hideError();
                successCallback(data);
                if (recCallback) recCallback(inputs);

            } catch (error) {
                console.error("Simulation failed:", error);
                showError(`Error: ${error.message}. Is the server running?`);
            }
        }

        // Debounced simulation runners
        const debouncedKaggleSim = debounce(() => runSimulation('kaggle', getKaggleInputs(), updateKaggleUI, updateKaggleRecs), 300);
        const debouncedC3Sim = debounce(() => runSimulation('c3', getC3Inputs(), updateC3UI, updateC3Recs), 300);
        const debouncedFEASim = debounce(() => runSimulation('fea', getFEAInputs(), updateFEAUI, null), 300);
        const debouncedFatigueSim = debounce(() => runSimulation('fatigue', getFatigueInputs(), updateFatigueUI, updateFatigueRecs), 300);
        const debouncedAccuracySim = debounce(() => runSimulation('accuracy', getAccuracyInputs(), updateAccuracyUI, updateAccuracyRecs), 300);
        const debouncedWarpageSim = debounce(() => runSimulation('warpage', getWarpageInputs(), updateWarpageUI, updateWarpageRecs), 300); // v6: New

        // v4: App State for cleaner logic
        const AppState = {
            'kaggle': { runSim: debouncedKaggleSim, getInputs: getKaggleInputs, setInputs: setKaggleInputs, optConfig: getKaggleOptConfig },
            'c3': { runSim: debouncedC3Sim, getInputs: getC3Inputs, setInputs: setC3Inputs, optConfig: null /* Not supported yet */ },
            'fea': { runSim: debouncedFEASim, getInputs: getFEAInputs, setInputs: null, optConfig: null },
            'fatigue': { runSim: debouncedFatigueSim, getInputs: getFatigueInputs, setInputs: null, optConfig: null },
            'accuracy': { runSim: debouncedAccuracySim, getInputs: getAccuracyInputs, setInputs: null, optConfig: getAccuracyOptConfig },
            'warpage': { runSim: debouncedWarpageSim, getInputs: getWarpageInputs, setInputs: null, optConfig: getWarpageOptConfig }, // v6: New
        };

        // --- Model Switching Logic ---
        const modelSelector = document.getElementById('modelSelector');
        const paramContainers = document.querySelectorAll('.model-params');
        const outputContainers = document.querySelectorAll('.model-outputs');
        const recContainers = document.querySelectorAll('.model-recs');
        const gcodeParserContainer = document.getElementById('gcode-parser-container');

        function switchModel(selectedModel) {
            // Hide all containers
            [...paramContainers, ...outputContainers, ...recContainers].forEach(el => el.classList.add('hidden'));

            // Hide GCode parser by default
            gcodeParserContainer.classList.add('hidden');
            hideError();

            // Show containers for the selected model
            document.getElementById(`${selectedModel}-params`).classList.remove('hidden');
            document.getElementById(`${selectedModel}-outputs`).classList.remove('hidden');
            document.getElementById(`${selectedModel}-recs`).classList.remove('hidden');

            // Show GCode parser for Kaggle AND C3
            if (selectedModel === 'kaggle' || selectedModel === 'c3') {
                gcodeParserContainer.classList.remove('hidden');
            }

            // Run the simulation for the selected model
            if (AppState[selectedModel] && AppState[selectedModel].runSim) {
                AppState[selectedModel].runSim();
            }

            // Special case: Init 3D viewer for FEA
            if (selectedModel === 'fea' && !scene) {
                init3DViewer();
            }
        }

        modelSelector.addEventListener('change', (e) => switchModel(e.target.value));

        // --- G-Code Parsing ---
        document.getElementById('parseGcodeBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('gcodeFile');
            if (fileInput.files.length === 0) {
                alert("Please select a .gcode file first.");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                const gcode = e.target.result;
                const selectedModel = modelSelector.value;

                if (!AppState[selectedModel] || !AppState[selectedModel].setInputs) {
                    alert(`G-Code parsing is not supported for the ${selectedModel} model.`);
                    return;
                }

                try {
                    const params = parseUnifiedOrcaSlicerGcode(gcode);
                    console.log("Parsed all G-Code params:", params);

                    AppState[selectedModel].setInputs(params);
                    AppState[selectedModel].runSim();
                } catch (error) {
                    console.error("G-Code parsing error:", error);
                    alert(`Failed to parse G-Code: ${error.message}`);
                }
            };

            reader.readAsText(file);
        });

        // Refactored: Unified G-Code Parser
        function parseUnifiedOrcaSlicerGcode(gcode) {
            const params = {};
            const lines = gcode.split('\n');

            const patterns = {
                // Kaggle Params
                layer_height: /; layer_height = ([\d.]+)/,
                wall_thickness: /; wall_loops = (\d+)/,
                infill_density: /; sparse_infill_density = ([\d.]+)%/,
                infill_pattern: /; sparse_infill_pattern = (\w+)/,
                nozzle_temperature: /; nozzle_temperature = (\d+)/,
                bed_temperature: /; bed_temperature = (\d+)/,
                print_speed: /; outer_wall_speed = ([\d.]+)/,
                material: /; filament_type = (\w+)/,
                fan_speed: /; fan_speed = (\d+)/,
                // C3 Params
                Angle: /; sparse_infill_angle = (\d+)/,
            };

            for (const line of lines) {
                if (!line.startsWith(';')) continue;
                for (const [key, regex] of Object.entries(patterns)) {
                    const match = line.match(regex);
                    if (match && !params[key]) params[key] = match[1];
                }
            }

            // Map material type
            if (params.material) {
                if (params.material.toLowerCase().includes('pla')) params.material = 'pla';
                else if (params.material.toLowerCase().includes('abs')) params.material = 'abs';
            }

            if (Object.keys(params).length < 3) { // Just a basic check
                console.warn("Could not find many parameters. Is this an OrcaSlicer G-Code file?");
            }
            return params;
        }

        // Helper to set slider and text value
        const setSlider = (id, value) => {
            const slider = document.getElementById(id);
            if (slider) {
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                // Clamp value to slider's min/max range
                const clampedValue = Math.max(min, Math.min(max, parseFloat(value)));
                if (isNaN(clampedValue)) return; // Skip if value is not a number

                slider.value = clampedValue;
                const valEl = document.getElementById(`${id}_val`);
                if (valEl) valEl.textContent = clampedValue;
            } else {
                console.warn(`Slider with id ${id} not found.`);
            }
        };

        // Helper to set select value
        const setSelect = (id, value) => {
            const select = document.getElementById(id);
            if (select) {
                const option = Array.from(select.options).find(opt => value.toLowerCase().includes(opt.value.toLowerCase()));
                if (option) select.value = option.value;
                else console.warn(`Could not find matching option for ${id}: ${value}`);
            }
        };

        // Updated Input Setters (pull from unified params)
        function setKaggleInputs(params) {
            if (params.layer_height) setSlider('layer_height', params.layer_height);
            if (params.wall_thickness) setSlider('wall_thickness', params.wall_thickness);
            if (params.infill_density) setSlider('infill_density', params.infill_density);
            if (params.nozzle_temperature) setSlider('nozzle_temperature', params.nozzle_temperature);
            if (params.bed_temperature) setSlider('bed_temperature', params.bed_temperature);
            if (params.print_speed) setSlider('print_speed', params.print_speed);
            if (params.fan_speed) setSlider('fan_speed', params.fan_speed);
            if (params.infill_pattern) setSelect('infill_pattern', params.infill_pattern);

            if (params.material) {
                // Set hidden material field
                document.getElementById('material').value = params.material;
                // Set the visible dropdown
                const dbSelect = document.getElementById('kaggle_material_database');
                const option = Array.from(dbSelect.options).find(opt => params.material.toLowerCase().includes(opt.value.toLowerCase()));
                if (option) dbSelect.value = option.value;
                else dbSelect.value = ""; // Not a known material
            }
        }

        function setC3Inputs(params) {
            // C3 params are named differently in G-code, so we map them
            if (params.nozzle_temperature) setSlider('c3_Temperature', params.nozzle_temperature);
            if (params.print_speed) setSlider('c3_Speed', params.print_speed);
            if (params.Angle) setSlider('c3_Angle', params.Angle);
            if (params.layer_height) setSlider('c3_Height', params.layer_height);
            if (params.infill_density) setSlider('c3_Fill', params.infill_density);
        }

        // --- Material Database Logic ---
        async function loadMaterials() {
            try {
                const response = await fetch(`${API_BASE_URL}/materials`);
                if (!response.ok) throw new Error('Failed to fetch materials');
                materialsDatabase = await response.json();

                // Get all three select dropdowns
                const kaggleSelect = document.getElementById('kaggle_material_database');
                const feaSelect = document.getElementById('fea_material_database');
                const fatigueSelect = document.getElementById('fatigue_material_database');

                // Populate all dropdowns
                for (const materialName of Object.keys(materialsDatabase)) {
                    const option = new Option(materialName, materialName);
                    // Check which models this material applies to
                    const materialData = materialsDatabase[materialName];
                    if (materialData.common && (materialName.toLowerCase().includes('pla') || materialName.toLowerCase().includes('abs'))) {
                        kaggleSelect.add(option.cloneNode(true));
                    }
                    if (materialData.fea) {
                        feaSelect.add(option.cloneNode(true));
                    }
                    if (materialData.fatigue) {
                        fatigueSelect.add(option.cloneNode(true));
                    }
                }
            } catch (error) {
                console.error("Failed to load materials database:", error);
                // Don't show a blocking error, just log it
            }
        }

        // Add listeners for the new material dropdowns
        document.getElementById('kaggle_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName]) return;

            const data = materialsDatabase[materialName].common;
            const materialType = materialName.toLowerCase().includes('pla') ? 'pla' : 'abs';

            // Set hidden material field
            document.getElementById('material').value = materialType;

            // Set sliders
            if (data.bed_temperature) setSlider('bed_temperature', data.bed_temperature);
            if (data.nozzle_temperature) setSlider('nozzle_temperature', data.nozzle_temperature);
            if (data.print_speed) setSlider('print_speed', data.print_speed);
            if (data.fan_speed) setSlider('fan_speed', data.fan_speed);

            debouncedKaggleSim(); // Re-run simulation
        });

        document.getElementById('fea_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName] || !materialsDatabase[materialName].fea) return;

            const data = materialsDatabase[materialName].fea;
            if (data.Material_Youngs_Modulus_GPa) setSlider('fea_Material_Youngs_Modulus_GPa', data.Material_Youngs_Modulus_GPa);
            if (data.Material_Tensile_Yield_Strenght_MPa) setSlider('fea_Material_Tensile_Yield_Strenght_MPa', data.Material_Tensile_Yield_Strenght_MPa);
            if (data.Material_Poissons_Ratio) setSlider('fea_Material_Poissons_Ratio', data.Material_Poissons_Ratio);

            debouncedFEASim(); // Re-run simulation
        });

        document.getElementById('fatigue_material_database').addEventListener('change', (e) => {
            const materialName = e.target.value;
            if (!materialName || !materialsDatabase[materialName] || !materialsDatabase[materialName].fatigue) return;

            const data = materialsDatabase[materialName].fatigue;
            if (data.Nozzle_Temperature) setSlider('fatigue_Nozzle_Temperature', data.Nozzle_Temperature);
            if (data.Print_Speed) setSlider('fatigue_Print_Speed', data.Print_Speed);
            if (data.Nozzle_Diameter) setSlider('fatigue_Nozzle_Diameter', data.Nozzle_Diameter);

            debouncedFatigueSim(); // Re-run simulation
        });

        // --- Event Listeners ---

        // Add listeners for all sliders and selects
        const allInputs = document.querySelectorAll('input[type="range"], select');
        allInputs.forEach(input => {
            // Check if it's one of the new database selects or optimizer, if so, skip it
            if (input.id.includes('_material_database') || input.id.startsWith('optimizer')) return;

            input.addEventListener('input', () => {
                // Update text for sliders
                if (input.type === 'range') {
                    const valEl = document.getElementById(`${input.id}_val`);
                    if (valEl) valEl.textContent = input.value;
                }

                // Special case for Kaggle material: set hidden input
                if (input.id === 'material') {
                    document.getElementById('material').value = input.value;
                }

                // Trigger the correct simulation
                const selectedModel = modelSelector.value;
                if (AppState[selectedModel] && AppState[selectedModel].runSim) {
                    AppState[selectedModel].runSim();
                }
            });
        });

        // STL file loader
        document.getElementById('stlFile').addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                loadSTL(event.target.files[0]);
            }
        });

        // --- v4: Optimizer Logic ---
        const optimizerModelSelector = document.getElementById('optimizerModelSelector');
        const objectivesContainer = document.getElementById('optimizer-objectives-container');
        const runOptimizerBtn = document.getElementById('runOptimizer');
        const optimizerSpinner = document.getElementById('optimizer-spinner');
        const optimizerError = document.getElementById('optimizer-error-message');
        const optimizerErrorText = document.getElementById('optimizer-error-text');
        const optimizerResultsContainer = document.getElementById('optimizer-results-container');
        const optimizerResultsHead = document.getElementById('optimizer-results-head');
        const optimizerResultsBody = document.getElementById('optimizer-results-body');

        // Config for Optimizer Objectives
        function getKaggleOptConfig() {
            return [
                { name: "tensile_strength", label: "Tensile Strength (MPa)", goal: "maximize" },
                { name: "roughness", label: "Roughness (µm)", goal: "minimize" },
                { name: "elongation", label: "Elongation (%)", goal: "maximize" },
                { name: "estimated_print_time_min", label: "Print Time (min)", goal: "minimize" },
                { name: "estimated_cost_usd", label: "Material Cost (USD)", goal: "minimize" }
            ];
        }
        function getAccuracyOptConfig() {
            return [
                { name: "Var_Length_percent", label: "Length Error (%)", goal: "minimize" },
                { name: "Var_Width_percent", label: "Width Error (%)", goal: "minimize" },
                { name: "Var_Thickness_percent", label: "Thickness Error (%)", goal: "minimize" },
                { name: "estimated_print_time_min", label: "Print Time (min)", goal: "minimize" },
                { name: "estimated_cost_usd", label: "Material Cost (USD)", goal: "minimize" }
            ];
        }
        function getWarpageOptConfig() { // v6: New
            return [
                { name: "Warpage_mm", label: "Warpage (mm)", goal: "minimize" },
                { name: "estimated_print_time_min", label: "Print Time (min)", goal: "minimize" },
                { name: "estimated_cost_usd", label: "Material Cost (USD)", goal: "minimize" }
            ];
        }

        const optimizerConfigs = {
            'kaggle': getKaggleOptConfig,
            'accuracy': getAccuracyOptConfig,
            'warpage': getWarpageOptConfig // v6: New
        };

        function updateOptimizerUI() {
            const modelName = optimizerModelSelector.value;
            const configFn = optimizerConfigs[modelName];
            if (!configFn) {
                objectivesContainer.innerHTML = '<label class="block text-sm font-medium text-gray-300">2. Define Objectives</label><p class="text-sm text-red-400">Optimization is not supported for this model yet.</p>';
                return;
            }

            const objectives = configFn();
            let html = '<label class="block text-sm font-medium text-gray-300 mb-2">2. Define Objectives (Max 3)</label>';

            objectives.forEach(obj => {
                html += `
                    <div class="flex items-center">
                        <input id="opt-obj-${obj.name}" type="checkbox" data-name="${obj.name}" data-goal="${obj.goal}" class="opt-objective-cb h-4 w-4 bg-gray-700 border-gray-600 text-blue-600 rounded focus:ring-blue-500">
                        <label for="opt-obj-${obj.name}" class="ml-2 block text-sm text-gray-300">
                            ${obj.goal === 'maximize' ? 'Maximize' : 'Minimize'}: ${obj.label}
                        </label>
                    </div>
                `;
            });

            objectivesContainer.innerHTML = html;
        }

        optimizerModelSelector.addEventListener('change', updateOptimizerUI);

        runOptimizerBtn.addEventListener('click', async () => {
            const modelName = optimizerModelSelector.value;

            // 1. Get Global Inputs
            const globalInputs = getGlobalInputs();
            if (!globalInputs.part_mass_g || !globalInputs.filament_cost_kg) {
                alert("Please set a valid 'Filament Used (g)' and 'Filament Cost ($/kg)' in the Global Settings card first.");
                return;
            }

            // 2. Get Selected Objectives
            const objectiveCheckboxes = document.querySelectorAll('.opt-objective-cb:checked');
            if (objectiveCheckboxes.length === 0 || objectiveCheckboxes.length > 3) {
                alert("Please select 1 to 3 objectives to optimize.");
                return;
            }

            const objectives = Array.from(objectiveCheckboxes).map(cb => ({
                name: cb.dataset.name,
                goal: cb.dataset.goal
            }));

            // 3. (Optional) Get Constraints - Not implemented in this version, but payload supports it
            const constraints = [];

            // 4. Build Request Payload
            const payload = {
                model_name: modelName,
                objectives: objectives,
                constraints: constraints,
                global_inputs: globalInputs
            };

            // 5. Show Spinner and run
            optimizerSpinner.classList.remove('hidden');
            optimizerError.classList.add('hidden');
            optimizerResultsContainer.classList.add('hidden');
            runOptimizerBtn.disabled = true;
            runOptimizerBtn.textContent = "Optimizing...";

            try {
                const response = await fetch(`${API_BASE_URL}/optimize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || `HTTP error! status: ${response.status}`);
                }

                const results = await response.json();
                displayOptimizerResults(results);

            } catch (error) {
                console.error("Optimization failed:", error);
                optimizerErrorText.textContent = `Error: ${error.message}. Is the server running?`;
                optimizerError.classList.remove('hidden');
            } finally {
                optimizerSpinner.classList.add('hidden');
                runOptimizerBtn.disabled = false;
                runOptimizerBtn.textContent = "Run Optimization";
            }
        });

        function displayOptimizerResults(results) {
            if (results.length === 0) {
                optimizerErrorText.textContent = "Optimization ran but returned no valid results. Try different objectives.";
                optimizerError.classList.remove('hidden');
                optimizerResultsContainer.classList.add('hidden');
                return;
            }

            // --- Build Table Header ---
            const headers = results[0].inputs;
            const outputs = results[0].outputs;

            let headHtml = '<tr>';
            // Input Headers
            for (const key of Object.keys(headers)) {
                headHtml += `<th class="text-left text-xs uppercase text-gray-400">${key.replace(/_/g, ' ')}</th>`;
            }
            // Output Headers
            for (const key of Object.keys(outputs)) {
                headHtml += `<th class="text-left text-xs uppercase text-blue-300">${key.replace(/_/g, ' ')}</th>`;
            }
            headHtml += '</tr>';
            optimizerResultsHead.innerHTML = headHtml;

            // --- Build Table Body ---
            let bodyHtml = '';
            for (const res of results) {
                bodyHtml += '<tr>';
                // Input Values
                for (const val of Object.values(res.inputs)) {
                    bodyHtml += `<td class="font-mono text-sm text-gray-300">${val}</td>`;
                }
                // Output Values
                for (const val of Object.values(res.outputs)) {
                    bodyHtml += `<td class="font-mono text-sm font-bold text-blue-300">${val}</td>`;
                }
                bodyHtml += '</tr>';
            }
            optimizerResultsBody.innerHTML = bodyHtml;
            optimizerResultsContainer.classList.remove('hidden');
        }

        // --- Tab Switching Logic ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Deactivate all
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Activate clicked
                button.classList.add('active');
                document.getElementById(`tab-${button.dataset.tab}`).classList.add('active');
            });
        });

        // --- Initial Run ---
        loadMaterials(); // Load the materials DB first
        switchModel(modelSelector.value); // Then run the default simulation
        updateOptimizerUI(); // Init optimizer UI

    </script>
</body>

</html>